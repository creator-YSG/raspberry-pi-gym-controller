"""
ì›ê°€ëŒ€ì‹œë³´ë“œ ê°œì„  - ì œí’ˆë§ˆìŠ¤í„° ê¸°ì¤€ìœ¼ë¡œ ìë™ ì—°ë™
QUERY/FILTER í•¨ìˆ˜ë¡œ ì œí’ˆ ì¶”ê°€ ì‹œ ìë™ ë°˜ì˜ë˜ê²Œ
"""

import gspread
from google.oauth2.credentials import Credentials
import pickle
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent
INSTANCE_DIR = BASE_DIR / "instance"
TOKEN_FILE = INSTANCE_DIR / "sheets_token.pickle"
SPREADSHEET_ID = "1v9lkVVs8CGFUEJltFX2WGiFfjd253R_yginO24Ssf3U"

def authenticate():
    with open(TOKEN_FILE, 'rb') as token:
        creds = pickle.load(token)
    return gspread.authorize(creds)

def improve_dashboard():
    client = authenticate()
    spreadsheet = client.open_by_key(SPREADSHEET_ID)
    
    print("ğŸ”§ ì›ê°€ëŒ€ì‹œë³´ë“œ ìë™í™” ê°œì„  ì¤‘...\n")
    
    # 1. ì œí’ˆë§ˆìŠ¤í„° ìˆ˜ì‹ ê°œì„  (BOMì—ì„œ ìë™ ì§‘ê³„)
    print("1ï¸âƒ£ ì œí’ˆë§ˆìŠ¤í„° ìˆ˜ì‹ ê°œì„ ...")
    product_master = spreadsheet.worksheet("ì œí’ˆë§ˆìŠ¤í„°")
    product_master.clear()
    
    product_master_content = [
        ["ğŸ“‹ ì œí’ˆ ë§ˆìŠ¤í„° - ëª¨ë“  ì œí’ˆì˜ ê¸°ì¤€ ë°ì´í„°"],
        [""],
        ["ğŸ’¡ ì´ ì‹œíŠ¸ê°€ ê¸°ì¤€ì…ë‹ˆë‹¤. ì—¬ê¸°ì— ì œí’ˆì„ ì¶”ê°€í•˜ë©´ ë‹¤ë¥¸ ì‹œíŠ¸ì—ì„œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤."],
        [""],
        ["ì œí’ˆID", "ì œí’ˆëª…", "ì¹´í…Œê³ ë¦¬", "ë²„ì „", "ìƒíƒœ", "ì›ê°€/ì›”ë¹„ìš©", "ë¹„ê³ "],
        ["HW-001", "ë¼ì¦ˆë² ë¦¬íŒŒì´ í‚¤ì˜¤ìŠ¤í¬", "í•˜ë“œì›¨ì–´", "v1.0", "ì–‘ì‚°ì¤‘", "=SUMIF(í•˜ë“œì›¨ì–´BOM!$A:$A,$A6,í•˜ë“œì›¨ì–´BOM!$I:$I)", "í—¬ìŠ¤ì¥ ë½ì¹´ ì‹œìŠ¤í…œ"],
        ["HW-002", "ESP32 ì„¼ì„œ ëª¨ë“ˆ", "í•˜ë“œì›¨ì–´", "v1.0", "ê°œë°œì¤‘", "=SUMIF(í•˜ë“œì›¨ì–´BOM!$A:$A,$A7,í•˜ë“œì›¨ì–´BOM!$I:$I)", "NFC+ì„¼ì„œ"],
        ["SW-001", "í—¬ìŠ¤ì¥ ê´€ë¦¬ ì‹œìŠ¤í…œ", "ì†Œí”„íŠ¸ì›¨ì–´", "v1.0", "ìš´ì˜ì¤‘", "=SUMIF(ì†Œí”„íŠ¸ì›¨ì–´BOM!$A:$A,$A8,ì†Œí”„íŠ¸ì›¨ì–´BOM!$F:$F)", "Flask ê¸°ë°˜"],
        ["", "", "", "", "", "", ""],
        ["", "", "", "", "", "", ""],
        ["", "", "", "", "", "", ""],
        ["", "", "", "", "", "", ""],
        ["", "", "", "", "", "", ""],
        ["ğŸ’¡ ì‚¬ìš©ë²•:", "", "", "", "", "", ""],
        ["â€¢ ìƒˆ ì œí’ˆ: ìœ„ì˜ ë¹ˆ í–‰ì— ì¶”ê°€ (ì œí’ˆIDëŠ” HW-XXX ë˜ëŠ” SW-XXX)", "", "", "", "", "", ""],
        ["â€¢ ì›ê°€/ì›”ë¹„ìš©ì€ BOM ì‹œíŠ¸ì—ì„œ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤", "", "", "", "", "", ""],
        ["â€¢ ìƒíƒœ: ê¸°íšì¤‘/ê°œë°œì¤‘/ì–‘ì‚°ì¤‘/ìš´ì˜ì¤‘/ë‹¨ì¢…", "", "", "", "", "", ""],
    ]
    
    product_master.update(product_master_content, 'A1', value_input_option='USER_ENTERED')
    
    # ì„œì‹
    product_master.format('A1', {
        'backgroundColor': {'red': 0.2, 'green': 0.6, 'blue': 0.2},
        'textFormat': {'bold': True, 'fontSize': 14, 'foregroundColor': {'red': 1, 'green': 1, 'blue': 1}}
    })
    product_master.format('A5:G5', {
        'backgroundColor': {'red': 0.8, 'green': 0.9, 'blue': 0.8},
        'textFormat': {'bold': True}
    })
    product_master.format('F6:F20', {'numberFormat': {'type': 'NUMBER', 'pattern': '#,##0'}})
    
    # ë“œë¡­ë‹¤ìš´
    requests = [{
        "setDataValidation": {
            "range": {"sheetId": product_master.id, "startRowIndex": 5, "endRowIndex": 50, "startColumnIndex": 2, "endColumnIndex": 3},
            "rule": {
                "condition": {"type": "ONE_OF_LIST", "values": [
                    {"userEnteredValue": "í•˜ë“œì›¨ì–´"}, {"userEnteredValue": "ì†Œí”„íŠ¸ì›¨ì–´"}
                ]},
                "showCustomUi": True
            }
        }
    }, {
        "setDataValidation": {
            "range": {"sheetId": product_master.id, "startRowIndex": 5, "endRowIndex": 50, "startColumnIndex": 4, "endColumnIndex": 5},
            "rule": {
                "condition": {"type": "ONE_OF_LIST", "values": [
                    {"userEnteredValue": "ê¸°íšì¤‘"}, {"userEnteredValue": "ê°œë°œì¤‘"},
                    {"userEnteredValue": "ì–‘ì‚°ì¤‘"}, {"userEnteredValue": "ìš´ì˜ì¤‘"}, {"userEnteredValue": "ë‹¨ì¢…"}
                ]},
                "showCustomUi": True
            }
        }
    }]
    spreadsheet.batch_update({"requests": requests})
    
    print("   âœ… ì œí’ˆë§ˆìŠ¤í„° ì™„ë£Œ")
    
    # 2. ì›ê°€ëŒ€ì‹œë³´ë“œë¥¼ QUERY í•¨ìˆ˜ë¡œ ì™„ì „ ìë™í™”
    print("\n2ï¸âƒ£ ì›ê°€ëŒ€ì‹œë³´ë“œ ì™„ì „ ìë™í™”...")
    cost_dashboard = spreadsheet.worksheet("ì›ê°€ëŒ€ì‹œë³´ë“œ")
    cost_dashboard.clear()
    
    # QUERY í•¨ìˆ˜ë¡œ ì œí’ˆë§ˆìŠ¤í„°ì—ì„œ ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
    dashboard_content = [
        ["ğŸ“ˆ ì œí’ˆ ì›ê°€ ëŒ€ì‹œë³´ë“œ (ìë™ ì—°ë™)"],
        [""],
        ["ì´ ëŒ€ì‹œë³´ë“œëŠ” ì œí’ˆë§ˆìŠ¤í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìë™ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤."],
        ["ì œí’ˆë§ˆìŠ¤í„°ì— ì œí’ˆì„ ì¶”ê°€/ì‚­ì œí•˜ë©´ ì—¬ê¸°ë„ ìë™ ë°˜ì˜!"],
        [""],
        ["â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"],
        ["ğŸ“¦ í•˜ë“œì›¨ì–´ ì œí’ˆ ëª©ë¡ (ì œí’ˆë§ˆìŠ¤í„°ì—ì„œ ìë™ ë¡œë“œ)"],
        ["â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"],
        ['=QUERY(ì œí’ˆë§ˆìŠ¤í„°!A6:G50, "SELECT A, B, E, F WHERE C=\'í•˜ë“œì›¨ì–´\' AND A<>\'\'", 0)'],
        ["", "", "", ""],
        ["", "", "", ""],
        ["", "", "", ""],
        ["", "", "", ""],
        ["", "", "", ""],
        ["í•˜ë“œì›¨ì–´ ì´ ì›ê°€:", '=SUMIF(ì œí’ˆë§ˆìŠ¤í„°!C:C,"í•˜ë“œì›¨ì–´",ì œí’ˆë§ˆìŠ¤í„°!F:F)', "", ""],
        [""],
        ["â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"],
        ["ğŸ’» ì†Œí”„íŠ¸ì›¨ì–´ ì œí’ˆ ëª©ë¡ (ì œí’ˆë§ˆìŠ¤í„°ì—ì„œ ìë™ ë¡œë“œ)"],
        ["â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"],
        ['=QUERY(ì œí’ˆë§ˆìŠ¤í„°!A6:G50, "SELECT A, B, E, F WHERE C=\'ì†Œí”„íŠ¸ì›¨ì–´\' AND A<>\'\'", 0)'],
        ["", "", "", ""],
        ["", "", "", ""],
        ["", "", "", ""],
        ["", "", "", ""],
        ["ì†Œí”„íŠ¸ì›¨ì–´ ì´ ì›”ë¹„ìš©:", '=SUMIF(ì œí’ˆë§ˆìŠ¤í„°!C:C,"ì†Œí”„íŠ¸ì›¨ì–´",ì œí’ˆë§ˆìŠ¤í„°!F:F)', "", ""],
        [""],
        ["â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"],
        ["ğŸ“Š ì¬ê³  ìš”ì•½"],
        ["â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"],
        [""],
        ["ì´ ë¶€í’ˆ ì¢…ë¥˜:", '=COUNTA(ì¬ê³ í˜„í™©!A4:A100)-COUNTBLANK(ì¬ê³ í˜„í™©!A4:A100)', "", ""],
        ["ì´ ì¬ê³  ê¸ˆì•¡:", '=SUM(ì¬ê³ í˜„í™©!I4:I100)', "", ""],
        ["âš ï¸ ë¶€ì¡± ë¶€í’ˆ:", '=COUNTIF(ì¬ê³ í˜„í™©!G4:G100,"*ë¶€ì¡±*")', "ê°œ", "â† 0ì´ ì•„ë‹ˆë©´ ë°œì£¼ í•„ìš”!"],
        [""],
        ["â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"],
        ["ğŸ’¡ ìë™í™” ì„¤ëª…"],
        ["â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"],
        [""],
        ["âœ… ì œí’ˆë§ˆìŠ¤í„°ì— ìƒˆ ì œí’ˆ ì¶”ê°€í•˜ë©´ â†’ ì´ ëŒ€ì‹œë³´ë“œì— ìë™ í‘œì‹œ"],
        ["âœ… ì œí’ˆë§ˆìŠ¤í„°ì—ì„œ ì œí’ˆ ì‚­ì œí•˜ë©´ â†’ ì´ ëŒ€ì‹œë³´ë“œì—ì„œ ìë™ ì œê±°"],
        ["âœ… BOMì— ë¶€í’ˆ ì¶”ê°€í•˜ë©´ â†’ ì›ê°€ ìë™ ì—…ë°ì´íŠ¸"],
        ["âœ… ì¬ê³  ìˆ˜ëŸ‰ ë³€ê²½í•˜ë©´ â†’ ì¬ê³  ìš”ì•½ ìë™ ì—…ë°ì´íŠ¸"],
        [""],
        ["ğŸ’¡ ë‹¹ì‹ ì´ í•  ì¼:"],
        ["   1. ì œí’ˆë§ˆìŠ¤í„°ì— ì œí’ˆ ì •ë³´ ê´€ë¦¬"],
        ["   2. BOM ì‹œíŠ¸ì— ë¶€í’ˆ/ì„œë¹„ìŠ¤ ìƒì„¸ ê´€ë¦¬"],
        ["   3. ì¬ê³ í˜„í™©ì—ì„œ ìˆ˜ëŸ‰ë§Œ ì—…ë°ì´íŠ¸"],
        ["   4. ì´ ëŒ€ì‹œë³´ë“œì—ì„œ ì „ì²´ í˜„í™© í™•ì¸!"],
    ]
    
    cost_dashboard.update(dashboard_content, 'A1', value_input_option='USER_ENTERED')
    
    # ì„œì‹
    cost_dashboard.format('A1', {
        'backgroundColor': {'red': 0.1, 'green': 0.1, 'blue': 0.1},
        'textFormat': {'bold': True, 'fontSize': 16, 'foregroundColor': {'red': 1, 'green': 1, 'blue': 1}}
    })
    cost_dashboard.format('B15', {'numberFormat': {'type': 'NUMBER', 'pattern': '#,##0'}, 'textFormat': {'bold': True}})
    cost_dashboard.format('B25', {'numberFormat': {'type': 'NUMBER', 'pattern': '#,##0'}, 'textFormat': {'bold': True}})
    cost_dashboard.format('B32', {'numberFormat': {'type': 'NUMBER', 'pattern': '#,##0'}})
    
    print("   âœ… ì›ê°€ëŒ€ì‹œë³´ë“œ ì™„ì „ ìë™í™” ì™„ë£Œ")
    
    print("\n" + "="*70)
    print("ğŸ‰ ìë™í™” ê°œì„  ì™„ë£Œ!")
    print("="*70)
    print("\nâœ… ì´ì œ ì´ë ‡ê²Œ ì‘ë™í•©ë‹ˆë‹¤:")
    print("")
    print("   ì œí’ˆë§ˆìŠ¤í„°ì— ì œí’ˆ ì¶”ê°€")
    print("        â†“")
    print("   ì›ê°€ëŒ€ì‹œë³´ë“œì— ìë™ í‘œì‹œ (QUERY í•¨ìˆ˜)")
    print("        â†“")
    print("   BOMì— ë¶€í’ˆ ì¶”ê°€í•˜ë©´ ì›ê°€ë„ ìë™ ê³„ì‚°")
    print("")
    print("ğŸ’¡ ë‹¹ì‹ ì´ ì§ì ‘ ìˆ˜ì •í•´ì•¼ í•˜ëŠ” ê³³:")
    print("   â€¢ ì œí’ˆë§ˆìŠ¤í„°: ì œí’ˆ ì¶”ê°€/ì‚­ì œ/ìƒíƒœ ë³€ê²½")
    print("   â€¢ í•˜ë“œì›¨ì–´BOM: ë¶€í’ˆ ìƒì„¸ ì…ë ¥")
    print("   â€¢ ì†Œí”„íŠ¸ì›¨ì–´BOM: ì„œë¹„ìŠ¤ ìƒì„¸ ì…ë ¥")
    print("   â€¢ ì¬ê³ í˜„í™©: ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸")
    print("")
    print("ğŸ’¡ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ëŠ” ê³³:")
    print("   â€¢ ì œí’ˆë§ˆìŠ¤í„°ì˜ ì›ê°€/ì›”ë¹„ìš© ì—´")
    print("   â€¢ ì›ê°€ëŒ€ì‹œë³´ë“œ ì „ì²´")
    print("")
    print("ğŸ“ ì‹œíŠ¸ URL:")
    print(f"   https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}\n")

if __name__ == "__main__":
    try:
        improve_dashboard()
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {e}")
        import traceback
        traceback.print_exc()

