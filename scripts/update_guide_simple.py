"""
사용가이드만 간단히 업데이트
"""

import gspread
from google.oauth2.credentials import Credentials
import pickle
from pathlib import Path

BASE_DIR = Path(__file__).resolve().parent.parent
INSTANCE_DIR = BASE_DIR / "instance"
TOKEN_FILE = INSTANCE_DIR / "sheets_token.pickle"
SPREADSHEET_ID = "1v9lkVVs8CGFUEJltFX2WGiFfjd253R_yginO24Ssf3U"

def authenticate():
    with open(TOKEN_FILE, 'rb') as token:
        creds = pickle.load(token)
    return gspread.authorize(creds)

def update_guide():
    client = authenticate()
    spreadsheet = client.open_by_key(SPREADSHEET_ID)
    guide_sheet = spreadsheet.worksheet("사용가이드")
    
    # 금액 입력 방법 전체 다시 작성
    new_guide = [
        ["📘 스타트업 실전형 현금흐름 장부 - 사용 가이드"],
        [""],
        ["═══════════════════════════════════════════════════════"],
        ["1️⃣ 기본 사용법"],
        ["═══════════════════════════════════════════════════════"],
        [""],
        ["▶ 금액 입력 방법 (간단!)"],
        ["  "],
        ["  ✅ F열(공급가액)만 입력하면 됩니다"],
        ["     → G열(부가세), H열(합계)가 자동 계산"],
        ["     예: 500,000 입력 → 부가세 50,000, 합계 550,000 자동"],
        ["  "],
        ["  ✅ 면세 물품일 때"],
        ["     → F열에 전체 금액 입력 후, G열을 0으로 덮어쓰기"],
        ["  "],
        ["  ✅ 합계만 알 때 (예: 배달음식 33,000원)"],
        ["     → 계산기로 33,000 ÷ 1.1 = 30,000"],
        ["     → F열에 30,000 입력"],
        ["  "],
        ["▶ 드롭다운 선택 (오타 방지)"],
        ["  • B열(구분): 지출/수입/자금투입"],
        ["  • C열(대분류): 제품/제조, 마케팅/영업 등"],
        ["  • I열(결제수단): 개인카드, 현금, 법인카드 등"],
        ["  • J열(증빙): 세금계산서, 카드영수증 등"],
        [""],
        ["═══════════════════════════════════════════════════════"],
        ["2️⃣ 운영 방법"],
        ["═══════════════════════════════════════════════════════"],
        [""],
        ["✅ 이 시트 하나에 2025년 전체 데이터 누적"],
        ["✅ 물품 구매도 모두 여기 기록 (대분류만 구분)"],
        ["✅ 증빙은 구글 드라이브에 월별 폴더로 보관"],
        ["✅ 매주 대시보드 확인 (돈이 어디로 새는지)"],
        [""],
        ["═══════════════════════════════════════════════════════"],
        ["3️⃣ 각 항목 설명"],
        ["═══════════════════════════════════════════════════════"],
        [""],
        ["항목", "설명", "예시"],
        ["날짜", "거래 발생 날짜", "2025-12-21"],
        ["구분", "지출/수입/자금투입", "지출"],
        ["대분류", "• 제품/제조: 원재료, 시제품", "제품/제조"],
        ["", "• 마케팅/영업: 광고, 미팅", ""],
        ["", "• 운영비: 임차료, 구독료", ""],
        ["", "• 인건비/복리후생: 급여, 식대", ""],
        ["", "• 여비교통비: 택시, KTX", ""],
        ["", "• 자산/투자: 노트북, 가구(30만↑)", ""],
        ["", "• 기타: 보증금, 수수료", ""],
        ["상세항목", "구체적인 내역", "박스 인쇄비"],
        ["거래처", "업체/쇼핑몰 이름", "(주)스톰팩"],
        ["공급가액", "부가세 제외 금액 입력", "500,000"],
        ["부가세", "자동계산 (수정 가능)", "50,000"],
        ["합계", "자동계산", "550,000"],
        ["결제수단", "개인카드/현금/법인카드", "개인카드"],
        ["증빙", "세금계산서/카드영수증", "카드영수증"],
        ["비고", "추가 메모", "샘플 500개"],
        [""],
        ["═══════════════════════════════════════════════════════"],
        ["4️⃣ 세무 처리 팁"],
        ["═══════════════════════════════════════════════════════"],
        [""],
        ["✅ 개인카드 사용분 → 법인 전환 시 정산 가능"],
        ["✅ 증빙은 스마트폰으로 찍어서 드라이브에 저장"],
        ["✅ 카드영수증이 가장 확실한 증빙"],
        ["✅ 현금은 현금영수증 필수 (사업자번호 제시)"],
        ["⚠️ 간이영수증은 3만원 이하만 안전"],
        [""],
        ["═══════════════════════════════════════════════════════"],
        ["5️⃣ FAQ"],
        ["═══════════════════════════════════════════════════════"],
        [""],
        ["Q. 매월 새 시트를 만드나요?"],
        ["A. NO! 한 시트에 2025년 전체 데이터 누적하세요"],
        [""],
        ["Q. 물품 구매도 여기 기록하나요?"],
        ["A. YES! 대분류만 구분하면 됩니다"],
        ["   노트북 → 자산/투자, 볼펜 → 운영비"],
        [""],
        ["Q. 물품관리 장부는 별도로 필요한가요?"],
        ["A. 소규모는 불필요, 재고 많으면 나중에 추가"],
        [""],
        ["Q. 정부 지원금은?"],
        ["A. 구분: 수입, 대분류: 기타"],
        [""],
        ["💡 궁금한 점은 언제든 물어보세요! 🚀"],
    ]
    
    guide_sheet.clear()
    guide_sheet.update(new_guide, 'A1')
    
    # 서식
    guide_sheet.format('A1', {
        'backgroundColor': {'red': 0.2, 'green': 0.4, 'blue': 0.8},
        'textFormat': {'bold': True, 'fontSize': 14, 'foregroundColor': {'red': 1, 'green': 1, 'blue': 1}}
    })
    
    print("✅ 사용가이드 업데이트 완료!")

if __name__ == "__main__":
    try:
        update_guide()
    except Exception as e:
        print(f"❌ 오류: {e}")
        import traceback
        traceback.print_exc()

