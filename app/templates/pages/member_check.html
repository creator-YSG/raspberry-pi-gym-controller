{% extends "layouts/base.html" %}

{% block title %}íšŒì› í™•ì¸{% endblock %}

{% block body_class %}member-check-page{% endblock %}

{% block content %}
<div class="member-check-container">
    <!-- ìƒë‹¨: íšŒì› ì •ë³´ -->
    <div class="member-info-section">
        <div class="check-icon">âœ…</div>
        <h1 class="status-title">íšŒì› ì¸ì¦ ì™„ë£Œ</h1>
        
        <div class="member-card">
            <div class="member-photo">
                {% if member.photo_url %}
                <img src="{{ member.photo_url }}" alt="{{ member.name }}">
                {% else %}
                <div class="member-avatar">ğŸ‘¤</div>
                {% endif %}
            </div>
            
            <div class="member-details">
                <div class="member-name">{{ member.name }}</div>
                <div class="member-id">íšŒì›ë²ˆí˜¸: {{ member.member_id }}</div>
                
                {% if member.program_name %}
                <div class="member-program">ğŸ‹ï¸ {{ member.program_name }}</div>
                {% endif %}
                
                {% if member.get('member_category') == 'staff' %}
                <div class="member-badge badge-staff">ğŸ“ êµì§ì›</div>
                {% elif member.get('gender', '').lower() in ['m', 'male'] %}
                <div class="member-badge badge-male">ğŸ‘¨ ë‚¨ì„± íšŒì›</div>
                {% else %}
                <div class="member-badge badge-female">ğŸ‘© ì—¬ì„± íšŒì›</div>
                {% endif %}
            </div>
        </div>
        
        <!-- ë§Œë£Œì¼ ì •ë³´ ì¹´ë“œ (ë” í¬ê²Œ) -->
        <div class="expiry-card">
            {% if member.expiry_date and member.expiry_date != 'None' %}
                {% if member.days_remaining is not none %}
                    <div class="days-remaining-big">
                        <div class="days-number">{{ member.days_remaining }}</div>
                        <div class="days-label">ì¼ ë‚¨ìŒ</div>
                    </div>
                    <div class="expiry-date-info">
                        <span class="expiry-label">ë§Œë£Œì¼:</span>
                        <span class="expiry-date {% if member.is_expired %}expired{% endif %}">
                            {{ member.expiry_date }}
                        </span>
                    </div>
                {% else %}
                    <div class="expiry-date-info">
                        <span class="expiry-label">ë§Œë£Œì¼:</span>
                        <span class="expiry-date {% if member.is_expired %}expired{% endif %}">
                            {{ member.expiry_date }}
                        </span>
                    </div>
                {% endif %}
            {% else %}
                <div class="expiry-none">
                    <div class="expiry-none-icon">âš ï¸</div>
                    <div class="expiry-none-text">ë§Œë£Œì¼ ì •ë³´ ì—†ìŒ</div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- ì¤‘ê°„: ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div class="instruction-section">
        {% if action == 'rental' %}
        <div class="door-status">
            <div class="door-icon">ğŸšª</div>
            <p class="door-message">ë½ì»¤ ë¬¸ì´ ì—´ë ¸ìŠµë‹ˆë‹¤</p>
        </div>
        <div class="instruction-message">
            <div class="instruction-icon">ğŸ—ï¸</div>
            <p class="instruction-text">ì›í•˜ëŠ” ë½ì»¤í‚¤ë¥¼ ê°€ì ¸ê°€ì„¸ìš”</p>
            <p class="instruction-sub">ì„¼ì„œê°€ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤</p>
        </div>
        {% else %}
        <div class="door-status">
            <div class="door-icon">ğŸšª</div>
            <p class="door-message">ë½ì»¤ ë¬¸ì´ ì—´ë ¸ìŠµë‹ˆë‹¤</p>
        </div>
        <div class="instruction-message">
            <div class="instruction-icon">ğŸ”‘</div>
            <p class="instruction-text">ë½ì»¤í‚¤ë¥¼ ì œìë¦¬ì— ê½‚ì•„ì£¼ì„¸ìš”</p>
            <p class="instruction-sub">ì„¼ì„œê°€ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤</p>
        </div>
        {% endif %}
    </div>

    <!-- í•˜ë‹¨: ëŒ€ê¸° ì¤‘ í‘œì‹œ -->
    <div class="waiting-section">
        <div class="waiting-spinner">
            <div class="spinner"></div>
        </div>
        <p class="waiting-text">ë½ì»¤ ì„ íƒì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
    </div>

    <!-- í˜„ì¬ ê°ì§€ëœ ë½ì»¤ ë²ˆí˜¸ (ì„¼ì„œ ì´ë²¤íŠ¸ë¡œ í‘œì‹œ) -->
    <div class="locker-detected hidden" id="lockerDetected">
        <div class="detected-icon">ğŸ¯</div>
        <div class="detected-number" id="detectedNumber"></div>
    </div>
</div>

<!-- ìˆ¨ê²¨ì§„ ë°ì´í„° -->
<div id="memberData" 
     data-member-id="{{ member.member_id }}"
     data-action="{{ action }}"
     data-zone="{{ member.zone }}"
     style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
let memberData = null;
let pollingInterval = null;
let processedSensors = new Set(); // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€

document.addEventListener('DOMContentLoaded', function() {
    // íšŒì› ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const dataElement = document.getElementById('memberData');
    memberData = {
        memberId: dataElement.dataset.memberId,
        action: dataElement.dataset.action,
        zone: dataElement.dataset.zone
    };
    
    console.log('ğŸ‘¤ íšŒì› í™•ì¸ í™”ë©´:', memberData);
    
    // â±ï¸ ì„±ëŠ¥ ì¸¡ì •: í˜ì´ì§€ ë¡œë“œ ì‹œì 
    const t_page_load = performance.now();
    console.log(`â±ï¸ [PERF-DOOR] íšŒì› í™•ì¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ`);
    
    // ì„œë²„ì—ë„ ë¡œê·¸ ì „ì†¡ (ì„±ëŠ¥ ì¸¡ì •ìš©)
    fetch('/api/test/log', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({log: `[PERF-UI] íšŒì› í™•ì¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ (DOMContentLoaded)`})
    }).catch(() => {});
    
    // ë½ì»¤ ë¬¸ ì—´ê¸°
    openLockerDoor(memberData.zone, t_page_load);
    
    // ì„¼ì„œ í´ë§ ì‹œì‘
    startSensorPolling();
    
    // 20ì´ˆ íƒ€ì„ì•„ì›ƒ (ì„¼ì„œ ë³€í™” ì—†ìœ¼ë©´ ë¬¸ ë‹«ê³  í™ˆìœ¼ë¡œ)
    setTimeout(function() {
        console.log('â±ï¸ íƒ€ì„ì•„ì›ƒ: ì„¼ì„œ ë³€í™” ì—†ìŒ, ë¬¸ ë‹«ê³  í™ˆìœ¼ë¡œ ì´ë™');
        stopSensorPolling();
        closeDoorAndGoHome();
    }, 20000);
});

// ì„¼ì„œ í´ë§ ì‹œì‘ (500ms ê°„ê²©ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì²´í¬)
function startSensorPolling() {
    console.log('ğŸ”„ ì„¼ì„œ í´ë§ ì‹œì‘ ì „ í ë¹„ìš°ê¸°...');
    
    // ì„¼ì„œ í ë¹„ìš°ê¸° (ì´ì „ ì´ë²¤íŠ¸ ì œê±°)
    let clearCount = 0;
    function clearQueue() {
        fetch('/api/sensor/poll')
            .then(response => response.json())
            .then(data => {
                if (data.has_events) {
                    clearCount++;
                    console.log(`ğŸ—‘ï¸ ì„¼ì„œ í ë¹„ìš°ê¸° ${clearCount}íšŒ (${data.count}ê°œ ì œê±°)`);
                    if (clearCount < 10) {
                        clearQueue(); // ê³„ì† ë¹„ìš°ê¸°
                    } else {
                        startActualPolling();
                    }
                } else {
                    console.log('âœ… ì„¼ì„œ í ë¹„ìš°ê¸° ì™„ë£Œ');
                    startActualPolling();
                }
            })
            .catch(error => {
                console.error('ì„¼ì„œ í ë¹„ìš°ê¸° ì˜¤ë¥˜:', error);
                startActualPolling(); // ì˜¤ë¥˜ ë°œìƒí•´ë„ í´ë§ ì‹œì‘
            });
    }
    
    function startActualPolling() {
        console.log('ğŸ”„ ì‹¤ì œ ì„¼ì„œ í´ë§ ì‹œì‘');
        pollingInterval = setInterval(function() {
            fetch('/api/sensor/poll')
                .then(response => response.json())
                .then(data => {
                    if (data.has_events && data.events) {
                        console.log(`ğŸ“¥ ì„¼ì„œ ì´ë²¤íŠ¸ ${data.count}ê°œ ìˆ˜ì‹ :`, data.events);
                        data.events.forEach(event => {
                            handleSensorEvent(event);
                        });
                    }
                })
                .catch(error => {
                    // ì¡°ìš©íˆ ë¬´ì‹œ (ë„ˆë¬´ ë§ì€ ë¡œê·¸ ë°©ì§€)
                });
        }, 500); // 500ms ê°„ê²© (ë¹ ë¥¸ ì‘ë‹µ)
    }
    
    // í ë¹„ìš°ê¸° ì‹œì‘
    clearQueue();
}

// ì„¼ì„œ í´ë§ ì¤‘ì§€
function stopSensorPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('â¹ï¸ ì„¼ì„œ í´ë§ ì¤‘ì§€');
    }
}

// ì„¼ì„œ ì´ë²¤íŠ¸ ì²˜ë¦¬
function handleSensorEvent(data) {
    const sensorNum = data.sensor_num;
    const state = data.state;
    
    // ì„¼ì„œ ë²ˆí˜¸ë¡œ ë½ì»¤ ID ì¡°íšŒ
    fetch(`/api/sensors/${sensorNum}/locker`)
        .then(response => response.json())
        .then(lockerData => {
            if (!lockerData.success || !lockerData.locker_id) {
                console.warn(`âš ï¸ ì„¼ì„œ ${sensorNum}ì— ë§¤í•‘ëœ ë½ì»¤ ì—†ìŒ`);
                return;
            }
            
            const lockerId = lockerData.locker_id;
            console.log(`ğŸ” ì„¼ì„œ ${sensorNum} -> ë½ì»¤ ${lockerId}: ${state}`);
            
            // ğŸ†• 1ë‹¨ê³„: ëª¨ë“  ì„¼ì„œ ì´ë²¤íŠ¸ë¥¼ ë¬´ì¡°ê±´ DBì— ê¸°ë¡ (ê°ì‚¬ ì¶”ì )
            logSensorEvent(lockerId, state);
            
            // 2ë‹¨ê³„: HIGHì¼ ë•Œ processedSensorsì—ì„œ ì œê±° (ì¬ì‹œë„ ê°€ëŠ¥)
            const eventKey = `${sensorNum}-${state}`;
            if (state === 'HIGH') {
                // í‚¤ë¥¼ ëºìœ¼ë¯€ë¡œ ì´ì „ LOW ì´ë²¤íŠ¸ ì œê±°
                const lowKey = `${sensorNum}-LOW`;
                processedSensors.delete(lowKey);
                console.log(`ğŸ”“ ì„¼ì„œ ë¦¬ì…‹: ${lowKey} (ì¬ì‹œë„ ê°€ëŠ¥)`);
            }
            
            // 3ë‹¨ê³„: ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ (ê°™ì€ ìƒíƒœëŠ” í•œ ë²ˆë§Œ ì²˜ë¦¬)
            if (processedSensors.has(eventKey)) {
                console.log(`â­ï¸ ì´ë¯¸ ì²˜ë¦¬ëœ ì´ë²¤íŠ¸: ${eventKey}`);
                return;
            }
            processedSensors.add(eventKey);
            
            // ë½ì»¤ ë²ˆí˜¸ í™”ë©´ì— í‘œì‹œ
            const detectedDiv = document.getElementById('lockerDetected');
            const detectedNumber = document.getElementById('detectedNumber');
            
            if (state === 'HIGH') {
                // ë½ì»¤í‚¤ ì œê±°ë¨ (IR ì„¼ì„œ: HIGH = ë¬¼ì²´ ê°ì§€ ì•ˆ ë¨)
                detectedNumber.textContent = lockerId;
                detectedDiv.classList.remove('hidden');
                detectedDiv.classList.add('show');
                
                // ëŒ€ì—¬ ì•¡ì…˜ì´ë©´ ëŒ€ì—¬ í”„ë¡œì„¸ìŠ¤ ì§„í–‰
                if (memberData.action === 'rental') {
                    stopSensorPolling(); // í´ë§ ì¤‘ì§€
                    processRental(lockerId);
                }
            } else if (state === 'LOW') {
                // ë½ì»¤í‚¤ ì‚½ì…ë¨ (IR ì„¼ì„œ: LOW = ë¬¼ì²´ ê°ì§€ë¨)
                detectedNumber.textContent = lockerId;
                detectedDiv.classList.remove('hidden');
                detectedDiv.classList.add('show');
                
                // ë°˜ë‚© ì•¡ì…˜ì´ë©´ ë°˜ë‚© í”„ë¡œì„¸ìŠ¤ ì§„í–‰
                if (memberData.action === 'return') {
                    stopSensorPolling(); // í´ë§ ì¤‘ì§€
                    processReturn(lockerId);
                }
            }
        })
        .catch(error => {
            console.error(`âŒ ì„¼ì„œ ${sensorNum} ë½ì»¤ ì¡°íšŒ ì˜¤ë¥˜:`, error);
        });
}

// ì„¼ì„œ ì´ë²¤íŠ¸ DB ê¸°ë¡ (ëª¨ë“  ì´ë²¤íŠ¸)
function logSensorEvent(lockerId, state) {
    const context = memberData ? memberData.action : 'unauthorized';
    const memberId = memberData ? memberData.memberId : null;
    
    fetch('/api/sensors/log', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            locker_id: lockerId,
            state: state,
            member_id: memberId,
            context: context
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`ğŸ“Š ì„¼ì„œ ì´ë²¤íŠ¸ ê¸°ë¡: ${lockerId} ${state} (event_id: ${data.event_id})`);
        } else {
            console.warn(`âš ï¸ ì„¼ì„œ ì´ë²¤íŠ¸ ê¸°ë¡ ì‹¤íŒ¨: ${data.error}`);
        }
    })
    .catch(error => {
        console.error(`âŒ ì„¼ì„œ ì´ë²¤íŠ¸ ê¸°ë¡ ì˜¤ë¥˜:`, error);
    });
}

// ëŒ€ì—¬ í”„ë¡œì„¸ìŠ¤
function processRental(lockerId) {
    console.log('ğŸ”‘ ëŒ€ì—¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘:', lockerId);
    
    fetch('/api/rentals/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberData.memberId,
            locker_id: lockerId,
            action: 'rental'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('âœ… ëŒ€ì—¬ ì„±ê³µ');
            setTimeout(function() {
                navigateToComplete('rental', lockerId);
            }, 1000);
        } else {
            console.error('âŒ ëŒ€ì—¬ ì‹¤íŒ¨:', data.error);
            navigateToError('rental_failed', data.error);
        }
    })
    .catch(error => {
        console.error('âŒ ëŒ€ì—¬ API ì˜¤ë¥˜:', error);
        navigateToError('system_error', 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë°˜ë‚© í”„ë¡œì„¸ìŠ¤
function processReturn(lockerId) {
    console.log('ğŸ”“ ë°˜ë‚© í”„ë¡œì„¸ìŠ¤ ì‹œì‘:', lockerId);
    
    fetch('/api/rentals/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberData.memberId,
            locker_id: lockerId,
            action: 'return'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('âœ… ë°˜ë‚© ì„±ê³µ');
            setTimeout(function() {
                navigateToComplete('return', lockerId);
            }, 1000);
        } else {
            // ì˜ëª»ëœ ë½ì»¤ ì—ëŸ¬ì¸ì§€ í™•ì¸
            if (data.error_code === 'WRONG_LOCKER') {
                console.warn('âš ï¸ ì˜ëª»ëœ ë½ì»¤:', data.error);
                // í™”ë©´ì— ê²½ê³  í‘œì‹œ
                showWrongLockerWarning(data.target_locker, data.actual_locker);
                // ì„¼ì„œ í´ë§ ì¬ì‹œì‘ (ì˜¬ë°”ë¥¸ ë½ì»¤ì— ë„£ì„ ë•Œê¹Œì§€)
                processedSensors.clear(); // ì´ë²¤íŠ¸ ì¬ì²˜ë¦¬ ê°€ëŠ¥í•˜ë„ë¡ í´ë¦¬ì–´
                startSensorPolling();
            } else {
                // ë‹¤ë¥¸ ì—ëŸ¬ëŠ” ì—ëŸ¬ í™”ë©´ìœ¼ë¡œ
                console.error('âŒ ë°˜ë‚© ì‹¤íŒ¨:', data.error);
                navigateToError('return_failed', data.error);
            }
        }
    })
    .catch(error => {
        console.error('âŒ ë°˜ë‚© API ì˜¤ë¥˜:', error);
        navigateToError('system_error', 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì˜ëª»ëœ ë½ì»¤ ê²½ê³  í‘œì‹œ
function showWrongLockerWarning(targetLocker, actualLocker) {
    console.log(`âš ï¸ ì˜ëª»ëœ ë½ì»¤ ê²½ê³ : ${targetLocker} â† ${actualLocker}`);
    
    // ëŒ€ê¸° ì¤‘ ì„¹ì…˜ì„ ê²½ê³  ë©”ì‹œì§€ë¡œ ë³€ê²½
    const waitingSection = document.querySelector('.waiting-section');
    if (waitingSection) {
        waitingSection.innerHTML = `
            <div class="error-icon" style="font-size: 60px; margin-bottom: 20px;">âš ï¸</div>
            <p class="error-title" style="font-size: 28px; font-weight: bold; color: #f59e0b; margin-bottom: 15px;">
                ì˜ëª»ëœ ë½ì»¤ì…ë‹ˆë‹¤
            </p>
            <p class="error-message" style="font-size: 22px; margin-bottom: 10px;">
                <strong style="color: #10b981;">${targetLocker}ë²ˆ</strong> ë½ì»¤ë¥¼ ëŒ€ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤
            </p>
            <p class="error-message" style="font-size: 22px; margin-bottom: 20px;">
                <strong style="color: #ef4444;">${actualLocker}ë²ˆ</strong>ì´ ì•„ë‹Œ <strong style="color: #10b981;">${targetLocker}ë²ˆ</strong>ì— ë„£ì–´ì£¼ì„¸ìš”
            </p>
            <div class="waiting-spinner">
                <div class="spinner"></div>
            </div>
            <p class="waiting-text" style="color: #f59e0b;">ì˜¬ë°”ë¥¸ ë½ì»¤ì— ë„£ì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
        `;
    }
}

// ì™„ë£Œ í™”ë©´ìœ¼ë¡œ ì´ë™
function navigateToComplete(action, lockerId) {
    const url = `/${action}-complete?locker_id=${lockerId}`;
    window.location.href = url;
}

// ì—ëŸ¬ í™”ë©´ìœ¼ë¡œ ì´ë™
function navigateToError(errorType, message) {
    const url = `/error?type=${errorType}&message=${encodeURIComponent(message)}`;
    window.location.href = url;
}

// í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
function goHome() {
    window.location.href = '/';
}

// ë¬¸ ë‹«ê³  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸° (íƒ€ì„ì•„ì›ƒìš©)
function closeDoorAndGoHome() {
    console.log('ğŸšª íƒ€ì„ì•„ì›ƒ: ë¬¸ ë‹«ëŠ” ì¤‘...');
    
    // 1. íƒ€ì„ì•„ì›ƒ ê¸°ë¡ API í˜¸ì¶œ
    fetch('/api/rentals/timeout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberData.memberId
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('â±ï¸ íƒ€ì„ì•„ì›ƒ ê¸°ë¡ ì™„ë£Œ:', data);
    })
    .catch(error => {
        console.error('âŒ íƒ€ì„ì•„ì›ƒ ê¸°ë¡ ì˜¤ë¥˜:', error);
    });
    
    // 2. ë¬¸ ë‹«ê¸° API í˜¸ì¶œ
    fetch('/api/hardware/motor_move', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            revs: -0.917,
            rpm: 30
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('âœ… ë¬¸ ë‹«ê¸° ì™„ë£Œ:', data);
        // 1ì´ˆ í›„ í™ˆìœ¼ë¡œ ì´ë™
        setTimeout(goHome, 1000);
    })
    .catch(error => {
        console.error('âŒ ë¬¸ ë‹«ê¸° ì˜¤ë¥˜:', error);
        // ì˜¤ë¥˜ê°€ ë‚˜ë„ í™ˆìœ¼ë¡œ ì´ë™
        setTimeout(goHome, 1000);
    });
}

// ë½ì»¤ ë¬¸ ì—´ê¸°
function openLockerDoor(zone, pageLoadTime) {
    const t_door_start = performance.now();
    const delay = (t_door_start - pageLoadTime).toFixed(2);
    console.log(`â±ï¸ [PERF-DOOR] ë¬¸ ì—´ê¸° API í˜¸ì¶œ ì‹œì‘ (í˜ì´ì§€ ë¡œë“œ í›„ ${delay}ms)`);
    
    // ì„œë²„ì—ë„ ë¡œê·¸ ì „ì†¡
    fetch('/api/test/log', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({log: `[PERF-UI] ë¬¸ ì—´ê¸° API í˜¸ì¶œ ì‹œì‘ (í˜ì´ì§€ ë¡œë“œ í›„ ${delay}ms)`})
    }).catch(() => {});
    
    fetch('/api/locker/open-door', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ zone: zone })
    })
    .then(response => {
        const t_door_response = performance.now();
        console.log(`â±ï¸ [PERF-DOOR] ë¬¸ ì—´ê¸° API ì‘ë‹µ: ${(t_door_response - t_door_start).toFixed(2)}ms`);
        return response.json();
    })
    .then(data => {
        const t_door_complete = performance.now();
        if (data.success) {
            console.log(`â±ï¸ [PERF-DOOR] âœ… ë¬¸ ì—´ê¸° ì™„ë£Œ: ${(t_door_complete - t_door_start).toFixed(2)}ms | ì „ì²´(í˜ì´ì§€ ë¡œë“œë¶€í„°): ${(t_door_complete - pageLoadTime).toFixed(2)}ms`);
            console.log(`ğŸšª ${zone} êµ¬ì—­ ë¬¸ ì—´ê¸° ì„±ê³µ:`, data.message);
        } else {
            console.error(`âŒ ${zone} êµ¬ì—­ ë¬¸ ì—´ê¸° ì‹¤íŒ¨:`, data.error);
        }
    })
    .catch(error => {
        console.error('âŒ ë¬¸ ì—´ê¸° API ì˜¤ë¥˜:', error);
    });
}
</script>
{% endblock %}

