{% extends "layouts/base.html" %}

{% block title %}회원 확인{% endblock %}

{% block body_class %}member-check-page{% endblock %}

{% block content %}
<div class="member-check-container">
    <!-- 상단: 회원 정보 -->
    <div class="member-info-section">
        <div class="check-icon">✅</div>
        <h1 class="status-title">회원 인증 완료</h1>
        
        <div class="member-card">
            <div class="member-photo">
                {% if member.photo_url %}
                <img src="{{ member.photo_url }}" alt="{{ member.name }}">
                {% else %}
                <div class="member-avatar">👤</div>
                {% endif %}
            </div>
            
            <div class="member-details">
                <div class="member-name">{{ member.name }}</div>
                <div class="member-id">회원번호: {{ member.member_id }}</div>
                
                {% if member.program_name %}
                <div class="member-program">🏋️ {{ member.program_name }}</div>
                {% endif %}
                
                {% if member.get('member_category') == 'staff' %}
                <div class="member-badge badge-staff">🎓 교직원</div>
                {% elif member.get('gender', '').lower() in ['m', 'male'] %}
                <div class="member-badge badge-male">👨 남성 회원</div>
                {% else %}
                <div class="member-badge badge-female">👩 여성 회원</div>
                {% endif %}
            </div>
        </div>
        
        <!-- 만료일 정보 카드 (더 크게) -->
        <div class="expiry-card">
            {% if member.expiry_date and member.expiry_date != 'None' %}
                {% if member.days_remaining is not none %}
                    <div class="days-remaining-big">
                        <div class="days-number">{{ member.days_remaining }}</div>
                        <div class="days-label">일 남음</div>
                    </div>
                    <div class="expiry-date-info">
                        <span class="expiry-label">만료일:</span>
                        <span class="expiry-date {% if member.is_expired %}expired{% endif %}">
                            {{ member.expiry_date }}
                        </span>
                    </div>
                {% else %}
                    <div class="expiry-date-info">
                        <span class="expiry-label">만료일:</span>
                        <span class="expiry-date {% if member.is_expired %}expired{% endif %}">
                            {{ member.expiry_date }}
                        </span>
                    </div>
                {% endif %}
            {% else %}
                <div class="expiry-none">
                    <div class="expiry-none-icon">⚠️</div>
                    <div class="expiry-none-text">만료일 정보 없음</div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- 중간: 안내 메시지 -->
    <div class="instruction-section">
        {% if action == 'rental' %}
        <div class="door-status">
            <div class="door-icon">🚪</div>
            <p class="door-message">락커 문이 열렸습니다</p>
        </div>
        <div class="instruction-message">
            <div class="instruction-icon">🗝️</div>
            <p class="instruction-text">원하는 락커키를 가져가세요</p>
            <p class="instruction-sub">센서가 자동으로 감지합니다</p>
        </div>
        {% else %}
        <div class="door-status">
            <div class="door-icon">🚪</div>
            <p class="door-message">락커 문이 열렸습니다</p>
        </div>
        <div class="instruction-message">
            <div class="instruction-icon">🔑</div>
            <p class="instruction-text">락커키를 제자리에 꽂아주세요</p>
            <p class="instruction-sub">센서가 자동으로 감지합니다</p>
        </div>
        {% endif %}
    </div>

    <!-- 하단: 대기 중 표시 -->
    <div class="waiting-section">
        <div class="waiting-spinner">
            <div class="spinner"></div>
        </div>
        <p class="waiting-text">락커 선택을 기다리는 중...</p>
    </div>

    <!-- 현재 감지된 락커 번호 (센서 이벤트로 표시) -->
    <div class="locker-detected hidden" id="lockerDetected">
        <div class="detected-icon">🎯</div>
        <div class="detected-number" id="detectedNumber"></div>
    </div>
</div>

<!-- 숨겨진 데이터 -->
<div id="memberData" 
     data-member-id="{{ member.member_id }}"
     data-action="{{ action }}"
     data-zone="{{ member.zone }}"
     style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
let memberData = null;
let pollingInterval = null;
let processedSensors = new Set(); // 중복 처리 방지

document.addEventListener('DOMContentLoaded', function() {
    // 회원 데이터 가져오기
    const dataElement = document.getElementById('memberData');
    memberData = {
        memberId: dataElement.dataset.memberId,
        action: dataElement.dataset.action,
        zone: dataElement.dataset.zone
    };
    
    console.log('👤 회원 확인 화면:', memberData);
    
    // ⏱️ 성능 측정: 페이지 로드 시점
    const t_page_load = performance.now();
    console.log(`⏱️ [PERF-DOOR] 회원 확인 페이지 로드 완료`);
    
    // 서버에도 로그 전송 (성능 측정용)
    fetch('/api/test/log', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({log: `[PERF-UI] 회원 확인 페이지 로드 완료 (DOMContentLoaded)`})
    }).catch(() => {});
    
    // 락커 문 열기
    openLockerDoor(memberData.zone, t_page_load);
    
    // 센서 폴링 시작
    startSensorPolling();
    
    // 20초 타임아웃 (센서 변화 없으면 문 닫고 홈으로)
    setTimeout(function() {
        console.log('⏱️ 타임아웃: 센서 변화 없음, 문 닫고 홈으로 이동');
        stopSensorPolling();
        closeDoorAndGoHome();
    }, 20000);
});

// 센서 폴링 시작 (500ms 간격으로 빠르게 체크)
function startSensorPolling() {
    console.log('🔄 센서 폴링 시작 전 큐 비우기...');
    
    // 센서 큐 비우기 (이전 이벤트 제거)
    let clearCount = 0;
    function clearQueue() {
        fetch('/api/sensor/poll')
            .then(response => response.json())
            .then(data => {
                if (data.has_events) {
                    clearCount++;
                    console.log(`🗑️ 센서 큐 비우기 ${clearCount}회 (${data.count}개 제거)`);
                    if (clearCount < 10) {
                        clearQueue(); // 계속 비우기
                    } else {
                        startActualPolling();
                    }
                } else {
                    console.log('✅ 센서 큐 비우기 완료');
                    startActualPolling();
                }
            })
            .catch(error => {
                console.error('센서 큐 비우기 오류:', error);
                startActualPolling(); // 오류 발생해도 폴링 시작
            });
    }
    
    function startActualPolling() {
        console.log('🔄 실제 센서 폴링 시작');
        pollingInterval = setInterval(function() {
            fetch('/api/sensor/poll')
                .then(response => response.json())
                .then(data => {
                    if (data.has_events && data.events) {
                        console.log(`📥 센서 이벤트 ${data.count}개 수신:`, data.events);
                        data.events.forEach(event => {
                            handleSensorEvent(event);
                        });
                    }
                })
                .catch(error => {
                    // 조용히 무시 (너무 많은 로그 방지)
                });
        }, 500); // 500ms 간격 (빠른 응답)
    }
    
    // 큐 비우기 시작
    clearQueue();
}

// 센서 폴링 중지
function stopSensorPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('⏹️ 센서 폴링 중지');
    }
}

// 센서 이벤트 처리
function handleSensorEvent(data) {
    const sensorNum = data.sensor_num;
    const state = data.state;
    
    // 센서 번호로 락커 ID 조회
    fetch(`/api/sensors/${sensorNum}/locker`)
        .then(response => response.json())
        .then(lockerData => {
            if (!lockerData.success || !lockerData.locker_id) {
                console.warn(`⚠️ 센서 ${sensorNum}에 매핑된 락커 없음`);
                return;
            }
            
            const lockerId = lockerData.locker_id;
            console.log(`🔍 센서 ${sensorNum} -> 락커 ${lockerId}: ${state}`);
            
            // 🆕 1단계: 모든 센서 이벤트를 무조건 DB에 기록 (감사 추적)
            logSensorEvent(lockerId, state);
            
            // 2단계: HIGH일 때 processedSensors에서 제거 (재시도 가능)
            const eventKey = `${sensorNum}-${state}`;
            if (state === 'HIGH') {
                // 키를 뺐으므로 이전 LOW 이벤트 제거
                const lowKey = `${sensorNum}-LOW`;
                processedSensors.delete(lowKey);
                console.log(`🔓 센서 리셋: ${lowKey} (재시도 가능)`);
            }
            
            // 3단계: 중복 처리 방지 (같은 상태는 한 번만 처리)
            if (processedSensors.has(eventKey)) {
                console.log(`⏭️ 이미 처리된 이벤트: ${eventKey}`);
                return;
            }
            processedSensors.add(eventKey);
            
            // 락커 번호 화면에 표시
            const detectedDiv = document.getElementById('lockerDetected');
            const detectedNumber = document.getElementById('detectedNumber');
            
            if (state === 'HIGH') {
                // 락커키 제거됨 (IR 센서: HIGH = 물체 감지 안 됨)
                detectedNumber.textContent = lockerId;
                detectedDiv.classList.remove('hidden');
                detectedDiv.classList.add('show');
                
                // 대여 액션이면 대여 프로세스 진행
                if (memberData.action === 'rental') {
                    stopSensorPolling(); // 폴링 중지
                    processRental(lockerId);
                }
            } else if (state === 'LOW') {
                // 락커키 삽입됨 (IR 센서: LOW = 물체 감지됨)
                detectedNumber.textContent = lockerId;
                detectedDiv.classList.remove('hidden');
                detectedDiv.classList.add('show');
                
                // 반납 액션이면 반납 프로세스 진행
                if (memberData.action === 'return') {
                    stopSensorPolling(); // 폴링 중지
                    processReturn(lockerId);
                }
            }
        })
        .catch(error => {
            console.error(`❌ 센서 ${sensorNum} 락커 조회 오류:`, error);
        });
}

// 센서 이벤트 DB 기록 (모든 이벤트)
function logSensorEvent(lockerId, state) {
    const context = memberData ? memberData.action : 'unauthorized';
    const memberId = memberData ? memberData.memberId : null;
    
    fetch('/api/sensors/log', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            locker_id: lockerId,
            state: state,
            member_id: memberId,
            context: context
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`📊 센서 이벤트 기록: ${lockerId} ${state} (event_id: ${data.event_id})`);
        } else {
            console.warn(`⚠️ 센서 이벤트 기록 실패: ${data.error}`);
        }
    })
    .catch(error => {
        console.error(`❌ 센서 이벤트 기록 오류:`, error);
    });
}

// 대여 프로세스
function processRental(lockerId) {
    console.log('🔑 대여 프로세스 시작:', lockerId);
    
    fetch('/api/rentals/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberData.memberId,
            locker_id: lockerId,
            action: 'rental'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ 대여 성공');
            setTimeout(function() {
                navigateToComplete('rental', lockerId);
            }, 1000);
        } else {
            console.error('❌ 대여 실패:', data.error);
            navigateToError('rental_failed', data.error);
        }
    })
    .catch(error => {
        console.error('❌ 대여 API 오류:', error);
        navigateToError('system_error', '시스템 오류가 발생했습니다.');
    });
}

// 반납 프로세스
function processReturn(lockerId) {
    console.log('🔓 반납 프로세스 시작:', lockerId);
    
    fetch('/api/rentals/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberData.memberId,
            locker_id: lockerId,
            action: 'return'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ 반납 성공');
            setTimeout(function() {
                navigateToComplete('return', lockerId);
            }, 1000);
        } else {
            // 잘못된 락커 에러인지 확인
            if (data.error_code === 'WRONG_LOCKER') {
                console.warn('⚠️ 잘못된 락커:', data.error);
                // 화면에 경고 표시
                showWrongLockerWarning(data.target_locker, data.actual_locker);
                // 센서 폴링 재시작 (올바른 락커에 넣을 때까지)
                processedSensors.clear(); // 이벤트 재처리 가능하도록 클리어
                startSensorPolling();
            } else {
                // 다른 에러는 에러 화면으로
                console.error('❌ 반납 실패:', data.error);
                navigateToError('return_failed', data.error);
            }
        }
    })
    .catch(error => {
        console.error('❌ 반납 API 오류:', error);
        navigateToError('system_error', '시스템 오류가 발생했습니다.');
    });
}

// 잘못된 락커 경고 표시
function showWrongLockerWarning(targetLocker, actualLocker) {
    console.log(`⚠️ 잘못된 락커 경고: ${targetLocker} ← ${actualLocker}`);
    
    // 대기 중 섹션을 경고 메시지로 변경
    const waitingSection = document.querySelector('.waiting-section');
    if (waitingSection) {
        waitingSection.innerHTML = `
            <div class="error-icon" style="font-size: 60px; margin-bottom: 20px;">⚠️</div>
            <p class="error-title" style="font-size: 28px; font-weight: bold; color: #f59e0b; margin-bottom: 15px;">
                잘못된 락커입니다
            </p>
            <p class="error-message" style="font-size: 22px; margin-bottom: 10px;">
                <strong style="color: #10b981;">${targetLocker}번</strong> 락커를 대여하셨습니다
            </p>
            <p class="error-message" style="font-size: 22px; margin-bottom: 20px;">
                <strong style="color: #ef4444;">${actualLocker}번</strong>이 아닌 <strong style="color: #10b981;">${targetLocker}번</strong>에 넣어주세요
            </p>
            <div class="waiting-spinner">
                <div class="spinner"></div>
            </div>
            <p class="waiting-text" style="color: #f59e0b;">올바른 락커에 넣을 때까지 기다리는 중...</p>
        `;
    }
}

// 완료 화면으로 이동
function navigateToComplete(action, lockerId) {
    const url = `/${action}-complete?locker_id=${lockerId}`;
    window.location.href = url;
}

// 에러 화면으로 이동
function navigateToError(errorType, message) {
    const url = `/error?type=${errorType}&message=${encodeURIComponent(message)}`;
    window.location.href = url;
}

// 홈으로 돌아가기
function goHome() {
    window.location.href = '/';
}

// 문 닫고 홈으로 돌아가기 (타임아웃용)
function closeDoorAndGoHome() {
    console.log('🚪 타임아웃: 문 닫는 중...');
    
    // 1. 타임아웃 기록 API 호출
    fetch('/api/rentals/timeout', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberData.memberId
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('⏱️ 타임아웃 기록 완료:', data);
    })
    .catch(error => {
        console.error('❌ 타임아웃 기록 오류:', error);
    });
    
    // 2. 문 닫기 API 호출
    fetch('/api/hardware/motor_move', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            revs: -0.917,
            rpm: 30
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('✅ 문 닫기 완료:', data);
        // 1초 후 홈으로 이동
        setTimeout(goHome, 1000);
    })
    .catch(error => {
        console.error('❌ 문 닫기 오류:', error);
        // 오류가 나도 홈으로 이동
        setTimeout(goHome, 1000);
    });
}

// 락커 문 열기
function openLockerDoor(zone, pageLoadTime) {
    const t_door_start = performance.now();
    const delay = (t_door_start - pageLoadTime).toFixed(2);
    console.log(`⏱️ [PERF-DOOR] 문 열기 API 호출 시작 (페이지 로드 후 ${delay}ms)`);
    
    // 서버에도 로그 전송
    fetch('/api/test/log', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({log: `[PERF-UI] 문 열기 API 호출 시작 (페이지 로드 후 ${delay}ms)`})
    }).catch(() => {});
    
    fetch('/api/locker/open-door', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ zone: zone })
    })
    .then(response => {
        const t_door_response = performance.now();
        console.log(`⏱️ [PERF-DOOR] 문 열기 API 응답: ${(t_door_response - t_door_start).toFixed(2)}ms`);
        return response.json();
    })
    .then(data => {
        const t_door_complete = performance.now();
        if (data.success) {
            console.log(`⏱️ [PERF-DOOR] ✅ 문 열기 완료: ${(t_door_complete - t_door_start).toFixed(2)}ms | 전체(페이지 로드부터): ${(t_door_complete - pageLoadTime).toFixed(2)}ms`);
            console.log(`🚪 ${zone} 구역 문 열기 성공:`, data.message);
        } else {
            console.error(`❌ ${zone} 구역 문 열기 실패:`, data.error);
        }
    })
    .catch(error => {
        console.error('❌ 문 열기 API 오류:', error);
    });
}
</script>
{% endblock %}

