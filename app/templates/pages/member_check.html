{% extends "layouts/base.html" %}

{% block title %}íšŒì› í™•ì¸{% endblock %}

{% block body_class %}member-check-page{% endblock %}

{% block content %}
<div class="member-check-container">
    <!-- ìƒë‹¨: ë‚ ì§œ/ì‹œê°„/ìƒíƒœ -->
    <div class="datetime-header">
        <div class="datetime-info">
            <div class="header-date" id="headerDate"></div>
            <div class="header-time" id="headerTime"></div>
        </div>
        <div class="header-status">
            <span class="status-dot">â—</span>
        </div>
    </div>

    <!-- ì¸ì‚¬ë§ -->
    <div class="greeting-section">
        <h1 class="greeting-text">ë°˜ê°‘ìŠµë‹ˆë‹¤!</h1>
    </div>

    <!-- ì¤‘ì•™: íšŒì› ì •ë³´ (ì„¸ë¡œë¡œ) -->
    <div class="member-info-vertical">
        <!-- ì´ë©”ì¼ ë‹˜ -->
        <div class="info-row">
            <div class="info-value-large">
                {% if member.email %}
                    {{ member.email.split('@')[0] }}
                {% else %}
                    íšŒì›
                {% endif %}
                <span class="info-suffix">ë‹˜</span>
            </div>
        </div>
        
        <!-- ë‚¨ì€ ì¼ìˆ˜ (ê°€ì¥ í¬ê²Œ) -->
        <div class="info-row days-row">
            <div class="info-value-huge">
                {% if member.days_remaining is not none %}
                    <span class="days-number-huge">{{ member.days_remaining }}</span>
                    <span class="days-unit">ì¼ ë‚¨ìŒ</span>
                {% else %}
                    <span class="days-number-huge">-</span>
                    <span class="days-unit">ì¼ ë‚¨ìŒ</span>
                {% endif %}
            </div>
        </div>
        
        <!-- ì¢…ë£Œì¼ì -->
        <div class="info-row">
            <div class="info-value-medium">
                ì¢…ë£Œì¼: 
                {% if member.expiry_date and member.expiry_date != 'None' %}
                    {{ member.expiry_date }}
                {% else %}
                    -
                {% endif %}
            </div>
        </div>
    </div>

    <!-- í•˜ë‹¨: í”„ë¡œì„¸ìŠ¤ ì•ˆë‚´ + íƒ€ì´ë¨¸ -->
    <div class="process-message-with-timer">
        {% if action == 'rental' %}
        <div class="key-icon rental-key"></div>
        <div class="process-text">ëŒ€ì—¬í•  ë½ì»¤í‚¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
        {% else %}
        <div class="key-icon return-key"></div>
        <div class="process-text" id="returnMessage">
            {% if member.current_locker %}
            <strong style="color: #4caf50; font-size: 2.2rem;">{{ member.current_locker }}ë²ˆ</strong> ë½ì»¤ì—<br>
            í‚¤ë¥¼ ê½‚ì•„ì£¼ì„¸ìš”
            {% else %}
            ë½ì»¤í‚¤ë¥¼ ì œìë¦¬ì— ê½‚ì•„ì£¼ì„¸ìš”
            {% endif %}
        </div>
        {% endif %}
        
        <!-- íƒ€ì´ë¨¸ -->
        <div class="timer-display">
            <span class="timer-number" id="timerNumber">20</span>
            <span class="timer-unit">ì´ˆ</span>
        </div>
    </div>
    
    <!-- ë½ì»¤ ê°ì§€ í‘œì‹œ -->
    <div class="locker-detected hidden" id="lockerDetected">
        <div class="detected-icon">ğŸ¯</div>
        <div class="detected-number" id="detectedNumber"></div>
    </div>

    <!-- ëŒ€ê¸° ì¤‘ í‘œì‹œ (ìˆ¨ê¹€) -->
    <div class="waiting-section" id="waitingSection" style="display: none;">
        <div class="waiting-spinner">
            <div class="spinner"></div>
        </div>
        <p class="waiting-text">ì²˜ë¦¬ ì¤‘...</p>
    </div>
</div>

<script>
    const memberData = {{ member | tojson | safe }};
    const actionType = '{{ action }}';
    
    console.log('[MEMBER_CHECK] í˜ì´ì§€ ë¡œë“œ:', {
        member_id: memberData.member_id,
        action: actionType
    });
    
    // ì„±ëŠ¥ ì¸¡ì •
    const t_page_load = performance.now();
    
    // ì„¼ì„œ í´ë§
    let sensorPollingInterval = null;
    let processedSensors = new Set(); // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
    let timeoutHandler = null;
    let timerInterval = null;
    let remainingSeconds = 20;
    
    // íƒ€ì´ë¨¸ ì‹œì‘
    function startTimer() {
        const timerElement = document.getElementById('timerNumber');
        
        timerInterval = setInterval(() => {
            remainingSeconds--;
            timerElement.textContent = remainingSeconds;
            
            // 5ì´ˆ ì´í•˜ë©´ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ
            if (remainingSeconds <= 5) {
                timerElement.style.color = '#ff6b6b';
            }
            
            if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
            }
        }, 1000);
    }
    
    // 20ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
    timeoutHandler = setTimeout(() => {
        console.log('[TIMEOUT] 20ì´ˆ íƒ€ì„ì•„ì›ƒ - ë¬¸ ë‹«ê³  í™ˆìœ¼ë¡œ');
        closeDoorAndGoHome();
    }, 20000);
    
    function closeDoorAndGoHome() {
        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // íƒ€ì„ì•„ì›ƒ ê¸°ë¡ API í˜¸ì¶œ
        fetch('/api/rentals/timeout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                member_id: memberData.member_id
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('[TIMEOUT] íƒ€ì„ì•„ì›ƒ ê¸°ë¡ ì™„ë£Œ:', data);
        })
        .catch(error => {
            console.error('[TIMEOUT] íƒ€ì„ì•„ì›ƒ ê¸°ë¡ ì‹¤íŒ¨:', error);
        });
        
        // ë¬¸ ë‹«ê¸° ëª…ë ¹
        fetch('/api/hardware/motor_move', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                revs: -0.917,
                rpm: 30
            })
        });
        
        // 1ì´ˆ í›„ í™ˆìœ¼ë¡œ
        setTimeout(() => {
            window.location.href = '/';
        }, 1000);
    }
    
    function startSensorPolling() {
        console.log('[SENSOR] ì„¼ì„œ í´ë§ ì‹œì‘ ì „ í ë¹„ìš°ê¸°...');
        
        // ì„¼ì„œ í ë¹„ìš°ê¸° (ì´ì „ ì´ë²¤íŠ¸ ì œê±°)
        let clearCount = 0;
        function clearQueue() {
            fetch('/api/sensor/poll')
                .then(response => response.json())
                .then(data => {
                    if (data.has_events) {
                        clearCount++;
                        console.log(`[SENSOR] ì„¼ì„œ í ë¹„ìš°ê¸° ${clearCount}íšŒ (${data.count || 0}ê°œ ì œê±°)`);
                        if (clearCount < 10) {
                            clearQueue(); // ê³„ì† ë¹„ìš°ê¸°
                        } else {
                            startActualPolling();
                        }
                    } else {
                        console.log('[SENSOR] ì„¼ì„œ í ë¹„ìš°ê¸° ì™„ë£Œ');
                        startActualPolling();
                    }
                })
                .catch(error => {
                    console.error('[SENSOR] ì„¼ì„œ í ë¹„ìš°ê¸° ì˜¤ë¥˜:', error);
                    startActualPolling(); // ì˜¤ë¥˜ ë°œìƒí•´ë„ í´ë§ ì‹œì‘
                });
        }
        
        function startActualPolling() {
            console.log('[SENSOR] ì‹¤ì œ ì„¼ì„œ í´ë§ ì‹œì‘');
            sensorPollingInterval = setInterval(() => {
                fetch('/api/sensor/poll')
                    .then(response => response.json())
                    .then(data => {
                        if (data.has_events && data.events) {
                            console.log(`[SENSOR] ì„¼ì„œ ì´ë²¤íŠ¸ ${data.count || data.events.length}ê°œ ìˆ˜ì‹ :`, data.events);
                            data.events.forEach(event => {
                                handleSensorEvent(event);
                            });
                        }
                    })
                    .catch(error => {
                        // ì¡°ìš©íˆ ë¬´ì‹œ
                    });
            }, 500); // 500ms ê°„ê²©
        }
        
        // í ë¹„ìš°ê¸° ì‹œì‘
        clearQueue();
    }
    
    // ì„¼ì„œ í´ë§ ì¤‘ì§€
    function stopSensorPolling() {
        if (sensorPollingInterval) {
            clearInterval(sensorPollingInterval);
            sensorPollingInterval = null;
            console.log('[SENSOR] ì„¼ì„œ í´ë§ ì¤‘ì§€');
        }
    }
    
    function handleSensorEvent(event) {
        const sensorNum = event.sensor_num;
        const state = event.state;
        
        // ì„¼ì„œ ë²ˆí˜¸ë¡œ ë½ì»¤ ID ì¡°íšŒ
        fetch(`/api/sensors/${sensorNum}/locker`)
            .then(response => response.json())
            .then(lockerData => {
                if (!lockerData.success || !lockerData.locker_id) {
                    console.warn(`âš ï¸ ì„¼ì„œ ${sensorNum}ì— ë§¤í•‘ëœ ë½ì»¤ ì—†ìŒ`);
                    return;
                }
                
                const lockerId = lockerData.locker_id;
                const sensorKey = `${sensorNum}_${state}`;
                
                console.log(`[SENSOR] ì„¼ì„œ ${sensorNum} -> ë½ì»¤ ${lockerId}: ${state}`);
                
                // ëª¨ë“  ì„¼ì„œ ì´ë²¤íŠ¸ ë¡œê¹…
                logSensorEvent(lockerId, state);
                
                // HIGH ìƒíƒœë©´ processedSensors í´ë¦¬ì–´ (ì¬ì‹œë„ ê°€ëŠ¥)
                if (state === 'HIGH') {
                    const lowKey = `${sensorNum}-LOW`;
                    processedSensors.delete(lowKey);
                    console.log(`[SENSOR] ì„¼ì„œ ë¦¬ì…‹: ${lowKey} (ì¬ì‹œë„ ê°€ëŠ¥)`);
                }
                
                // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
                if (processedSensors.has(sensorKey)) {
                    console.log('[SENSOR] ì´ë¯¸ ì²˜ë¦¬í•œ ì´ë²¤íŠ¸:', sensorKey);
                    return;
                }
                processedSensors.add(sensorKey);
                
                // ë½ì»¤ ë²ˆí˜¸ í™”ë©´ì— í‘œì‹œ
                const detectedDiv = document.getElementById('lockerDetected');
                const detectedNumber = document.getElementById('detectedNumber');
                
                if (state === 'HIGH') {
                    // ë½ì»¤í‚¤ ì œê±°ë¨ (IR ì„¼ì„œ: HIGH = ë¬¼ì²´ ê°ì§€ ì•ˆ ë¨)
                    // ëŒ€ì—¬ ì•¡ì…˜ì´ë©´ ì•Œë¦¼ ì—†ì´ ë°”ë¡œ ëŒ€ì—¬ í”„ë¡œì„¸ìŠ¤ ì§„í–‰
                    if (actionType === 'rental') {
                        console.log('[RENTAL] ë½ì»¤í‚¤ ì œê±° ê°ì§€:', lockerId);
                        processRental(lockerId);
                    }
                } else if (state === 'LOW') {
                    // ë½ì»¤í‚¤ ì‚½ì…ë¨ (IR ì„¼ì„œ: LOW = ë¬¼ì²´ ê°ì§€ë¨)
                    // ë°˜ë‚© ì•¡ì…˜ì´ë©´ ì•Œë¦¼ í‘œì‹œ í›„ ë°˜ë‚© í”„ë¡œì„¸ìŠ¤ ì§„í–‰
                    detectedNumber.textContent = lockerId;
                    detectedDiv.classList.remove('hidden');
                    detectedDiv.classList.add('show');
                    
                    if (actionType === 'return') {
                        console.log('[RETURN] ë½ì»¤í‚¤ ì‚½ì… ê°ì§€:', lockerId);
                        processReturn(lockerId);
                    }
                }
            })
            .catch(error => {
                console.error(`[SENSOR] ì„¼ì„œ ${sensorNum} ë½ì»¤ ì¡°íšŒ ì˜¤ë¥˜:`, error);
            });
    }
    
    function logSensorEvent(lockerId, state) {
        fetch('/api/sensors/log', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                locker_id: lockerId,
                state: state,
                member_id: memberData.member_id,
                context: actionType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`[SENSOR] ì„¼ì„œ ì´ë²¤íŠ¸ ê¸°ë¡: ${lockerId} ${state}`);
            }
        })
        .catch(error => {
            console.error('[SENSOR] ì„¼ì„œ ì´ë²¤íŠ¸ ë¡œê¹… ì‹¤íŒ¨:', error);
        });
    }
    
    function processRental(lockerNumber) {
        console.log('[RENTAL] ëŒ€ì—¬ ì²˜ë¦¬ ì‹œì‘:', lockerNumber);
        
        // íƒ€ì„ì•„ì›ƒ ì·¨ì†Œ
        if (timeoutHandler) {
            clearTimeout(timeoutHandler);
        }
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // ì„¼ì„œ í´ë§ ì¤‘ì§€
        stopSensorPolling();
        
        document.getElementById('waitingSection').style.display = 'block';
        
        fetch('/api/rentals/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                member_id: memberData.member_id,
                locker_id: lockerNumber,
                action: 'rental'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('[RENTAL] ëŒ€ì—¬ ì²˜ë¦¬ ì™„ë£Œ:', data);
            
            if (data.success) {
                // ëŒ€ì—¬ ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = `/rental-complete?member_id=${memberData.member_id}&locker=${lockerNumber}`;
            } else {
                alert(data.error || 'ëŒ€ì—¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/error?message=' + encodeURIComponent(data.error);
            }
        })
        .catch(error => {
            console.error('[RENTAL] ëŒ€ì—¬ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            alert('ëŒ€ì—¬ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/error?message=' + encodeURIComponent(error);
        });
    }
    
    function processReturn(lockerNumber) {
        console.log('[RETURN] ë°˜ë‚© ì²˜ë¦¬ ì‹œì‘:', lockerNumber);
        
        document.getElementById('waitingSection').style.display = 'block';
        
        fetch('/api/rentals/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                member_id: memberData.member_id,
                locker_id: lockerNumber,
                action: 'return'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('[RETURN] ë°˜ë‚© ì²˜ë¦¬ ì™„ë£Œ:', data);
            
            if (data.success) {
                // ì„±ê³µ: ì„¼ì„œ í´ë§ ì¤‘ì§€, íƒ€ì´ë¨¸ ì •ë¦¬
                stopSensorPolling();
                if (timeoutHandler) {
                    clearTimeout(timeoutHandler);
                }
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                
                // ë°˜ë‚© ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = `/return-complete?member_id=${memberData.member_id}&locker=${lockerNumber}`;
            } else if (data.error_code === 'WRONG_LOCKER') {
                // ì˜ëª»ëœ ë½ì»¤: ê²½ê³ ë§Œ í‘œì‹œ, ì„¼ì„œëŠ” ê³„ì† ê°ì§€, íƒ€ì´ë¨¸ëŠ” ê³„ì† ì§„í–‰
                console.warn('[RETURN] ì˜ëª»ëœ ë½ì»¤:', data.message);
                
                // ê²½ê³  í‘œì‹œ
                showWrongLockerWarning(data.message);
                
                // 3ì´ˆ í›„ ê²½ê³ ë§Œ ìˆ¨ê¹€ (ì„¼ì„œëŠ” ê³„ì† ê°ì§€ ì¤‘)
                setTimeout(() => {
                    document.getElementById('waitingSection').style.display = 'none';
                }, 3000);
            } else {
                // ê¸°íƒ€ ì—ëŸ¬: ì„¼ì„œ í´ë§ ì¤‘ì§€, íƒ€ì´ë¨¸ ì •ë¦¬ í›„ ì—ëŸ¬ í˜ì´ì§€ë¡œ
                stopSensorPolling();
                if (timeoutHandler) {
                    clearTimeout(timeoutHandler);
                }
                if (timerInterval) {
                    clearInterval(timerInterval);
                }
                
                console.error('[RETURN] ë°˜ë‚© ì‹¤íŒ¨:', data.error);
                window.location.href = '/error?message=' + encodeURIComponent(data.error || 'ë°˜ë‚© ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        })
        .catch(error => {
            // API ì˜¤ë¥˜: ì„¼ì„œ í´ë§ ì¤‘ì§€, íƒ€ì´ë¨¸ ì •ë¦¬ í›„ ì—ëŸ¬ í˜ì´ì§€ë¡œ
            stopSensorPolling();
            if (timeoutHandler) {
                clearTimeout(timeoutHandler);
            }
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            console.error('[RETURN] ë°˜ë‚© API ì˜¤ë¥˜:', error);
            window.location.href = '/error?message=ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
        });
    }
    
    function showWrongLockerWarning(message) {
        const waitingSection = document.querySelector('.waiting-section');
        if (waitingSection) {
            waitingSection.style.display = 'block';
            waitingSection.innerHTML = `
                <div id="wrongLockerWarning" style="font-size: 1.8rem; font-weight: bold; margin-bottom: 15px; animation: blink 0.5s linear infinite;">
                    âš ï¸ ${message}
                </div>
                <div style="font-size: 1.3rem; color: white;">
                    ì˜¬ë°”ë¥¸ ë½ì»¤ì— ë‹¤ì‹œ ê½‚ì•„ì£¼ì„¸ìš”
                </div>
                <style>
                    @keyframes blink {
                        0%, 49% { color: #ff6b6b; opacity: 1; }
                        50%, 100% { color: #ff0000; opacity: 0.3; }
                    }
                </style>
            `;
        }
    }
    
    // ë‚ ì§œ/ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateDateTime() {
        const now = new Date();
        
        const dateString = now.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
        });
        document.getElementById('headerDate').textContent = dateString;
        
        const timeString = now.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        document.getElementById('headerTime').textContent = timeString;
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¬¸ ì—´ê¸°
    window.addEventListener('DOMContentLoaded', () => {
        const t_dom_ready = performance.now();
        console.log(`â±ï¸ [PERF] DOM Ready: ${(t_dom_ready - t_page_load).toFixed(2)}ms`);
        
        // ë‚ ì§œ/ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        openLockerDoor();
        startTimer(); // íƒ€ì´ë¨¸ ì‹œì‘
    });
    
    function openLockerDoor() {
        const t_door_start = performance.now();
        const zone = memberData.zone || 'MALE';
        console.log(`[DOOR] ${zone} êµ¬ì—­ ë½ì»¤ ë¬¸ ì—´ê¸° ëª…ë ¹ ì „ì†¡`);
        
        fetch('/api/locker/open-door', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                zone: zone
            })
        })
        .then(response => response.json())
        .then(data => {
            const t_door_end = performance.now();
            console.log(`â±ï¸ [PERF] ë¬¸ ì—´ê¸° ì™„ë£Œ: ${(t_door_end - t_door_start).toFixed(2)}ms`);
            console.log('[DOOR] ë¬¸ ì—´ê¸° ì‘ë‹µ:', data);
            
            if (data.success) {
                // ì„¼ì„œ í´ë§ ì‹œì‘
                startSensorPolling();
            } else {
                console.error('[DOOR] ë¬¸ ì—´ê¸° ì‹¤íŒ¨:', data.error);
            }
        })
        .catch(error => {
            console.error('[DOOR] ë¬¸ ì—´ê¸° ì˜¤ë¥˜:', error);
        });
    }
    
    // í˜ì´ì§€ ë– ë‚  ë•Œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
        stopSensorPolling();
        if (timeoutHandler) {
            clearTimeout(timeoutHandler);
        }
        if (timerInterval) {
            clearInterval(timerInterval);
        }
    });
</script>
{% endblock %}
