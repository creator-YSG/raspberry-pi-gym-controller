{% extends "layouts/base.html" %}

{% block title %}íšŒì› í™•ì¸{% endblock %}

{% block body_class %}member-check-page{% endblock %}

{% block content %}
<div class="member-check-container">
    <!-- ìƒë‹¨: íšŒì› ì •ë³´ -->
    <div class="member-info-section">
        <div class="check-icon">âœ…</div>
        <h1 class="status-title">íšŒì› ì¸ì¦ ì™„ë£Œ</h1>
        
        <div class="member-card">
            <div class="member-photo">
                {% if member.photo_url %}
                <img src="{{ member.photo_url }}" alt="{{ member.name }}">
                {% else %}
                <div class="member-avatar">ğŸ‘¤</div>
                {% endif %}
            </div>
            
            <div class="member-details">
                <div class="member-name">{{ member.name }}</div>
                <div class="member-id">íšŒì›ë²ˆí˜¸: {{ member.member_id }}</div>
                
                {% if member.get('member_category') == 'staff' %}
                <div class="member-badge badge-staff">ğŸ“ êµì§ì›</div>
                {% elif member.get('gender', '').lower() in ['m', 'male'] %}
                <div class="member-badge badge-male">ğŸ‘¨ ë‚¨ì„± íšŒì›</div>
                {% else %}
                <div class="member-badge badge-female">ğŸ‘© ì—¬ì„± íšŒì›</div>
                {% endif %}
                
                <div class="expiry-info">
                    <span class="expiry-label">ë§Œë£Œì¼:</span>
                    <span class="expiry-date {% if member.is_expired %}expired{% endif %}">
                        {{ member.expiry_date }}
                        {% if member.days_remaining and member.days_remaining > 0 and member.days_remaining <= 7 %}
                        ({{ member.days_remaining }}ì¼ ë‚¨ìŒ)
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- ì¤‘ê°„: ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div class="instruction-section">
        {% if action == 'rental' %}
        <div class="door-status">
            <div class="door-icon">ğŸšª</div>
            <p class="door-message">ë½ì»¤ ë¬¸ì´ ì—´ë ¸ìŠµë‹ˆë‹¤</p>
        </div>
        <div class="instruction-message">
            <div class="instruction-icon">ğŸ—ï¸</div>
            <p class="instruction-text">ì›í•˜ëŠ” ë½ì»¤í‚¤ë¥¼ ê°€ì ¸ê°€ì„¸ìš”</p>
            <p class="instruction-sub">ì„¼ì„œê°€ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤</p>
        </div>
        {% else %}
        <div class="door-status">
            <div class="door-icon">ğŸšª</div>
            <p class="door-message">ë½ì»¤ ë¬¸ì´ ì—´ë ¸ìŠµë‹ˆë‹¤</p>
        </div>
        <div class="instruction-message">
            <div class="instruction-icon">ğŸ”‘</div>
            <p class="instruction-text">ë½ì»¤í‚¤ë¥¼ ì œìë¦¬ì— ê½‚ì•„ì£¼ì„¸ìš”</p>
            <p class="instruction-sub">ì„¼ì„œê°€ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤</p>
        </div>
        {% endif %}
    </div>

    <!-- í•˜ë‹¨: ëŒ€ê¸° ì¤‘ í‘œì‹œ -->
    <div class="waiting-section">
        <div class="waiting-spinner">
            <div class="spinner"></div>
        </div>
        <p class="waiting-text">ë½ì»¤ ì„ íƒì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
    </div>

    <!-- í˜„ì¬ ê°ì§€ëœ ë½ì»¤ ë²ˆí˜¸ (ì„¼ì„œ ì´ë²¤íŠ¸ë¡œ í‘œì‹œ) -->
    <div class="locker-detected hidden" id="lockerDetected">
        <div class="detected-icon">ğŸ¯</div>
        <div class="detected-number" id="detectedNumber"></div>
    </div>
</div>

<!-- ìˆ¨ê²¨ì§„ ë°ì´í„° -->
<div id="memberData" 
     data-member-id="{{ member.member_id }}"
     data-action="{{ action }}"
     data-zone="{{ member.zone }}"
     style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
let memberData = null;
let pollingInterval = null;
let processedSensors = new Set(); // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€

document.addEventListener('DOMContentLoaded', function() {
    // íšŒì› ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const dataElement = document.getElementById('memberData');
    memberData = {
        memberId: dataElement.dataset.memberId,
        action: dataElement.dataset.action,
        zone: dataElement.dataset.zone
    };
    
    console.log('ğŸ‘¤ íšŒì› í™•ì¸ í™”ë©´:', memberData);
    
    // ë½ì»¤ ë¬¸ ì—´ê¸°
    openLockerDoor(memberData.zone);
    
    // ì„¼ì„œ í´ë§ ì‹œì‘
    startSensorPolling();
    
    // 30ì´ˆ íƒ€ì„ì•„ì›ƒ (ì•„ë¬´ ë™ì‘ ì—†ìœ¼ë©´ í™ˆìœ¼ë¡œ)
    setTimeout(function() {
        console.log('â±ï¸ íƒ€ì„ì•„ì›ƒ: í™ˆìœ¼ë¡œ ì´ë™');
        stopSensorPolling();
        goHome();
    }, 30000);
});

// ì„¼ì„œ í´ë§ ì‹œì‘ (500ms ê°„ê²©ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì²´í¬)
function startSensorPolling() {
    console.log('ğŸ”„ ì„¼ì„œ í´ë§ ì‹œì‘ ì „ í ë¹„ìš°ê¸°...');
    
    // ì„¼ì„œ í ë¹„ìš°ê¸° (ì´ì „ ì´ë²¤íŠ¸ ì œê±°)
    let clearCount = 0;
    function clearQueue() {
        fetch('/api/sensor/poll')
            .then(response => response.json())
            .then(data => {
                if (data.has_events) {
                    clearCount++;
                    console.log(`ğŸ—‘ï¸ ì„¼ì„œ í ë¹„ìš°ê¸° ${clearCount}íšŒ (${data.count}ê°œ ì œê±°)`);
                    if (clearCount < 10) {
                        clearQueue(); // ê³„ì† ë¹„ìš°ê¸°
                    } else {
                        startActualPolling();
                    }
                } else {
                    console.log('âœ… ì„¼ì„œ í ë¹„ìš°ê¸° ì™„ë£Œ');
                    startActualPolling();
                }
            })
            .catch(error => {
                console.error('ì„¼ì„œ í ë¹„ìš°ê¸° ì˜¤ë¥˜:', error);
                startActualPolling(); // ì˜¤ë¥˜ ë°œìƒí•´ë„ í´ë§ ì‹œì‘
            });
    }
    
    function startActualPolling() {
        console.log('ğŸ”„ ì‹¤ì œ ì„¼ì„œ í´ë§ ì‹œì‘');
        pollingInterval = setInterval(function() {
            fetch('/api/sensor/poll')
                .then(response => response.json())
                .then(data => {
                    if (data.has_events && data.events) {
                        console.log(`ğŸ“¥ ì„¼ì„œ ì´ë²¤íŠ¸ ${data.count}ê°œ ìˆ˜ì‹ :`, data.events);
                        data.events.forEach(event => {
                            handleSensorEvent(event);
                        });
                    }
                })
                .catch(error => {
                    // ì¡°ìš©íˆ ë¬´ì‹œ (ë„ˆë¬´ ë§ì€ ë¡œê·¸ ë°©ì§€)
                });
        }, 500); // 500ms ê°„ê²© (ë¹ ë¥¸ ì‘ë‹µ)
    }
    
    // í ë¹„ìš°ê¸° ì‹œì‘
    clearQueue();
}

// ì„¼ì„œ í´ë§ ì¤‘ì§€
function stopSensorPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('â¹ï¸ ì„¼ì„œ í´ë§ ì¤‘ì§€');
    }
}

// ì„¼ì„œ ì´ë²¤íŠ¸ ì²˜ë¦¬
function handleSensorEvent(data) {
    const sensorNum = data.sensor_num;
    const state = data.state;
    
    // ì„¼ì„œ ë²ˆí˜¸ë¡œ ë½ì»¤ ID ì¡°íšŒ
    fetch(`/api/sensors/${sensorNum}/locker`)
        .then(response => response.json())
        .then(lockerData => {
            if (!lockerData.success || !lockerData.locker_id) {
                console.warn(`âš ï¸ ì„¼ì„œ ${sensorNum}ì— ë§¤í•‘ëœ ë½ì»¤ ì—†ìŒ`);
                return;
            }
            
            const lockerId = lockerData.locker_id;
            console.log(`ğŸ” ì„¼ì„œ ${sensorNum} -> ë½ì»¤ ${lockerId}: ${state}`);
            
            // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ (ê°™ì€ ì„¼ì„œì˜ ê°™ì€ ìƒíƒœëŠ” í•œ ë²ˆë§Œ)
            const eventKey = `${sensorNum}-${state}`;
            if (processedSensors.has(eventKey)) {
                console.log(`â­ï¸ ì´ë¯¸ ì²˜ë¦¬ëœ ì´ë²¤íŠ¸: ${eventKey}`);
                return;
            }
            processedSensors.add(eventKey);
            
            // ë½ì»¤ ë²ˆí˜¸ í™”ë©´ì— í‘œì‹œ
            const detectedDiv = document.getElementById('lockerDetected');
            const detectedNumber = document.getElementById('detectedNumber');
            
            if (state === 'HIGH') {
                // ë½ì»¤í‚¤ ì œê±°ë¨ (IR ì„¼ì„œ: HIGH = ë¬¼ì²´ ê°ì§€ ì•ˆ ë¨)
                detectedNumber.textContent = lockerId;
                detectedDiv.classList.remove('hidden');
                detectedDiv.classList.add('show');
                
                // ëŒ€ì—¬ ì•¡ì…˜ì´ë©´ ëŒ€ì—¬ í”„ë¡œì„¸ìŠ¤ ì§„í–‰
                if (memberData.action === 'rental') {
                    stopSensorPolling(); // í´ë§ ì¤‘ì§€
                    processRental(lockerId);
                }
            } else if (state === 'LOW') {
                // ë½ì»¤í‚¤ ì‚½ì…ë¨ (IR ì„¼ì„œ: LOW = ë¬¼ì²´ ê°ì§€ë¨)
                detectedNumber.textContent = lockerId;
                detectedDiv.classList.remove('hidden');
                detectedDiv.classList.add('show');
                
                // ë°˜ë‚© ì•¡ì…˜ì´ë©´ ë°˜ë‚© í”„ë¡œì„¸ìŠ¤ ì§„í–‰
                if (memberData.action === 'return') {
                    stopSensorPolling(); // í´ë§ ì¤‘ì§€
                    processReturn(lockerId);
                }
            }
        })
        .catch(error => {
            console.error(`âŒ ì„¼ì„œ ${sensorNum} ë½ì»¤ ì¡°íšŒ ì˜¤ë¥˜:`, error);
        });
}

// ëŒ€ì—¬ í”„ë¡œì„¸ìŠ¤
function processRental(lockerId) {
    console.log('ğŸ”‘ ëŒ€ì—¬ í”„ë¡œì„¸ìŠ¤ ì‹œì‘:', lockerId);
    
    fetch('/api/rentals/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberData.memberId,
            locker_id: lockerId,
            action: 'rental'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('âœ… ëŒ€ì—¬ ì„±ê³µ');
            setTimeout(function() {
                navigateToComplete('rental', lockerId);
            }, 1000);
        } else {
            console.error('âŒ ëŒ€ì—¬ ì‹¤íŒ¨:', data.error);
            navigateToError('rental_failed', data.error);
        }
    })
    .catch(error => {
        console.error('âŒ ëŒ€ì—¬ API ì˜¤ë¥˜:', error);
        navigateToError('system_error', 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ë°˜ë‚© í”„ë¡œì„¸ìŠ¤
function processReturn(lockerId) {
    console.log('ğŸ”“ ë°˜ë‚© í”„ë¡œì„¸ìŠ¤ ì‹œì‘:', lockerId);
    
    fetch('/api/rentals/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberData.memberId,
            locker_id: lockerId,
            action: 'return'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('âœ… ë°˜ë‚© ì„±ê³µ');
            setTimeout(function() {
                navigateToComplete('return', lockerId);
            }, 1000);
        } else {
            console.error('âŒ ë°˜ë‚© ì‹¤íŒ¨:', data.error);
            navigateToError('return_failed', data.error);
        }
    })
    .catch(error => {
        console.error('âŒ ë°˜ë‚© API ì˜¤ë¥˜:', error);
        navigateToError('system_error', 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì™„ë£Œ í™”ë©´ìœ¼ë¡œ ì´ë™
function navigateToComplete(action, lockerId) {
    const url = `/${action}-complete?locker_id=${lockerId}`;
    window.location.href = url;
}

// ì—ëŸ¬ í™”ë©´ìœ¼ë¡œ ì´ë™
function navigateToError(errorType, message) {
    const url = `/error?type=${errorType}&message=${encodeURIComponent(message)}`;
    window.location.href = url;
}

// í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
function goHome() {
    window.location.href = '/';
}

// ë½ì»¤ ë¬¸ ì—´ê¸°
function openLockerDoor(zone) {
    console.log(`ğŸšª ${zone} êµ¬ì—­ ë¬¸ ì—´ê¸° ìš”ì²­`);
    
    fetch('/api/locker/open-door', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ zone: zone })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log(`âœ… ${zone} êµ¬ì—­ ë¬¸ ì—´ê¸° ì„±ê³µ:`, data.message);
        } else {
            console.error(`âŒ ${zone} êµ¬ì—­ ë¬¸ ì—´ê¸° ì‹¤íŒ¨:`, data.error);
        }
    })
    .catch(error => {
        console.error('âŒ ë¬¸ ì—´ê¸° API ì˜¤ë¥˜:', error);
    });
}
</script>
{% endblock %}

