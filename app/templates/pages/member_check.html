{% extends "layouts/base.html" %}

{% block title %}회원 확인{% endblock %}

{% block body_class %}member-check-page{% endblock %}

{% block content %}
<div class="member-check-container">
    <!-- 상단: 날짜/시간/상태 -->
    <div class="datetime-header">
        <div class="datetime-info">
            <div class="header-date" id="headerDate"></div>
            <div class="header-time" id="headerTime"></div>
        </div>
        <div class="header-status">
            <span class="status-dot">●</span>
        </div>
    </div>

    <!-- 인사말 -->
    <div class="greeting-section">
        <h1 class="greeting-text">반갑습니다!</h1>
    </div>

    <!-- 중앙: 회원 정보 (세로로) -->
    <div class="member-info-vertical">
        <!-- 이메일 님 -->
        <div class="info-row">
            <div class="info-value-large">
                {% if member.email %}
                    {{ member.email.split('@')[0] }}
                {% else %}
                    회원
                {% endif %}
                <span class="info-suffix">님</span>
            </div>
        </div>
        
        <!-- 남은 일수 (가장 크게) -->
        <div class="info-row days-row">
            <div class="info-value-huge">
                {% if member.days_remaining is not none %}
                    <span class="days-number-huge">{{ member.days_remaining }}</span>
                    <span class="days-unit">일 남음</span>
                {% else %}
                    <span class="days-number-huge">-</span>
                    <span class="days-unit">일 남음</span>
                {% endif %}
            </div>
        </div>
        
        <!-- 종료일자 -->
        <div class="info-row">
            <div class="info-value-medium">
                종료일: 
                {% if member.expiry_date and member.expiry_date != 'None' %}
                    {{ member.expiry_date }}
                {% else %}
                    -
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 하단: 프로세스 안내 + 타이머 -->
    <div class="process-message-with-timer">
        {% if action == 'rental' %}
        <div class="key-icon rental-key"></div>
        <div class="process-text">대여할 락커키를 선택해주세요</div>
        {% else %}
        <div class="key-icon return-key"></div>
        <div class="process-text" id="returnMessage">
            {% if member.current_locker %}
            <strong style="color: #4caf50; font-size: 2.2rem;">{{ member.current_locker }}번</strong> 락커에<br>
            키를 꽂아주세요
            {% else %}
            락커키를 제자리에 꽂아주세요
            {% endif %}
        </div>
        {% endif %}
        
        <!-- 타이머 -->
        <div class="timer-display">
            <span class="timer-number" id="timerNumber">20</span>
            <span class="timer-unit">초</span>
        </div>
    </div>
    
    <!-- 락커 감지 표시 -->
    <div class="locker-detected hidden" id="lockerDetected">
        <div class="detected-icon">🎯</div>
        <div class="detected-number" id="detectedNumber"></div>
    </div>

    <!-- 대기 중 표시 (숨김) -->
    <div class="waiting-section" id="waitingSection" style="display: none;">
        <div class="waiting-spinner">
            <div class="spinner"></div>
        </div>
        <p class="waiting-text">처리 중...</p>
    </div>
</div>

<script>
    const memberData = {{ member | tojson | safe }};
    const actionType = '{{ action }}';
    
    console.log('[MEMBER_CHECK] 페이지 로드:', {
        member_id: memberData.member_id,
        action: actionType
    });
    
    // 성능 측정
    const t_page_load = performance.now();
    
    // 센서 폴링
    let sensorPollingInterval = null;
    let processedSensors = new Set(); // 중복 처리 방지
    let timeoutHandler = null;
    let timerInterval = null;
    let remainingSeconds = 20;
    
    // 타이머 시작
    function startTimer() {
        const timerElement = document.getElementById('timerNumber');
        
        timerInterval = setInterval(() => {
            remainingSeconds--;
            timerElement.textContent = remainingSeconds;
            
            // 5초 이하면 빨간색으로
            if (remainingSeconds <= 5) {
                timerElement.style.color = '#ff6b6b';
            }
            
            if (remainingSeconds <= 0) {
                clearInterval(timerInterval);
            }
        }, 1000);
    }
    
    // 20초 타임아웃 설정
    timeoutHandler = setTimeout(() => {
        console.log('[TIMEOUT] 20초 타임아웃 - 문 닫고 홈으로');
        closeDoorAndGoHome();
    }, 20000);
    
    function closeDoorAndGoHome() {
        // 타이머 정리
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // 타임아웃 기록 API 호출
        fetch('/api/rentals/timeout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                member_id: memberData.member_id
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('[TIMEOUT] 타임아웃 기록 완료:', data);
        })
        .catch(error => {
            console.error('[TIMEOUT] 타임아웃 기록 실패:', error);
        });
        
        // 문 닫기 명령
        fetch('/api/hardware/motor_move', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                revs: -0.917,
                rpm: 30
            })
        });
        
        // 1초 후 홈으로
        setTimeout(() => {
            window.location.href = '/';
        }, 1000);
    }
    
    function startSensorPolling() {
        console.log('[SENSOR] 센서 폴링 시작 전 큐 비우기...');
        
        // 센서 큐 비우기 (이전 이벤트 제거)
        let clearCount = 0;
        function clearQueue() {
            fetch('/api/sensor/poll')
                .then(response => response.json())
                .then(data => {
                    if (data.has_events) {
                        clearCount++;
                        console.log(`[SENSOR] 센서 큐 비우기 ${clearCount}회 (${data.count || 0}개 제거)`);
                        if (clearCount < 10) {
                            clearQueue(); // 계속 비우기
                        } else {
                            startActualPolling();
                        }
                    } else {
                        console.log('[SENSOR] 센서 큐 비우기 완료');
                        startActualPolling();
                    }
                })
                .catch(error => {
                    console.error('[SENSOR] 센서 큐 비우기 오류:', error);
                    startActualPolling(); // 오류 발생해도 폴링 시작
                });
        }
        
        function startActualPolling() {
            console.log('[SENSOR] 실제 센서 폴링 시작');
            sensorPollingInterval = setInterval(() => {
                fetch('/api/sensor/poll')
                    .then(response => response.json())
                    .then(data => {
                        if (data.has_events && data.events) {
                            console.log(`[SENSOR] 센서 이벤트 ${data.count || data.events.length}개 수신:`, data.events);
                            data.events.forEach(event => {
                                handleSensorEvent(event);
                            });
                        }
                    })
                    .catch(error => {
                        // 조용히 무시
                    });
            }, 500); // 500ms 간격
        }
        
        // 큐 비우기 시작
        clearQueue();
    }
    
    // 센서 폴링 중지
    function stopSensorPolling() {
        if (sensorPollingInterval) {
            clearInterval(sensorPollingInterval);
            sensorPollingInterval = null;
            console.log('[SENSOR] 센서 폴링 중지');
        }
    }
    
    function handleSensorEvent(event) {
        const sensorNum = event.sensor_num;
        const state = event.state;
        
        // 센서 번호로 락커 ID 조회
        fetch(`/api/sensors/${sensorNum}/locker`)
            .then(response => response.json())
            .then(lockerData => {
                if (!lockerData.success || !lockerData.locker_id) {
                    console.warn(`⚠️ 센서 ${sensorNum}에 매핑된 락커 없음`);
                    return;
                }
                
                const lockerId = lockerData.locker_id;
                const sensorKey = `${sensorNum}_${state}`;
                
                console.log(`[SENSOR] 센서 ${sensorNum} -> 락커 ${lockerId}: ${state}`);
                
                // 모든 센서 이벤트 로깅
                logSensorEvent(lockerId, state);
                
                // HIGH 상태면 processedSensors 클리어 (재시도 가능)
                if (state === 'HIGH') {
                    const lowKey = `${sensorNum}-LOW`;
                    processedSensors.delete(lowKey);
                    console.log(`[SENSOR] 센서 리셋: ${lowKey} (재시도 가능)`);
                }
                
                // 중복 처리 방지
                if (processedSensors.has(sensorKey)) {
                    console.log('[SENSOR] 이미 처리한 이벤트:', sensorKey);
                    return;
                }
                processedSensors.add(sensorKey);
                
                // 락커 번호 화면에 표시
                const detectedDiv = document.getElementById('lockerDetected');
                const detectedNumber = document.getElementById('detectedNumber');
                
                if (state === 'HIGH') {
                    // 락커키 제거됨 (IR 센서: HIGH = 물체 감지 안 됨)
                    detectedNumber.textContent = lockerId;
                    detectedDiv.classList.remove('hidden');
                    detectedDiv.classList.add('show');
                    
                    // 대여 액션이면 대여 프로세스 진행
                    if (actionType === 'rental') {
                        console.log('[RENTAL] 락커키 제거 감지:', lockerId);
                        processRental(lockerId);
                    }
                } else if (state === 'LOW') {
                    // 락커키 삽입됨 (IR 센서: LOW = 물체 감지됨)
                    detectedNumber.textContent = lockerId;
                    detectedDiv.classList.remove('hidden');
                    detectedDiv.classList.add('show');
                    
                    // 반납 액션이면 반납 프로세스 진행
                    if (actionType === 'return') {
                        console.log('[RETURN] 락커키 삽입 감지:', lockerId);
                        processReturn(lockerId);
                    }
                }
            })
            .catch(error => {
                console.error(`[SENSOR] 센서 ${sensorNum} 락커 조회 오류:`, error);
            });
    }
    
    function logSensorEvent(lockerId, state) {
        fetch('/api/sensors/log', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                locker_id: lockerId,
                state: state,
                member_id: memberData.member_id,
                context: actionType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`[SENSOR] 센서 이벤트 기록: ${lockerId} ${state}`);
            }
        })
        .catch(error => {
            console.error('[SENSOR] 센서 이벤트 로깅 실패:', error);
        });
    }
    
    function processRental(lockerNumber) {
        console.log('[RENTAL] 대여 처리 시작:', lockerNumber);
        
        // 타임아웃 취소
        if (timeoutHandler) {
            clearTimeout(timeoutHandler);
        }
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // 센서 폴링 중지
        stopSensorPolling();
        
        document.getElementById('waitingSection').style.display = 'block';
        
        fetch('/api/rentals/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                member_id: memberData.member_id,
                locker_id: lockerNumber,
                action: 'rental'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('[RENTAL] 대여 처리 완료:', data);
            
            if (data.success) {
                // 대여 완료 페이지로 이동
                window.location.href = `/rental-complete?member_id=${memberData.member_id}&locker=${lockerNumber}`;
            } else {
                alert(data.error || '대여 처리 중 오류가 발생했습니다.');
                window.location.href = '/error?message=' + encodeURIComponent(data.error);
            }
        })
        .catch(error => {
            console.error('[RENTAL] 대여 처리 오류:', error);
            alert('대여 처리 중 오류가 발생했습니다.');
            window.location.href = '/error?message=' + encodeURIComponent(error);
        });
    }
    
    function processReturn(lockerNumber) {
        console.log('[RETURN] 반납 처리 시작:', lockerNumber);
        
        // 타임아웃 취소
        if (timeoutHandler) {
            clearTimeout(timeoutHandler);
        }
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // 센서 폴링 중지
        stopSensorPolling();
        
        document.getElementById('waitingSection').style.display = 'block';
        
        fetch('/api/rentals/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                member_id: memberData.member_id,
                locker_id: lockerNumber,
                action: 'return'
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('[RETURN] 반납 처리 완료:', data);
            
            if (data.success) {
                // 반납 완료 페이지로 이동
                window.location.href = `/return-complete?member_id=${memberData.member_id}&locker=${lockerNumber}`;
            } else if (data.error_code === 'WRONG_LOCKER') {
                // 잘못된 락커에 삽입 - 경고만 표시하고 재시도 허용
                console.warn('[RETURN] 잘못된 락커:', data.message);
                showWrongLockerWarning(data.message);
                
                // processedSensors 클리어하고 폴링 재시작
                processedSensors.clear();
                startSensorPolling();
                
                document.getElementById('waitingSection').style.display = 'none';
            } else {
                console.error('[RETURN] 반납 실패:', data.error);
                window.location.href = '/error?message=' + encodeURIComponent(data.error || '반납 처리 중 오류가 발생했습니다');
            }
        })
        .catch(error => {
            console.error('[RETURN] 반납 API 오류:', error);
            window.location.href = '/error?message=시스템 오류가 발생했습니다';
        });
    }
    
    function showWrongLockerWarning(message) {
        const waitingSection = document.querySelector('.waiting-section');
        if (waitingSection) {
            waitingSection.style.display = 'block';
            waitingSection.innerHTML = `
                <div style="color: #ff6b6b; font-size: 1.8rem; font-weight: bold; margin-bottom: 15px;">
                    ⚠️ ${message}
                </div>
                <div style="font-size: 1.3rem; color: white;">
                    올바른 락커에 다시 꽂아주세요
                </div>
            `;
        }
    }
    
    // 날짜/시간 업데이트
    function updateDateTime() {
        const now = new Date();
        
        const dateString = now.toLocaleDateString('ko-KR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
        });
        document.getElementById('headerDate').textContent = dateString;
        
        const timeString = now.toLocaleTimeString('ko-KR', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        document.getElementById('headerTime').textContent = timeString;
    }
    
    // 페이지 로드 시 문 열기
    window.addEventListener('DOMContentLoaded', () => {
        const t_dom_ready = performance.now();
        console.log(`⏱️ [PERF] DOM Ready: ${(t_dom_ready - t_page_load).toFixed(2)}ms`);
        
        // 날짜/시간 업데이트 시작
        updateDateTime();
        setInterval(updateDateTime, 1000);
        
        openLockerDoor();
        startTimer(); // 타이머 시작
    });
    
    function openLockerDoor() {
        const t_door_start = performance.now();
        const zone = memberData.zone || 'MALE';
        console.log(`[DOOR] ${zone} 구역 락커 문 열기 명령 전송`);
        
        fetch('/api/locker/open-door', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                zone: zone
            })
        })
        .then(response => response.json())
        .then(data => {
            const t_door_end = performance.now();
            console.log(`⏱️ [PERF] 문 열기 완료: ${(t_door_end - t_door_start).toFixed(2)}ms`);
            console.log('[DOOR] 문 열기 응답:', data);
            
            if (data.success) {
                // 센서 폴링 시작
                startSensorPolling();
            } else {
                console.error('[DOOR] 문 열기 실패:', data.error);
            }
        })
        .catch(error => {
            console.error('[DOOR] 문 열기 오류:', error);
        });
    }
    
    // 페이지 떠날 때 정리
    window.addEventListener('beforeunload', () => {
        stopSensorPolling();
        if (timeoutHandler) {
            clearTimeout(timeoutHandler);
        }
        if (timerInterval) {
            clearInterval(timerInterval);
        }
    });
</script>
{% endblock %}
