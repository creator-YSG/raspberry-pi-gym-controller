{% extends "layouts/base.html" %}

{% block title %}ESP32 í•˜ë“œì›¨ì–´ í…ŒìŠ¤íŠ¸{% endblock %}

{% block body_class %}hardware-test-page{% endblock %}

{% block content %}
<style>
    .hardware-test-container {
        padding: 15px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: 'Noto Sans KR', sans-serif;
        gap: 15px;
        box-sizing: border-box;
    }

    /* ìƒë‹¨ ëª¨í„° í…ŒìŠ¤íŠ¸ ì˜ì—­ (50%) */
    .motor-test-section {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        flex-direction: column;
    }

    .section-title {
        font-size: 1.3em;
        font-weight: bold;
        margin-bottom: 20px;
        color: #ffffff;
        text-align: center;
    }

    .motor-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
    }

    .motor-btn {
        padding: 20px;
        border: none;
        border-radius: 12px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .motor-btn-icon {
        font-size: 1.5em;
    }

    .motor-btn-forward {
        background: linear-gradient(45deg, #4CAF50, #66BB6A);
    }

    .motor-btn-reverse {
        background: linear-gradient(45deg, #2196F3, #42A5F5);
    }

    .motor-btn-auto {
        background: linear-gradient(45deg, #FF9800, #FFB74D);
        grid-column: span 2;
    }

    .motor-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }

    .motor-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .motor-status {
        flex: 1;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        max-height: 150px;
        overflow-y: auto;
        color: #E0E0E0;
    }

    /* í•˜ë‹¨ ì„¼ì„œ ìƒíƒœ ì˜ì—­ (50%) */
    .sensor-status-section {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        flex-direction: column;
    }

    .sensor-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 15px;
        margin-top: 20px;
        flex: 1;
    }

    .sensor-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        border: 2px solid rgba(255, 255, 255, 0.2);
        font-size: 1em;
        font-weight: bold;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 5px;
        transition: all 0.3s ease;
        position: relative;
    }

    .sensor-number {
        font-size: 1.3em;
        margin-bottom: 5px;
    }

    .sensor-status {
        font-size: 0.8em;
        opacity: 0.8;
    }

    .sensor-connected {
        background: rgba(46, 125, 50, 0.3);
        border-color: #4CAF50;
    }

    .sensor-disconnected {
        background: rgba(158, 158, 158, 0.3);
        border-color: #9E9E9E;
        color: #BDBDBD;
    }

    .sensor-triggered {
        background: rgba(244, 67, 54, 0.8) !important;
        border-color: #F44336 !important;
        box-shadow: 0 0 20px rgba(244, 67, 54, 0.6);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .sensor-count {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #FF5722;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 0.7em;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .loading {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px 40px;
        border-radius: 10px;
        z-index: 1000;
    }

    .home-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(158, 158, 158, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 1.2em;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 100;
    }

    .home-btn:hover {
        background: rgba(158, 158, 158, 1);
        transform: scale(1.1);
    }

    .log-entry {
        margin-bottom: 5px;
        padding: 3px 6px;
        border-radius: 3px;
        font-size: 0.8em;
    }

    .log-success {
        background: rgba(76, 175, 80, 0.3);
        color: #A5D6A7;
    }

    .log-error {
        background: rgba(244, 67, 54, 0.3);
        color: #EF9A9A;
    }

    .log-info {
        background: rgba(33, 150, 243, 0.3);
        color: #90CAF9;
    }
</style>

<div class="hardware-test-container">
    <!-- í™ˆ ë²„íŠ¼ -->
    <button class="home-btn" onclick="goHome()">ğŸ </button>
    
    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loading" class="loading">ì²˜ë¦¬ ì¤‘...</div>
    
    <!-- ìƒë‹¨: ëª¨í„° í…ŒìŠ¤íŠ¸ ì˜ì—­ -->
    <div class="motor-test-section">
        <div class="section-title">âš™ï¸ ëª¨í„° ì œì–´ í…ŒìŠ¤íŠ¸</div>
        
        <div class="motor-controls">
            <button class="motor-btn motor-btn-forward" onclick="rotateMotor330()">
                <div class="motor-btn-icon">ğŸ”„</div>
                <div>330ë„ íšŒì „</div>
            </button>
            
            <button class="motor-btn motor-btn-reverse" onclick="rotateMotorReverse()">
                <div class="motor-btn-icon">â†©ï¸</div>
                <div>ì›ìœ„ì¹˜ ë³µê·€</div>
            </button>
            
            <button class="motor-btn motor-btn-auto" onclick="toggleAutoMode()" id="autoModeBtn">
                <div class="motor-btn-icon">ğŸ¤–</div>
                <div id="autoModeText">ìë™ëª¨ë“œ í™œì„±í™”</div>
            </button>
        </div>
        
        <div class="motor-controls" style="margin-top: 10px;">
            <button class="motor-btn" style="background: linear-gradient(45deg, #9C27B0, #BA68C8); grid-column: span 2;" onclick="testSensorTrigger()">
                <div class="motor-btn-icon">ğŸ§ª</div>
                <div>ì„¼ì„œ í…ŒìŠ¤íŠ¸ (ì„¼ì„œ1 íŠ¸ë¦¬ê±°)</div>
            </button>
        </div>
        
        <div class="motor-status" id="motorLog">
            <div class="log-entry log-info">ëª¨í„° ì œì–´ ì‹œìŠ¤í…œ ì¤€ë¹„ë¨</div>
        </div>
    </div>
    
    <!-- í•˜ë‹¨: ì„¼ì„œ ìƒíƒœ ì˜ì—­ -->
    <div class="sensor-status-section">
        <div class="section-title">ğŸ“¡ ì„¼ì„œ ìƒíƒœ ëª¨ë‹ˆí„°ë§ (ì‹¤ì‹œê°„)</div>
        
        <div class="sensor-grid">
            <!-- ì„¼ì„œ 1-10ë²ˆ -->
            <div class="sensor-item sensor-disconnected" id="sensor1">
                <div class="sensor-number">1</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count1" style="display: none;">0</div>
            </div>
            <div class="sensor-item sensor-disconnected" id="sensor2">
                <div class="sensor-number">2</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count2" style="display: none;">0</div>
            </div>
            <div class="sensor-item sensor-disconnected" id="sensor3">
                <div class="sensor-number">3</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count3" style="display: none;">0</div>
            </div>
            <div class="sensor-item sensor-disconnected" id="sensor4">
                <div class="sensor-number">4</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count4" style="display: none;">0</div>
            </div>
            <div class="sensor-item sensor-disconnected" id="sensor5">
                <div class="sensor-number">5</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count5" style="display: none;">0</div>
            </div>
            <div class="sensor-item sensor-disconnected" id="sensor6">
                <div class="sensor-number">6</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count6" style="display: none;">0</div>
            </div>
            <div class="sensor-item sensor-disconnected" id="sensor7">
                <div class="sensor-number">7</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count7" style="display: none;">0</div>
            </div>
            <div class="sensor-item sensor-disconnected" id="sensor8">
                <div class="sensor-number">8</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count8" style="display: none;">0</div>
            </div>
            <div class="sensor-item sensor-disconnected" id="sensor9">
                <div class="sensor-number">9</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count9" style="display: none;">0</div>
            </div>
            <div class="sensor-item sensor-disconnected" id="sensor10">
                <div class="sensor-number">10</div>
                <div class="sensor-status">ì—°ê²° ì•ˆë¨</div>
                <div class="sensor-count" id="count10" style="display: none;">0</div>
            </div>
        </div>
    </div>
</div>

<script>
// ì „ì—­ ë³€ìˆ˜
let eventSource = null;
let autoModeEnabled = false;
let sensorCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0};
let sensorTimers = {};

// ì‹¤ì œ ë¡œê·¸ì—ì„œ í™•ì¸ëœ ì—°ê²° ì„¼ì„œë“¤ (4,7,8,9ë²ˆ ë“±)
const connectedSensors = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // ì—°ê²°ëœ ì„¼ì„œ ìƒíƒœ ë¨¼ì € ì„¤ì •
    initializeSensorStates();
    
    // ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ì—°ê²° ì‹œì‘
    initializeEventStream();
});

// ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ ì´ˆê¸°í™”
function initializeEventStream() {
    try {
        addMotorLog('ğŸ”„ ì‹¤ì‹œê°„ ì„¼ì„œ ëª¨ë‹ˆí„°ë§ ì‹œì‘', 'info');
        
        // 1. ìƒˆë¡œìš´ ì´ë²¤íŠ¸ í™•ì¸ (1ì´ˆë§ˆë‹¤)
        setInterval(async function() {
            try {
                const response = await fetch('/api/hardware/sensor_events');
                if (response.ok) {
                    const events = await response.json();
                    if (events.length > 0) {
                        console.log('ğŸ”¥ [ì´ë²¤íŠ¸] ì„¼ì„œ ì´ë²¤íŠ¸ ìˆ˜ì‹ :', events.length, 'ê°œ');
                        events.forEach(event => {
                            console.log('ğŸ”¥ [ì´ë²¤íŠ¸] ì´ë²¤íŠ¸ ì²˜ë¦¬:', event);
                            handleSensorEventDirect(event);
                        });
                    }
                }
            } catch (error) {
                console.error('ğŸ”¥ [ì´ë²¤íŠ¸] ì˜¤ë¥˜:', error);
            }
        }, 1000);
        
        // 2. í˜„ì¬ ì„¼ì„œ ìƒíƒœ ì£¼ê¸°ì  í™•ì¸ (3ì´ˆë§ˆë‹¤)
        setInterval(async function() {
            try {
                const response = await fetch('/api/hardware/sensor_status');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.sensors) {
                        console.log('ğŸ”¥ [ìƒíƒœí´ë§] ì„¼ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸:', data.sensors);
                        
                        // ê° ì„¼ì„œì˜ í˜„ì¬ ìƒíƒœë¥¼ UIì— ë°˜ì˜
                        Object.entries(data.sensors).forEach(([sensorNum, state]) => {
                            updateSensorStatusDirect(parseInt(sensorNum), state);
                        });
                    }
                }
            } catch (error) {
                console.error('ğŸ”¥ [ìƒíƒœí´ë§] ì˜¤ë¥˜:', error);
            }
        }, 3000); // 3ì´ˆë§ˆë‹¤ ìƒíƒœ í´ë§
        
        addMotorLog('âœ… í˜¼í•© ëª¨ë‹ˆí„°ë§ í™œì„±í™” (ì´ë²¤íŠ¸ + ìƒíƒœí´ë§)', 'success');
        
    } catch (error) {
        addMotorLog('âŒ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹¤íŒ¨: ' + error.message, 'error');
        console.error('ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜:', error);
    }
}

// í´ë§ ëª¨ë“œ (WebSocket ì‹¤íŒ¨ì‹œ ëŒ€ì•ˆ)
function startPollingMode() {
    addMotorLog('ì„¼ì„œ í´ë§ ëª¨ë“œ ì‹œì‘', 'info');
    
    // 1ì´ˆë§ˆë‹¤ ì„¼ì„œ ìƒíƒœ í™•ì¸
    setInterval(async function() {
        try {
            const response = await fetch('/api/hardware/status');
            const data = await response.json();
            // ì„¼ì„œ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì²˜ë¦¬
            if (data.sensor_events) {
                data.sensor_events.forEach(event => {
                    handleSensorEventDirect(event);
                });
            }
        } catch (error) {
            console.log('í´ë§ ì˜¤ë¥˜:', error);
        }
    }, 1000);
}

// ì„¼ì„œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
function initializeSensorStates() {
    addMotorLog('ì„¼ì„œ ìƒíƒœ ì´ˆê¸°í™” ì¤‘...', 'info');
    
    // ëª¨ë“  ì„¼ì„œë¥¼ ë¨¼ì € ì—°ê²° ì•ˆë¨ìœ¼ë¡œ ì„¤ì •
    for (let i = 1; i <= 10; i++) {
        const sensorElement = document.getElementById(`sensor${i}`);
        if (sensorElement) {
            sensorElement.className = 'sensor-item sensor-disconnected';
            sensorElement.querySelector('.sensor-status').textContent = 'ì—°ê²° ì•ˆë¨';
        }
    }
    
    // ì—°ê²°ëœ ì„¼ì„œë§Œ ì—°ê²°ë¨ìœ¼ë¡œ ë³€ê²½
    connectedSensors.forEach(sensorNum => {
        const sensorElement = document.getElementById(`sensor${sensorNum}`);
        if (sensorElement) {
            sensorElement.className = 'sensor-item sensor-connected';
            sensorElement.querySelector('.sensor-status').textContent = 'ë¯¸ê°ì§€';
            addMotorLog(`ì„¼ì„œ ${sensorNum}ë²ˆ ì—°ê²°ë¨`, 'success');
        }
    });
    
    addMotorLog(`ì´ ${connectedSensors.length}ê°œ ì„¼ì„œ ì—°ê²° ì™„ë£Œ`, 'success');
}

// ESP32 ì´ë²¤íŠ¸ ì²˜ë¦¬
function handleESP32Event(data) {
    console.log('ESP32 ì´ë²¤íŠ¸:', data);
    
    if (data.event_type === 'sensor_triggered') {
        handleSensorEvent(data.data);
    } else if (data.event_type === 'motor_completed') {
        handleMotorEvent(data.data);
    } else if (data.event_type === 'barcode_scanned') {
        addMotorLog(`ë°”ì½”ë“œ ìŠ¤ìº”: ${data.data.barcode}`, 'info');
    }
}

// ì„¼ì„œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (WebSocket)
function handleSensorEvent(sensorData) {
    const addr = sensorData.addr;
    const pin = sensorData.pin;
    const state = sensorData.raw;
    
    // í•€ ë²ˆí˜¸ë¥¼ ì„¼ì„œ ë²ˆí˜¸ë¡œ ë§¤í•‘
    const pinToSensor = {0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 8: 9, 9: 10};
    const sensorNum = pinToSensor[pin];
    
    if (sensorNum && connectedSensors.includes(sensorNum)) {
        updateSensorStatus(sensorNum, state);
        addMotorLog(`ì„¼ì„œ ${sensorNum}: ${state}`, 'info');
    }
}

// ì„¼ì„œ ì´ë²¤íŠ¸ ì²˜ë¦¬ (í´ë§ ëª¨ë“œ)
function handleSensorEventDirect(eventData) {
    // ì§ì ‘ ì„¼ì„œ ë²ˆí˜¸ì™€ ìƒíƒœë¥¼ ë°›ëŠ” ê²½ìš°
    if (eventData.sensor_num && eventData.state) {
        updateSensorStatus(eventData.sensor_num, eventData.state);
        addMotorLog(`ì„¼ì„œ ${eventData.sensor_num}: ${eventData.state}`, 'info');
    }
}

// ì„¼ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë°˜ì˜)
function updateSensorStatus(sensorNum, state) {
    const sensorElement = document.getElementById(`sensor${sensorNum}`);
    const countElement = document.getElementById(`count${sensorNum}`);
    
    if (!sensorElement) return;
    
    // ìƒíƒœì— ë”°ë¥¸ ì‹œê°ì  ë³€í™” (ì‹¤ì‹œê°„)
    if (state === 'LOW') {
        // ì„¼ì„œ íŠ¸ë¦¬ê±°ë¨ (ë¬¼ì²´ ê°ì§€) - ê³„ì† ìœ ì§€
        if (sensorElement.className !== 'sensor-item sensor-triggered') {
            // ì²˜ìŒ ê°ì§€ë  ë•Œë§Œ ì¹´ìš´íŠ¸ ì¦ê°€
            sensorCounts[sensorNum]++;
            countElement.textContent = sensorCounts[sensorNum];
            countElement.style.display = 'flex';
            
            addMotorLog(`ì„¼ì„œ ${sensorNum}: ê°ì§€ë¨ (ë¬¼ì²´ ìˆìŒ)`, 'info');
        }
        
        sensorElement.className = 'sensor-item sensor-triggered';
        sensorElement.querySelector('.sensor-status').textContent = 'ê°ì§€ë¨!';
        
    } else {
        // ì„¼ì„œ ë¯¸ê°ì§€ (ë¬¼ì²´ ì—†ìŒ)
        if (sensorElement.className === 'sensor-item sensor-triggered') {
            addMotorLog(`ì„¼ì„œ ${sensorNum}: ë¯¸ê°ì§€ (ë¬¼ì²´ ì œê±°ë¨)`, 'info');
        }
        
        sensorElement.className = 'sensor-item sensor-connected';
        sensorElement.querySelector('.sensor-status').textContent = 'ë¯¸ê°ì§€';
    }
}

// ì§ì ‘ ì„¼ì„œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì¹´ìš´íŠ¸ ì¦ê°€ ì—†ì´)
function updateSensorStatusDirect(sensorNum, state) {
    const sensorElement = document.getElementById(`sensor${sensorNum}`);
    
    if (!sensorElement) return;
    
    // í˜„ì¬ ìƒíƒœì™€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
    const currentTriggered = sensorElement.className.includes('sensor-triggered');
    const shouldBeTriggered = (state === 'LOW');
    
    if (currentTriggered !== shouldBeTriggered) {
        if (shouldBeTriggered) {
            sensorElement.className = 'sensor-item sensor-triggered';
            sensorElement.querySelector('.sensor-status').textContent = 'ê°ì§€ë¨!';
            console.log(`ğŸ”¥ [ì§ì ‘ì—…ë°ì´íŠ¸] ì„¼ì„œ ${sensorNum}: ê°ì§€ë¨`);
        } else {
            sensorElement.className = 'sensor-item sensor-connected';
            sensorElement.querySelector('.sensor-status').textContent = 'ë¯¸ê°ì§€';
            console.log(`ğŸ”¥ [ì§ì ‘ì—…ë°ì´íŠ¸] ì„¼ì„œ ${sensorNum}: ë¯¸ê°ì§€`);
        }
    }
}

// ëª¨í„° ì´ë²¤íŠ¸ ì²˜ë¦¬
function handleMotorEvent(motorData) {
    const action = motorData.action;
    const status = motorData.status;
    addMotorLog(`ëª¨í„° ${action}: ${status}`, 'success');
}

// ëª¨í„° ë¡œê·¸ ì¶”ê°€
function addMotorLog(message, type = 'info') {
    const logContainer = document.getElementById('motorLog');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry log-${type}`;
    logEntry.textContent = `[${timestamp}] ${message}`;
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
    
    // ìµœëŒ€ 50ê°œ ë¡œê·¸ë§Œ ìœ ì§€
    const entries = logContainer.children;
    if (entries.length > 50) {
        logContainer.removeChild(entries[0]);
    }
}

// ë¡œë”© í‘œì‹œ/ìˆ¨ê¸°ê¸°
function showLoading(message = 'ì²˜ë¦¬ ì¤‘...') {
    const loading = document.getElementById('loading');
    loading.textContent = message;
    loading.style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

// ëª¨í„° ì œì–´ í•¨ìˆ˜ë“¤
async function rotateMotor330() {
    showLoading('ëª¨í„° íšŒì „ ì¤‘...');
    addMotorLog('330ë„ ì •ë°©í–¥ íšŒì „ ì‹œì‘', 'info');
    
    try {
        const response = await fetch('/api/hardware/motor_move', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                revs: 0.9167,  // 330ë„
                rpm: 60,
                accel: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            addMotorLog('330ë„ íšŒì „ ëª…ë ¹ ì „ì†¡ ì™„ë£Œ', 'success');
        } else {
            addMotorLog(`íšŒì „ ì‹¤íŒ¨: ${result.error}`, 'error');
        }
    } catch (error) {
        addMotorLog(`ì˜¤ë¥˜: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

async function rotateMotorReverse() {
    showLoading('ì›ìœ„ì¹˜ ë³µê·€ ì¤‘...');
    addMotorLog('330ë„ ì—­ë°©í–¥ íšŒì „ ì‹œì‘', 'info');
    
    try {
        const response = await fetch('/api/hardware/motor_move', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                revs: -0.9167,  // -330ë„ (ì—­ë°©í–¥)
                rpm: 60,
                accel: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            addMotorLog('ì›ìœ„ì¹˜ ë³µê·€ ëª…ë ¹ ì „ì†¡ ì™„ë£Œ', 'success');
        } else {
            addMotorLog(`ë³µê·€ ì‹¤íŒ¨: ${result.error}`, 'error');
        }
    } catch (error) {
        addMotorLog(`ì˜¤ë¥˜: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

async function toggleAutoMode() {
    showLoading('ìë™ëª¨ë“œ ì„¤ì • ì¤‘...');
    autoModeEnabled = !autoModeEnabled;
    
    try {
        const response = await fetch('/api/hardware/auto_mode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                enabled: autoModeEnabled
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const btnText = document.getElementById('autoModeText');
            const btn = document.getElementById('autoModeBtn');
            
            if (autoModeEnabled) {
                btnText.textContent = 'ìë™ëª¨ë“œ ë¹„í™œì„±í™”';
                btn.style.background = 'linear-gradient(45deg, #F44336, #EF5350)';
                addMotorLog('ìë™ëª¨ë“œ í™œì„±í™”ë¨', 'success');
            } else {
                btnText.textContent = 'ìë™ëª¨ë“œ í™œì„±í™”';
                btn.style.background = 'linear-gradient(45deg, #FF9800, #FFB74D)';
                addMotorLog('ìë™ëª¨ë“œ ë¹„í™œì„±í™”ë¨', 'info');
            }
        } else {
            addMotorLog(`ìë™ëª¨ë“œ ì„¤ì • ì‹¤íŒ¨: ${result.error}`, 'error');
        }
    } catch (error) {
        addMotorLog(`ì˜¤ë¥˜: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

// ì„¼ì„œ í…ŒìŠ¤íŠ¸ (ì‹œë®¬ë ˆì´ì…˜)
function testSensorTrigger() {
    addMotorLog('ì„¼ì„œ 1ë²ˆ í…ŒìŠ¤íŠ¸ íŠ¸ë¦¬ê±°', 'info');
    
    // ì„¼ì„œ 1ë²ˆì„ íŠ¸ë¦¬ê±° ìƒíƒœë¡œ ë³€ê²½
    updateSensorStatus(1, 'LOW');
    
    // 2ì´ˆ í›„ ì›ë˜ ìƒíƒœë¡œ ë³µì›
    setTimeout(() => {
        const sensorElement = document.getElementById('sensor1');
        if (sensorElement) {
            sensorElement.className = 'sensor-item sensor-connected';
            sensorElement.querySelector('.sensor-status').textContent = 'ë¯¸ê°ì§€';
        }
        addMotorLog('ì„¼ì„œ 1ë²ˆ í…ŒìŠ¤íŠ¸ ì™„ë£Œ', 'success');
    }, 2000);
}

// í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
function goHome() {
    window.location.href = '/';
}
</script>
{% endblock %}