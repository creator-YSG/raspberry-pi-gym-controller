{% extends "layouts/base.html" %}

{% block title %}ESP32 í•˜ë“œì›¨ì–´ í…ŒìŠ¤íŠ¸{% endblock %}

{% block body_class %}hardware-test-page{% endblock %}

{% block content %}
<div class="hardware-test-container">
    <!-- í—¤ë” -->
    <header class="test-header">
        <h1 class="test-title">ğŸ”§ ESP32 í•˜ë“œì›¨ì–´ í…ŒìŠ¤íŠ¸</h1>
        <div class="connection-status">
            <span id="connectionStatus" class="status-disconnected">ì—°ê²° í™•ì¸ ì¤‘...</span>
        </div>
    </header>
    
    <!-- ëª¨í„° ì œì–´ ì„¹ì…˜ -->
    <section class="motor-control-section">
        <h2>âš™ï¸ ëª¨í„° ì œì–´</h2>
        <div class="motor-controls">
            <button class="test-btn motor-btn" onclick="rotateMotor330()">
                <div class="btn-icon">ğŸ”„</div>
                <div class="btn-text">330ë„ íšŒì „</div>
            </button>
            
            <button class="test-btn motor-btn" onclick="rotateMotorReverse()">
                <div class="btn-icon">â†©ï¸</div>
                <div class="btn-text">ì›ìœ„ì¹˜ ë³µê·€</div>
            </button>
            
            <button class="test-btn motor-btn" onclick="toggleAutoMode()">
                <div class="btn-icon">ğŸ¤–</div>
                <div class="btn-text" id="autoModeText">ìë™ëª¨ë“œ ON</div>
            </button>
        </div>
        
        <div class="motor-status">
            <div class="status-item">
                <span class="label">ëª¨í„° ìƒíƒœ:</span>
                <span id="motorStatus" class="value">ëŒ€ê¸°ì¤‘</span>
            </div>
            <div class="status-item">
                <span class="label">ì´ íšŒì „ íšŸìˆ˜:</span>
                <span id="motorMoveCount" class="value">0</span>
            </div>
        </div>
    </section>
    
    <!-- ì„¼ì„œ ëª¨ë‹ˆí„°ë§ ì„¹ì…˜ -->
    <section class="sensor-monitor-section">
        <h2>ğŸ“¡ ì„¼ì„œ ëª¨ë‹ˆí„°ë§</h2>
        
        <div class="sensor-grid">
            <!-- ì„¼ì„œ ì¹©ë³„ ìƒíƒœ -->
            <div class="sensor-chip">
                <h3>Chip 0 (0x20)</h3>
                <div class="sensor-pins" id="sensorChip0">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>
            
            <div class="sensor-chip">
                <h3>Chip 1 (0x21)</h3>
                <div class="sensor-pins" id="sensorChip1">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </div>
        </div>
        
        <!-- ì„¼ì„œ ì´ë²¤íŠ¸ ë¡œê·¸ -->
        <div class="sensor-log">
            <h3>ğŸ“‹ ì„¼ì„œ ì´ë²¤íŠ¸ ë¡œê·¸</h3>
            <div class="log-controls">
                <button class="small-btn" onclick="clearSensorLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
                <label>
                    <input type="checkbox" id="autoScroll" checked> ìë™ ìŠ¤í¬ë¡¤
                </label>
            </div>
            <div class="log-container" id="sensorLogContainer">
                <div class="log-message">ì„¼ì„œ ì´ë²¤íŠ¸ ëŒ€ê¸° ì¤‘...</div>
            </div>
        </div>
    </section>
    
    <!-- ë°”ì½”ë“œ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
    <section class="barcode-test-section">
        <h2>ğŸ” ë°”ì½”ë“œ í…ŒìŠ¤íŠ¸</h2>
        
        <div class="barcode-controls">
            <input type="text" id="testBarcodeInput" placeholder="í…ŒìŠ¤íŠ¸ìš© ë°”ì½”ë“œ ì…ë ¥..." maxlength="20">
            <button class="test-btn" onclick="sendTestBarcode()">
                <div class="btn-text">ë°”ì½”ë“œ ì „ì†¡</div>
            </button>
        </div>
        
        <div class="barcode-log">
            <h3>ğŸ“‹ ë°”ì½”ë“œ ìŠ¤ìº” ë¡œê·¸</h3>
            <div class="log-container" id="barcodeLogContainer">
                <div class="log-message">ë°”ì½”ë“œ ìŠ¤ìº” ëŒ€ê¸° ì¤‘...</div>
            </div>
        </div>
    </section>
    
    <!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
    <section class="system-status-section">
        <h2>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h2>
        <div class="status-grid">
            <div class="status-card">
                <div class="status-label">ESP32 ì—°ê²°</div>
                <div class="status-value" id="esp32Connection">í™•ì¸ ì¤‘</div>
            </div>
            <div class="status-card">
                <div class="status-label">ì—…íƒ€ì„</div>
                <div class="status-value" id="systemUptime">0ì´ˆ</div>
            </div>
            <div class="status-card">
                <div class="status-label">ë©”ëª¨ë¦¬</div>
                <div class="status-value" id="memoryUsage">--</div>
            </div>
            <div class="status-card">
                <div class="status-label">ì„¼ì„œ ì´ë²¤íŠ¸</div>
                <div class="status-value" id="sensorEventCount">0</div>
            </div>
        </div>
    </section>
    
    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <footer class="test-footer">
        <div class="footer-buttons">
            <button class="nav-btn" onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
            <button class="nav-btn" onclick="requestStatus()">ğŸ”„ ìƒíƒœ ê°±ì‹ </button>
            <button class="nav-btn" onclick="reconnectESP32()">ğŸ”Œ ì¬ì—°ê²°</button>
        </div>
    </footer>
</div>

<!-- ë¡œë”© ëª¨ë‹¬ -->
<div id="loadingModal" class="modal hidden">
    <div class="modal-content">
        <div class="loading-spinner"></div>
        <h3 id="loadingText">ëª…ë ¹ ì „ì†¡ ì¤‘...</h3>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.hardware-test-container {
    max-width: 100%;
    padding: 20px;
    font-family: 'Noto Sans KR', sans-serif;
}

.test-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
}

.test-title {
    margin: 0 0 10px 0;
    font-size: 28px;
}

.connection-status {
    font-size: 16px;
}

.status-connected { color: #4CAF50; }
.status-disconnected { color: #f44336; }
.status-connecting { color: #ff9800; }

/* ì„¹ì…˜ ê³µí†µ ìŠ¤íƒ€ì¼ */
section {
    background: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

section h2 {
    margin: 0 0 20px 0;
    font-size: 22px;
    color: #333;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 10px;
}

/* ëª¨í„° ì œì–´ */
.motor-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.test-btn {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 20px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.test-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.test-btn:active {
    transform: translateY(0);
}

.motor-btn {
    background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
}

.btn-icon {
    font-size: 24px;
}

.btn-text {
    font-size: 14px;
}

.motor-status {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.status-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 15px;
    background: #f5f5f5;
    border-radius: 8px;
}

.label {
    font-weight: bold;
    color: #666;
}

.value {
    color: #333;
}

/* ì„¼ì„œ ëª¨ë‹ˆí„°ë§ */
.sensor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.sensor-chip {
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    padding: 15px;
}

.sensor-chip h3 {
    margin: 0 0 15px 0;
    font-size: 18px;
    color: #333;
}

.sensor-pins {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}

.sensor-pin {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    color: white;
    background: #ccc;
    transition: all 0.3s ease;
}

.sensor-pin.high {
    background: #4CAF50;
    transform: scale(1.1);
}

.sensor-pin.low {
    background: #f44336;
}

/* ë¡œê·¸ ì»¨í…Œì´ë„ˆ */
.log-container {
    height: 200px;
    overflow-y: auto;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
}

.log-message {
    padding: 5px 0;
    border-bottom: 1px solid #e9ecef;
}

.log-message:last-child {
    border-bottom: none;
}

.log-message.sensor-event {
    color: #2196F3;
}

.log-message.barcode-event {
    color: #4CAF50;
}

.log-message.motor-event {
    color: #FF9800;
}

.log-message.error {
    color: #f44336;
}

.log-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.small-btn {
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 12px;
    cursor: pointer;
}

/* ë°”ì½”ë“œ í…ŒìŠ¤íŠ¸ */
.barcode-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

#testBarcodeInput {
    flex: 1;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
}

/* ì‹œìŠ¤í…œ ìƒíƒœ */
.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.status-card {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
}

.status-label {
    display: block;
    font-size: 12px;
    opacity: 0.8;
    margin-bottom: 5px;
}

.status-value {
    display: block;
    font-size: 20px;
    font-weight: bold;
}

/* í‘¸í„° */
.test-footer {
    text-align: center;
    margin-top: 30px;
}

.footer-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
}

.nav-btn {
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 10px;
    padding: 15px 25px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.nav-btn:hover {
    background: #5a6268;
    transform: translateY(-1px);
}

/* ë¡œë”© ëª¨ë‹¬ */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal.hidden {
    display: none;
}

.modal-content {
    background: white;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    max-width: 300px;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .hardware-test-container {
        padding: 10px;
    }
    
    .motor-controls {
        grid-template-columns: 1fr;
    }
    
    .sensor-grid {
        grid-template-columns: 1fr;
    }
    
    .status-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// ì „ì—­ ë³€ìˆ˜
let socket = null;
let autoMode = true;
let sensorEventCount = 0;
let startTime = Date.now();

// í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initializeWebSocket();
    initializeSensorGrid();
    startSystemMonitoring();
});

// WebSocket ì—°ê²°
function initializeWebSocket() {
    socket = io();
    
    socket.on('connect', function() {
        updateConnectionStatus('connected', 'ESP32 ì—°ê²°ë¨');
        requestStatus();
    });
    
    socket.on('disconnect', function() {
        updateConnectionStatus('disconnected', 'ì—°ê²° ëŠê¹€');
    });
    
    // ESP32 ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    socket.on('barcode_scanned', handleBarcodeEvent);
    socket.on('sensor_status', handleSensorEvent);
    socket.on('motor_status', handleMotorEvent);
    socket.on('esp32_status', handleStatusUpdate);
}

// ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
function updateConnectionStatus(status, message) {
    const statusElement = document.getElementById('connectionStatus');
    statusElement.textContent = message;
    statusElement.className = `status-${status}`;
}

// ì„¼ì„œ ê·¸ë¦¬ë“œ ì´ˆê¸°í™”
function initializeSensorGrid() {
    for (let chip = 0; chip < 2; chip++) {
        const container = document.getElementById(`sensorChip${chip}`);
        for (let pin = 0; pin < 16; pin++) {
            const pinElement = document.createElement('div');
            pinElement.className = 'sensor-pin low';
            pinElement.textContent = pin;
            pinElement.id = `sensor_${chip}_${pin}`;
            container.appendChild(pinElement);
        }
    }
}

// ëª¨í„° ì œì–´ í•¨ìˆ˜ë“¤
async function rotateMotor330() {
    showLoading('ëª¨í„° 330ë„ íšŒì „ ì¤‘...');
    
    try {
        const response = await fetch('/api/hardware/motor_move', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                revs: 0.9167,  // 330ë„
                rpm: 60,
                accel: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            addMotorLog('330ë„ íšŒì „', 'ì„±ê³µ', 'ì •ë°©í–¥ íšŒì „ ì™„ë£Œ');
        } else {
            addMotorLog('330ë„ íšŒì „', 'ì‹¤íŒ¨', result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
    } catch (error) {
        addMotorLog('330ë„ íšŒì „', 'ì˜¤ë¥˜', error.message);
    } finally {
        hideLoading();
    }
}

async function rotateMotorReverse() {
    showLoading('ëª¨í„° ì›ìœ„ì¹˜ ë³µê·€ ì¤‘...');
    
    try {
        const response = await fetch('/api/hardware/motor_move', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                revs: -0.9167,  // -330ë„ (ì—­ë°©í–¥)
                rpm: 60,
                accel: true
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            addMotorLog('ì›ìœ„ì¹˜ ë³µê·€', 'ì„±ê³µ', 'ì—­ë°©í–¥ íšŒì „ ì™„ë£Œ');
        } else {
            addMotorLog('ì›ìœ„ì¹˜ ë³µê·€', 'ì‹¤íŒ¨', result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
    } catch (error) {
        addMotorLog('ì›ìœ„ì¹˜ ë³µê·€', 'ì˜¤ë¥˜', error.message);
    } finally {
        hideLoading();
    }
}

async function toggleAutoMode() {
    autoMode = !autoMode;
    
    try {
        const response = await fetch('/api/hardware/auto_mode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                enabled: autoMode
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('autoModeText').textContent = 
                autoMode ? 'ìë™ëª¨ë“œ ON' : 'ìë™ëª¨ë“œ OFF';
            addMotorLog('ìë™ëª¨ë“œ', autoMode ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”', 'ì„¤ì • ë³€ê²½ë¨');
        }
    } catch (error) {
        addMotorLog('ìë™ëª¨ë“œ', 'ì˜¤ë¥˜', error.message);
    }
}

// í…ŒìŠ¤íŠ¸ ë°”ì½”ë“œ ì „ì†¡
async function sendTestBarcode() {
    const barcode = document.getElementById('testBarcodeInput').value.trim();
    
    if (!barcode) {
        alert('ë°”ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const response = await fetch('/api/hardware/test_barcode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                barcode: barcode
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            addBarcodeLog(barcode, 'í…ŒìŠ¤íŠ¸ ì „ì†¡', 'ì„±ê³µ');
            document.getElementById('testBarcodeInput').value = '';
        } else {
            addBarcodeLog(barcode, 'í…ŒìŠ¤íŠ¸ ì „ì†¡', 'ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    } catch (error) {
        addBarcodeLog(barcode, 'í…ŒìŠ¤íŠ¸ ì „ì†¡', 'ì˜¤ë¥˜: ' + error.message);
    }
}

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
function handleBarcodeEvent(data) {
    const barcode = data.barcode || 'ì•Œ ìˆ˜ ì—†ìŒ';
    const format = data.format || 'Unknown';
    addBarcodeLog(barcode, 'ìŠ¤ìº”ë¨', `í˜•ì‹: ${format}`);
}

function handleSensorEvent(data) {
    const chip = data.chip_idx || 0;
    const pin = data.pin || 0;
    const active = data.active || false;
    const raw = data.raw || 'UNKNOWN';
    
    // ì„¼ì„œ í•€ ìƒíƒœ ì—…ë°ì´íŠ¸
    const pinElement = document.getElementById(`sensor_${chip}_${pin}`);
    if (pinElement) {
        pinElement.className = `sensor-pin ${active ? 'high' : 'low'}`;
    }
    
    // ë¡œê·¸ ì¶”ê°€
    sensorEventCount++;
    document.getElementById('sensorEventCount').textContent = sensorEventCount;
    
    addSensorLog(chip, pin, raw, active ? 'ACTIVE' : 'INACTIVE');
}

function handleMotorEvent(data) {
    const action = data.action || 'ì•Œ ìˆ˜ ì—†ìŒ';
    const status = data.status || 'ì•Œ ìˆ˜ ì—†ìŒ';
    const details = data.details || {};
    
    addMotorLog(action, status, JSON.stringify(details));
    
    // ëª¨í„° ìƒíƒœ ì—…ë°ì´íŠ¸
    document.getElementById('motorStatus').textContent = 
        data.busy ? 'ë™ì‘ ì¤‘' : 'ëŒ€ê¸° ì¤‘';
        
    if (data.total_moves !== undefined) {
        document.getElementById('motorMoveCount').textContent = data.total_moves;
    }
}

function handleStatusUpdate(data) {
    // ESP32 ìƒíƒœ ì—…ë°ì´íŠ¸
    if (data.esp32Connection !== undefined) {
        document.getElementById('esp32Connection').textContent = 
            data.esp32Connection ? 'ì—°ê²°ë¨' : 'ì—°ê²° ì•ˆë¨';
    }
    
    if (data.uptime_ms !== undefined) {
        const uptime = Math.floor(data.uptime_ms / 1000);
        document.getElementById('systemUptime').textContent = `${uptime}ì´ˆ`;
    }
    
    if (data.free_heap !== undefined) {
        const memoryMB = Math.floor(data.free_heap / 1024);
        document.getElementById('memoryUsage').textContent = `${memoryMB}KB`;
    }
}

// ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜ë“¤
function addSensorLog(chip, pin, raw, status) {
    const container = document.getElementById('sensorLogContainer');
    const timestamp = new Date().toLocaleTimeString();
    const message = `[${timestamp}] Chip${chip} Pin${pin}: ${raw} â†’ ${status}`;
    
    const logElement = document.createElement('div');
    logElement.className = 'log-message sensor-event';
    logElement.textContent = message;
    
    container.appendChild(logElement);
    
    // ìë™ ìŠ¤í¬ë¡¤
    if (document.getElementById('autoScroll').checked) {
        container.scrollTop = container.scrollHeight;
    }
    
    // ë¡œê·¸ ê°œìˆ˜ ì œí•œ (ìµœëŒ€ 100ê°œ)
    if (container.children.length > 100) {
        container.removeChild(container.firstChild);
    }
}

function addBarcodeLog(barcode, action, status) {
    const container = document.getElementById('barcodeLogContainer');
    const timestamp = new Date().toLocaleTimeString();
    const message = `[${timestamp}] ${barcode} - ${action}: ${status}`;
    
    const logElement = document.createElement('div');
    logElement.className = 'log-message barcode-event';
    logElement.textContent = message;
    
    if (container.children.length === 1 && 
        container.children[0].textContent.includes('ëŒ€ê¸° ì¤‘')) {
        container.innerHTML = '';
    }
    
    container.appendChild(logElement);
    container.scrollTop = container.scrollHeight;
}

function addMotorLog(action, status, details) {
    // ëª¨í„° ë¡œê·¸ëŠ” ì„¼ì„œ ë¡œê·¸ì— í•¨ê»˜ í‘œì‹œ
    const container = document.getElementById('sensorLogContainer');
    const timestamp = new Date().toLocaleTimeString();
    const message = `[${timestamp}] ëª¨í„° ${action}: ${status} - ${details}`;
    
    const logElement = document.createElement('div');
    logElement.className = 'log-message motor-event';
    logElement.textContent = message;
    
    container.appendChild(logElement);
    
    if (document.getElementById('autoScroll').checked) {
        container.scrollTop = container.scrollHeight;
    }
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function clearSensorLog() {
    document.getElementById('sensorLogContainer').innerHTML = 
        '<div class="log-message">ì„¼ì„œ ì´ë²¤íŠ¸ ëŒ€ê¸° ì¤‘...</div>';
    sensorEventCount = 0;
    document.getElementById('sensorEventCount').textContent = '0';
}

function showLoading(text) {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingModal').classList.remove('hidden');
}

function hideLoading() {
    document.getElementById('loadingModal').classList.add('hidden');
}

async function requestStatus() {
    try {
        const response = await fetch('/api/hardware/status');
        const result = await response.json();
        
        if (result.success) {
            handleStatusUpdate(result.data);
        }
    } catch (error) {
        console.error('ìƒíƒœ ìš”ì²­ ì‹¤íŒ¨:', error);
    }
}

async function reconnectESP32() {
    showLoading('ESP32 ì¬ì—°ê²° ì¤‘...');
    
    try {
        const response = await fetch('/api/hardware/reconnect', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            updateConnectionStatus('connected', 'ESP32 ì¬ì—°ê²°ë¨');
            requestStatus();
        } else {
            updateConnectionStatus('disconnected', 'ì¬ì—°ê²° ì‹¤íŒ¨');
        }
    } catch (error) {
        updateConnectionStatus('disconnected', 'ì¬ì—°ê²° ì˜¤ë¥˜');
    } finally {
        hideLoading();
    }
}

function goHome() {
    window.location.href = '/';
}

// ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§
function startSystemMonitoring() {
    setInterval(() => {
        const uptime = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('systemUptime').textContent = `${uptime}ì´ˆ`;
    }, 1000);
    
    // ì£¼ê¸°ì ìœ¼ë¡œ ìƒíƒœ ìš”ì²­
    setInterval(requestStatus, 10000); // 10ì´ˆë§ˆë‹¤
}

// Enter í‚¤ë¡œ ë°”ì½”ë“œ ì „ì†¡
document.getElementById('testBarcodeInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendTestBarcode();
    }
});
</script>
{% endblock %}
