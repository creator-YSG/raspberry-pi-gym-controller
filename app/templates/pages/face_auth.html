{% extends "layouts/base.html" %}

{% block title %}ì–¼êµ´ ì¸ì¦{% endblock %}

{% block body_class %}face-auth-page{% endblock %}

{% block content %}
<div class="face-auth-container">
    <!-- ìƒë‹¨: ì•ˆë‚´ ë©”ì‹œì§€ -->
    <div class="auth-header">
        <h1 class="auth-title" id="authTitle">ì¹´ë©”ë¼ë¥¼ ë°”ë¼ë´ì£¼ì„¸ìš”</h1>
        <p class="auth-subtitle" id="authSubtitle">ìë™ìœ¼ë¡œ ì–¼êµ´ì„ ì¸ì‹í•©ë‹ˆë‹¤</p>
    </div>

    <!-- ì¤‘ì•™: ì¹´ë©”ë¼ ì˜ìƒ -->
    <div class="camera-container">
        <div class="camera-frame">
            <img id="cameraFeed" src="" alt="ì¹´ë©”ë¼ ì˜ìƒ" />
            <div class="face-guide"></div>
        </div>
        <div class="camera-status" id="cameraStatus">
            <span class="status-icon">ğŸ“·</span>
            <span class="status-text">ì¸ì‹ ì¤‘...</span>
        </div>
    </div>

    <!-- í•˜ë‹¨: ëŒ€ì²´ ì¸ì¦ ì•ˆë‚´ -->
    <div class="alt-auth-message">
        <p>ë°”ì½”ë“œ ë˜ëŠ” QRì½”ë“œë¡œë„ ì¸ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
    </div>
    
    <!-- íƒ€ì„ì•„ì›ƒ í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
    <div class="timeout-progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
</div>

<style>
.face-auth-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    min-height: 100vh;
    padding: 40px 20px;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    color: white;
}

.auth-header {
    text-align: center;
    margin-bottom: 20px;
}

.auth-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 10px;
    color: #ffffff;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.auth-subtitle {
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.7);
}

.camera-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
}

.camera-frame {
    position: relative;
    width: 480px;
    height: 360px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    border: 4px solid rgba(76, 175, 80, 0.5);
}

.camera-frame img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.face-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 200px;
    height: 260px;
    border: 3px dashed rgba(76, 175, 80, 0.7);
    border-radius: 50% 50% 45% 45%;
    pointer-events: none;
}

.camera-status {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
    padding: 12px 24px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 30px;
    font-size: 1.1rem;
}

.camera-status.success {
    background: rgba(76, 175, 80, 0.3);
    border: 2px solid #4caf50;
}

.camera-status.error {
    background: rgba(244, 67, 54, 0.3);
    border: 2px solid #f44336;
}

.status-icon {
    font-size: 1.5rem;
}

.alt-auth-message {
    text-align: center;
    margin-top: 20px;
    color: rgba(255, 255, 255, 0.6);
    font-size: 1rem;
}

.timeout-progress {
    width: 100%;
    max-width: 500px;
    height: 6px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
    margin-top: 30px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4caf50, #8bc34a);
    width: 100%;
    transition: width 0.3s ease;
}

/* ì¸ì¦ ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes successPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.camera-frame.success {
    border-color: #4caf50;
    animation: successPulse 0.5s ease;
}

.camera-frame.error {
    border-color: #f44336;
}
</style>

<!-- ë°”ì½”ë“œ ì…ë ¥ ìˆ¨ê¹€ í•„ë“œ (í•˜ë“œì›¨ì–´ ìŠ¤ìºë„ˆìš©) -->
<input type="text" id="barcodeInput" class="barcode-hidden-input" autocomplete="off" />

<script>
let pollingInterval = null;
let authPollingInterval = null;
let timeoutInterval = null;
let isProcessingAuth = false;
let isProcessingBarcode = false;
const TIMEOUT_SECONDS = 20;
let remainingSeconds = TIMEOUT_SECONDS;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
(function() {
    console.log('ğŸ“· ì–¼êµ´ ì¸ì¦ í™”ë©´ ì‹œì‘');
    
    var subtitle = document.getElementById('authSubtitle');
    if (!subtitle) {
        console.error('authSubtitle ìš”ì†Œ ì—†ìŒ');
        return;
    }
    subtitle.textContent = 'ì´ˆê¸°í™” ì¤‘...';
    
    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
    var cameraFeed = document.getElementById('cameraFeed');
    if (cameraFeed) {
        cameraFeed.src = '/api/video_feed';
    }
    
    // ë°”ì½”ë“œ í´ë§ ì‹œì‘
    startBarcodePolling();
    
    // ì–¼êµ´ ì¸ì¦ í´ë§ ì‹œì‘ (1ì´ˆ í›„)
    setTimeout(function() {
        subtitle.textContent = 'ì–¼êµ´ ì¸ì‹ ì¤‘...';
        startFaceAuthPolling();
    }, 1000);
    
    // íƒ€ì„ì•„ì›ƒ ì¹´ìš´í„° ì‹œì‘
    startTimeoutCounter();
})();

// ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ë¦¬ìŠ¤ë‹
function setupBarcodeScanner() {
    const barcodeInput = document.getElementById('barcodeInput');
    barcodeInput.focus();
    
    document.addEventListener('click', function() {
        barcodeInput.focus();
    });
    
    let barcodeBuffer = '';
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            const inputValue = barcodeInput.value || barcodeBuffer;
            
            if (inputValue.length > 0) {
                console.log('ë°”ì½”ë“œ ì™„ë£Œ:', inputValue);
                handleBarcodeScanned(inputValue);
                barcodeBuffer = '';
                barcodeInput.value = '';
            }
            e.preventDefault();
            return false;
        }
        
        if (e.key && e.key.length === 1) {
            barcodeBuffer += e.key;
        }
    });
}

// ë°”ì½”ë“œ í´ë§ ì‹œì‘
function startBarcodePolling() {
    pollingInterval = setInterval(function() {
        if (isProcessingBarcode || isProcessingAuth) return;
        
        fetch('/api/barcode/poll')
            .then(response => response.json())
            .then(data => {
                if (data.has_barcode && !isProcessingBarcode && !isProcessingAuth) {
                    console.log('ğŸ“Š ë°”ì½”ë“œ ê°ì§€:', data.barcode);
                    handleBarcodeScanned(data.barcode);
                }
            })
            .catch(error => {});
    }, 200);
}

// ì–¼êµ´ ì¸ì¦ í´ë§ ì‹œì‘
function startFaceAuthPolling() {
    authPollingInterval = setInterval(function() {
        if (isProcessingAuth || isProcessingBarcode) return;
        
        attemptFaceAuth();
    }, 800);  // 0.8ì´ˆë§ˆë‹¤ ì‹œë„
}

// ì–¼êµ´ ì¸ì¦ ì‹œë„
function attemptFaceAuth() {
    if (isProcessingAuth || isProcessingBarcode) return;
    
    isProcessingAuth = true;
    updateStatus('processing', 'ì¸ì‹ ì¤‘...');
    
    fetch('/api/auth/face', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        console.log('ì–¼êµ´ ì¸ì¦ ê²°ê³¼:', data);
        
        if (data.success) {
            // ì¸ì¦ ì„±ê³µ
            updateStatus('success', `${data.member_name}ë‹˜ í™•ì¸!`);
            document.querySelector('.camera-frame').classList.add('success');
            
            // í´ë§ ì¤‘ì§€
            stopAllPolling();
            
            // í™”ë©´ ì „í™˜
            setTimeout(function() {
                if (data.action === 'rental') {
                    navigateTo('member-check', { member_id: data.member_id, action: 'rental' });
                } else if (data.action === 'return') {
                    navigateTo('member-check', { member_id: data.member_id, action: 'return' });
                }
            }, 800);
        } else {
            // ì¸ì¦ ì‹¤íŒ¨ - ê³„ì† ì‹œë„
            if (data.error_type === 'face_not_detected') {
                updateStatus('waiting', 'ì¹´ë©”ë¼ë¥¼ ë°”ë¼ë´ì£¼ì„¸ìš”');
                // ì–¼êµ´ ì—†ìœ¼ë©´ 1.5ì´ˆ í›„ ì¬ì‹œë„ (API ë¶€í•˜ ê°ì†Œ)
                setTimeout(function() {
                    isProcessingAuth = false;
                }, 1500);
                return;
            } else if (data.error_type === 'face_not_found') {
                updateStatus('error', 'ë“±ë¡ëœ ì–¼êµ´ì´ ì•„ë‹™ë‹ˆë‹¤');
            } else if (data.error_type === 'member_invalid') {
                updateStatus('error', data.error);
                // í´ë§ ì¤‘ì§€í•˜ê³  ì—ëŸ¬ í‘œì‹œ
                stopAllPolling();
                setTimeout(function() {
                    navigateTo('error', { type: 'member_error', message: data.error });
                }, 2000);
                return;
            }
            
            isProcessingAuth = false;
        }
    })
    .catch(error => {
        console.error('ì–¼êµ´ ì¸ì¦ ì˜¤ë¥˜:', error);
        updateStatus('error', 'ì¹´ë©”ë¼ ì˜¤ë¥˜');
        isProcessingAuth = false;
    });
}

// ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬
function handleBarcodeScanned(barcode) {
    if (!barcode || barcode.trim().length === 0) return;
    if (isProcessingBarcode || isProcessingAuth) return;
    
    barcode = barcode.trim();
    
    // NFC íƒœê·¸ ì²˜ë¦¬
    if (barcode.startsWith('NFC:')) {
        const nfcUid = barcode.substring(4);
        handleNFCScanned(nfcUid);
        return;
    }
    
    isProcessingBarcode = true;
    stopAllPolling();
    
    updateStatus('processing', 'ë°”ì½”ë“œ í™•ì¸ ì¤‘...');
    
    fetch('/api/barcode/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ barcode: barcode })
    })
    .then(response => response.json())
    .then(data => {
        console.log('ë°”ì½”ë“œ ì²˜ë¦¬ ê²°ê³¼:', data);
        
        if (data.success) {
            if (data.action === 'rental') {
                navigateTo('member-check', { member_id: data.member_id, action: 'rental' });
            } else if (data.action === 'return') {
                navigateTo('member-check', { member_id: data.member_id, action: 'return' });
            }
        } else {
            navigateTo('error', { 
                type: data.error_type || 'unknown',
                message: data.error || 'ë°”ì½”ë“œ ì²˜ë¦¬ ì˜¤ë¥˜'
            });
        }
    })
    .catch(error => {
        console.error('ë°”ì½”ë“œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        isProcessingBarcode = false;
        startBarcodePolling();
        startFaceAuthPolling();
    });
}

// NFC ìŠ¤ìº” ì²˜ë¦¬
function handleNFCScanned(nfcUid) {
    if (!nfcUid) return;
    if (isProcessingBarcode) return;
    
    isProcessingBarcode = true;
    stopAllPolling();
    
    fetch('/api/nfc/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nfc_uid: nfcUid })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.locker_info) {
            navigateTo('member-check', {
                action: 'return',
                locker_id: data.locker_info.locker_number,
                zone: data.locker_info.zone,
                method: 'nfc',
                nfc_uid: nfcUid
            });
        } else {
            navigateTo('error', { type: 'nfc_error', message: data.error || 'NFC ì˜¤ë¥˜' });
        }
    })
    .catch(e => {
        isProcessingBarcode = false;
        startBarcodePolling();
        startFaceAuthPolling();
    });
}

// ìƒíƒœ ì—…ë°ì´íŠ¸
function updateStatus(type, message) {
    const statusEl = document.getElementById('cameraStatus');
    const iconEl = statusEl.querySelector('.status-icon');
    const textEl = statusEl.querySelector('.status-text');
    
    statusEl.className = 'camera-status ' + type;
    
    switch(type) {
        case 'processing':
            iconEl.textContent = 'ğŸ”„';
            break;
        case 'success':
            iconEl.textContent = 'âœ…';
            break;
        case 'error':
            iconEl.textContent = 'âŒ';
            break;
        case 'waiting':
            iconEl.textContent = 'ğŸ‘¤';
            break;
        default:
            iconEl.textContent = 'ğŸ“·';
    }
    
    textEl.textContent = message;
}

// íƒ€ì„ì•„ì›ƒ ì¹´ìš´í„°
function startTimeoutCounter() {
    const progressBar = document.getElementById('progressBar');
    
    timeoutInterval = setInterval(function() {
        remainingSeconds--;
        
        const progress = (remainingSeconds / TIMEOUT_SECONDS) * 100;
        progressBar.style.width = progress + '%';
        
        if (remainingSeconds <= 0) {
            // íƒ€ì„ì•„ì›ƒ - í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
            console.log('â° íƒ€ì„ì•„ì›ƒ - í™ˆìœ¼ë¡œ ì´ë™');
            stopAllPolling();
            navigateTo('', {});  // í™ˆìœ¼ë¡œ
        }
    }, 1000);
}

// ëª¨ë“  í´ë§ ì¤‘ì§€
function stopAllPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
    if (authPollingInterval) {
        clearInterval(authPollingInterval);
        authPollingInterval = null;
    }
    if (timeoutInterval) {
        clearInterval(timeoutInterval);
        timeoutInterval = null;
    }
}

// í™”ë©´ ì „í™˜
function navigateTo(page, params) {
    const queryString = new URLSearchParams(params).toString();
    const url = `/${page}${queryString ? '?' + queryString : ''}`;
    console.log('ğŸ”„ ì´ë™:', url);
    window.location.href = url;
}

// í˜ì´ì§€ ë– ë‚  ë•Œ ì •ë¦¬
window.addEventListener('beforeunload', function() {
    stopAllPolling();
});
</script>
{% endblock %}

