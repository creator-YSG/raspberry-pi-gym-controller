{% extends "layouts/base.html" %}

{% block title %}NFC íƒœê·¸ ë“±ë¡{% endblock %}

{% block body_class %}settings-page{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- ì¢Œì¸¡ ìƒë‹¨: ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <div class="back-button-container">
        <button class="back-button" onclick="window.location.href='/settings'">
            â† ì„¤ì •ìœ¼ë¡œ
        </button>
    </div>

    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="settings-header">
        <h1>ğŸ”– NFC íƒœê·¸ ë“±ë¡</h1>
        <p class="settings-subtitle">60ê°œ ë½ì»¤ì— NFC íƒœê·¸ë¥¼ ë“±ë¡í•˜ì„¸ìš”</p>
    </div>

    <!-- NFC ì½ê¸° ìƒíƒœ í‘œì‹œ -->
    <div class="nfc-status" id="nfcStatus">
        <div class="nfc-indicator">
            <div class="nfc-light" id="nfcLight"></div>
            <span id="nfcStatusText">NFC ë¦¬ë”ê¸°ë¥¼ ì¤€ë¹„í•˜ì„¸ìš”</span>
        </div>
        <div class="nfc-uid-display">
            <label>NFC UID:</label>
            <span id="currentNfcUid">---</span>
        </div>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
    <div class="action-buttons">
        <button class="action-btn action-btn-save" id="saveBtn" disabled>
            ğŸ’¾ ì €ì¥
        </button>
        <button class="action-btn action-btn-unregister" id="unregisterBtn" disabled>
            ğŸ—‘ï¸ í•´ì œ
        </button>
    </div>

    <!-- ë½ì»¤ ê·¸ë¦¬ë“œ -->
    <div class="locker-grid-container">
        <!-- STAFF êµ¬ì—­ -->
        <div class="zone-section">
            <h2 class="zone-title">êµì§ì› êµ¬ì—­ (S01-S10)</h2>
            <div class="locker-grid" id="staffGrid">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- MALE êµ¬ì—­ -->
        <div class="zone-section">
            <h2 class="zone-title">ë‚¨ì„± êµ¬ì—­ (M01-M40)</h2>
            <div class="locker-grid" id="maleGrid">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- FEMALE êµ¬ì—­ -->
        <div class="zone-section">
            <h2 class="zone-title">ì—¬ì„± êµ¬ì—­ (F01-F10)</h2>
            <div class="locker-grid" id="femaleGrid">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>
</div>

<style>
.settings-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
.back-button-container {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
}

.back-button {
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 18px;
    color: white;
    transition: all 0.3s ease;
}

.back-button:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.05);
}

.back-button:active {
    transform: scale(0.95);
}

/* í—¤ë” */
.settings-header {
    margin-top: 60px;
    margin-bottom: 20px;
    text-align: center;
}

.settings-header h1 {
    color: white;
    font-size: 32px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin: 0;
}

.settings-subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 16px;
    margin: 8px 0 0 0;
}

/* NFC ìƒíƒœ í‘œì‹œ */
.nfc-status {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-width: 400px;
}

.nfc-indicator {
    display: flex;
    align-items: center;
    gap: 12px;
}

.nfc-light {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: #666;
    transition: all 0.3s ease;
}

.nfc-light.active {
    background: #4CAF50;
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
}

.nfc-light.waiting {
    background: #FF9800;
    box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
}

.nfc-status-text {
    color: rgba(255, 255, 255, 0.9);
    font-size: 16px;
    font-weight: 500;
}

.nfc-uid-display {
    display: flex;
    align-items: center;
    gap: 8px;
}

.nfc-uid-display label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 14px;
}

.nfc-uid-display span {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 6px;
    padding: 6px 12px;
    color: rgba(255, 255, 255, 0.9);
    font-family: monospace;
    font-size: 14px;
    min-width: 120px;
    text-align: center;
}

/* ì•¡ì…˜ ë²„íŠ¼ë“¤ */
.action-buttons {
    display: flex;
    gap: 12px;
    margin-bottom: 30px;
}

.action-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 14px 24px;
    cursor: pointer;
    font-size: 16px;
    color: white;
    transition: all 0.3s ease;
    font-weight: 600;
}

.action-btn:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
}

.action-btn:active:not(:disabled) {
    transform: translateY(0);
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.action-btn-save {
    background: rgba(76, 175, 80, 0.3);
    border-color: rgba(76, 175, 80, 0.5);
}

.action-btn-save:hover:not(:disabled) {
    background: rgba(76, 175, 80, 0.5);
}

.action-btn-unregister {
    background: rgba(244, 67, 54, 0.3);
    border-color: rgba(244, 67, 54, 0.5);
}

.action-btn-unregister:hover:not(:disabled) {
    background: rgba(244, 67, 54, 0.5);
}

/* ë½ì»¤ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ */
.locker-grid-container {
    max-width: 1200px;
    width: 100%;
}

/* êµ¬ì—­ ì„¹ì…˜ */
.zone-section {
    margin-bottom: 40px;
}

.zone-title {
    color: white;
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 16px;
    text-align: center;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

/* ë½ì»¤ ê·¸ë¦¬ë“œ */
.locker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

/* ë½ì»¤ ì¹´ë“œ */
.locker-card {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 16px 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.locker-card:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.locker-card.selected {
    background: rgba(255, 215, 0, 0.2);
    border-color: #FFD700;
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
}

.locker-card.registered {
    background: rgba(76, 175, 80, 0.15);
    border-color: rgba(76, 175, 80, 0.4);
}

.locker-number {
    font-size: 18px;
    font-weight: bold;
    color: white;
    margin-bottom: 4px;
}

.nfc-uid {
    font-size: 12px;
    font-family: monospace;
    color: rgba(255, 255, 255, 0.7);
    word-break: break-all;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
    .locker-grid {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
    }

    .locker-card {
        padding: 12px 8px;
        min-height: 70px;
    }

    .nfc-status {
        flex-direction: column;
        gap: 12px;
        min-width: auto;
    }

    .action-buttons {
        flex-direction: column;
        width: 100%;
        max-width: 300px;
    }

    .action-btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// ì „ì—­ ìƒíƒœ
let selectedLocker = null;
let currentNfcUid = null;
let lockerMappings = {};
let barcodePollingInterval = null;

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    loadLockerMappings();
    startBarcodePolling();
});

// ë½ì»¤ ë§¤í•‘ ë°ì´í„° ë¡œë“œ
async function loadLockerMappings() {
    try {
        const response = await fetch('/api/nfc/mappings');
        const data = await response.json();

        if (data.success) {
            lockerMappings = {};

            // ë§¤í•‘ ë°ì´í„°ë¥¼ ê°ì²´ë¡œ ë³€í™˜ (ë¹ ë¥¸ ì¡°íšŒìš©)
            data.mappings.forEach(mapping => {
                lockerMappings[mapping.locker_number] = mapping.nfc_uid || null;
            });

            renderLockerGrids(data.grouped);
        } else {
            showAlert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    } catch (error) {
        console.error('ë§¤í•‘ ë¡œë“œ ì˜¤ë¥˜:', error);
        showAlert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë½ì»¤ ê·¸ë¦¬ë“œ ë Œë”ë§
function renderLockerGrids(grouped) {
    renderZoneGrid('staffGrid', grouped.STAFF || [], 'S', 10);
    renderZoneGrid('maleGrid', grouped.MALE || [], 'M', 40);
    renderZoneGrid('femaleGrid', grouped.FEMALE || [], 'F', 10);
}

// êµ¬ì—­ë³„ ê·¸ë¦¬ë“œ ë Œë”ë§
function renderZoneGrid(gridId, mappings, prefix, count) {
    const grid = document.getElementById(gridId);
    grid.innerHTML = '';

    for (let i = 1; i <= count; i++) {
        const lockerNumber = `${prefix}${i.toString().padStart(2, '0')}`;
        const nfcUid = mappings.find(m => m.locker_number === lockerNumber)?.nfc_uid || null;

        const card = createLockerCard(lockerNumber, nfcUid);
        grid.appendChild(card);
    }
}

// ë½ì»¤ ì¹´ë“œ ìƒì„±
function createLockerCard(lockerNumber, nfcUid) {
    const card = document.createElement('div');
    card.className = `locker-card ${nfcUid ? 'registered' : ''}`;
    card.dataset.lockerNumber = lockerNumber;

    card.innerHTML = `
        <div class="locker-number">${lockerNumber}</div>
        <div class="nfc-uid">${nfcUid ? nfcUid.substring(0, 6) + '...' : '---'}</div>
    `;

    card.addEventListener('click', () => selectLocker(lockerNumber));
    return card;
}

// ë½ì»¤ ì„ íƒ
function selectLocker(lockerNumber) {
    // ì´ì „ ì„ íƒ í•´ì œ
    if (selectedLocker) {
        const prevCard = document.querySelector(`[data-locker-number="${selectedLocker}"]`);
        if (prevCard) {
            prevCard.classList.remove('selected');
        }
    }

    // ìƒˆ ì„ íƒ
    selectedLocker = lockerNumber;
    const card = document.querySelector(`[data-locker-number="${lockerNumber}"]`);
    if (card) {
        card.classList.add('selected');
    }

    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateButtonStates();
}

// ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateButtonStates() {
    const saveBtn = document.getElementById('saveBtn');
    const unregisterBtn = document.getElementById('unregisterBtn');

    if (selectedLocker && currentNfcUid) {
        saveBtn.disabled = false;
    } else {
        saveBtn.disabled = true;
    }

    if (selectedLocker && lockerMappings[selectedLocker]) {
        unregisterBtn.disabled = false;
    } else {
        unregisterBtn.disabled = true;
    }
}

// ë°”ì½”ë“œ í´ë§ ì‹œì‘
function startBarcodePolling() {
    barcodePollingInterval = setInterval(async () => {
        try {
            const response = await fetch('/api/barcode/poll');
            const data = await response.json();

            if (data.has_barcode && data.barcode) {
                onNfcDetected(data.barcode);
            }
        } catch (error) {
            console.error('ë°”ì½”ë“œ í´ë§ ì˜¤ë¥˜:', error);
        }
    }, 1000); // 1ì´ˆë§ˆë‹¤ í´ë§
}

// NFC ê°ì§€ ì²˜ë¦¬
function onNfcDetected(nfcUid) {
    currentNfcUid = nfcUid.toUpperCase();

    // UI ì—…ë°ì´íŠ¸
    document.getElementById('currentNfcUid').textContent = currentNfcUid;
    document.getElementById('nfcLight').className = 'nfc-light active';
    document.getElementById('nfcStatusText').textContent = 'NFC íƒœê·¸ ê°ì§€ë¨';

    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateButtonStates();

    // 3ì´ˆ í›„ ìƒíƒœ ë¦¬ì…‹ (ìƒˆ íƒœê·¸ ê°ì§€ ì¤€ë¹„)
    setTimeout(() => {
        if (currentNfcUid === nfcUid.toUpperCase()) {
            document.getElementById('nfcLight').className = 'nfc-light';
            document.getElementById('nfcStatusText').textContent = 'NFC ë¦¬ë”ê¸°ë¥¼ ì¤€ë¹„í•˜ì„¸ìš”';
        }
    }, 3000);
}

// ì €ì¥ ë²„íŠ¼ í´ë¦­
async function saveNfc() {
    if (!selectedLocker || !currentNfcUid) {
        showAlert('ë½ì»¤ì™€ NFC íƒœê·¸ë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const response = await fetch('/api/nfc/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                locker_number: selectedLocker,
                nfc_uid: currentNfcUid
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert(`âœ… ${data.message}`);

            // UI ì—…ë°ì´íŠ¸
            lockerMappings[selectedLocker] = currentNfcUid;
            updateLockerCard(selectedLocker, currentNfcUid);

            // ìƒíƒœ ì´ˆê¸°í™”
            currentNfcUid = null;
            document.getElementById('currentNfcUid').textContent = '---';
            updateButtonStates();
        } else {
            showAlert(`âŒ ë“±ë¡ ì‹¤íŒ¨: ${data.error}`);
        }
    } catch (error) {
        console.error('NFC ë“±ë¡ ì˜¤ë¥˜:', error);
        showAlert('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// í•´ì œ ë²„íŠ¼ í´ë¦­
async function unregisterNfc() {
    if (!selectedLocker) {
        showAlert('ë½ì»¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    if (!confirm(`${selectedLocker}ì˜ NFC ë“±ë¡ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/nfc/unregister/${selectedLocker}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showAlert(`âœ… ${data.message}`);

            // UI ì—…ë°ì´íŠ¸
            lockerMappings[selectedLocker] = null;
            updateLockerCard(selectedLocker, null);

            // ìƒíƒœ ì´ˆê¸°í™”
            updateButtonStates();
        } else {
            showAlert(`âŒ í•´ì œ ì‹¤íŒ¨: ${data.error}`);
        }
    } catch (error) {
        console.error('NFC í•´ì œ ì˜¤ë¥˜:', error);
        showAlert('í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë½ì»¤ ì¹´ë“œ ì—…ë°ì´íŠ¸
function updateLockerCard(lockerNumber, nfcUid) {
    const card = document.querySelector(`[data-locker-number="${lockerNumber}"]`);
    if (card) {
        const nfcUidElement = card.querySelector('.nfc-uid');

        if (nfcUid) {
            card.classList.add('registered');
            nfcUidElement.textContent = nfcUid.substring(0, 6) + '...';
        } else {
            card.classList.remove('registered');
            nfcUidElement.textContent = '---';
        }
    }
}

// ì•Œë¦¼ í‘œì‹œ
function showAlert(message) {
    // ê°„ë‹¨í•œ alert ì‚¬ìš© (ë˜ëŠ” ëª¨ë‹¬ êµ¬í˜„ ê°€ëŠ¥)
    alert(message);
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.getElementById('saveBtn').addEventListener('click', saveNfc);
document.getElementById('unregisterBtn').addEventListener('click', unregisterNfc);

// í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ í´ë§ ì¤‘ì§€
window.addEventListener('beforeunload', function() {
    if (barcodePollingInterval) {
        clearInterval(barcodePollingInterval);
    }
});
</script>
{% endblock %}

