{% extends "layouts/base.html" %}

{% block title %}ì–¼êµ´ì¸ì‹ ë“±ë¡{% endblock %}

{% block body_class %}settings-page{% endblock %}

{% block head %}
<style>
/* ê°€ìƒ í‚¤ë³´ë“œ ìŠ¤íƒ€ì¼ */
.virtual-keyboard {
    margin-top: 15px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 12px;
    padding: 12px;
    position: relative;
    z-index: 9999;
}
.keyboard-row {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-bottom: 5px;
}
.key {
    min-width: 48px;
    height: 48px;
    font-size: 20px;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.2);
    color: white;
    cursor: pointer;
    transition: all 0.1s;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    position: relative;
    z-index: 10000;
    font-family: 'Noto Sans KR', 'Noto Sans CJK KR', 'NanumGothic', sans-serif;
}

#searchInput {
    font-family: 'Noto Sans KR', 'Noto Sans CJK KR', 'NanumGothic', sans-serif;
}
.key:active, .key:focus {
    background: rgba(76, 175, 80, 0.7);
    transform: scale(0.95);
}
.key-wide {
    min-width: 80px;
    font-size: 14px;
}
.key-space {
    min-width: 180px;
}
.lang-switch {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
}
.lang-btn {
    padding: 8px 25px;
    font-size: 16px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    background: rgba(255,255,255,0.1);
    color: white;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    z-index: 10000;
}
.lang-btn.active {
    background: rgba(76, 175, 80, 0.6);
    border-color: #4caf50;
}

/* ë‹¤ë¥¸ ìš”ì†Œë“¤ì´ í‚¤ë³´ë“œë¥¼ ë®ì§€ ì•Šë„ë¡ */
.search-section {
    position: relative;
    z-index: 100;
}
</style>
{% endblock %}

{% block content %}
<div class="face-register-container">
    <!-- ì¢Œì¸¡ ìƒë‹¨: ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <div class="back-button-container">
        <button class="back-button" onclick="window.location.href='/'">
            â† í™ˆìœ¼ë¡œ
        </button>
    </div>

    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="page-header">
        <h1>ğŸ‘¤ ì–¼êµ´ì¸ì‹ ë“±ë¡</h1>
    </div>

    <!-- 1ë‹¨ê³„: íšŒì› ê²€ìƒ‰ -->
    <div class="search-section">
        <h2>1ë‹¨ê³„: íšŒì› ê²€ìƒ‰</h2>
        <div class="search-info">
            <p>ğŸ“ ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜ ğŸ“± ë°”ì½”ë“œ/QRì„ ìŠ¤ìº”í•˜ì„¸ìš”</p>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="íšŒì› ì´ë¦„ ì…ë ¥ ë˜ëŠ” ë°”ì½”ë“œ/QR ìŠ¤ìº”" autocomplete="off">
            <button onclick="searchMembers()" id="searchBtn">ğŸ” ê²€ìƒ‰</button>
        </div>
        
        <!-- ê°€ìƒ í‚¤ë³´ë“œ -->
        <div class="virtual-keyboard">
            <div class="lang-switch">
                <button class="lang-btn active" id="btnKorean" onclick="setLang('ko')">í•œê¸€</button>
                <button class="lang-btn" id="btnEnglish" onclick="setLang('en')">English</button>
            </div>
            <div id="keyboardKorean">
                <div class="keyboard-row">
                    <button class="key" onclick="typeKey('ã…‚')">ã…‚</button>
                    <button class="key" onclick="typeKey('ã…ˆ')">ã…ˆ</button>
                    <button class="key" onclick="typeKey('ã„·')">ã„·</button>
                    <button class="key" onclick="typeKey('ã„±')">ã„±</button>
                    <button class="key" onclick="typeKey('ã……')">ã……</button>
                    <button class="key" onclick="typeKey('ã…›')">ã…›</button>
                    <button class="key" onclick="typeKey('ã…•')">ã…•</button>
                    <button class="key" onclick="typeKey('ã…‘')">ã…‘</button>
                    <button class="key" onclick="typeKey('ã…')">ã…</button>
                    <button class="key" onclick="typeKey('ã…”')">ã…”</button>
                </div>
                <div class="keyboard-row">
                    <button class="key" onclick="typeKey('ã…')">ã…</button>
                    <button class="key" onclick="typeKey('ã„´')">ã„´</button>
                    <button class="key" onclick="typeKey('ã…‡')">ã…‡</button>
                    <button class="key" onclick="typeKey('ã„¹')">ã„¹</button>
                    <button class="key" onclick="typeKey('ã…')">ã…</button>
                    <button class="key" onclick="typeKey('ã…—')">ã…—</button>
                    <button class="key" onclick="typeKey('ã…“')">ã…“</button>
                    <button class="key" onclick="typeKey('ã…')">ã…</button>
                    <button class="key" onclick="typeKey('ã…£')">ã…£</button>
                </div>
                <div class="keyboard-row">
                    <button class="key" onclick="typeKey('ã…‹')">ã…‹</button>
                    <button class="key" onclick="typeKey('ã…Œ')">ã…Œ</button>
                    <button class="key" onclick="typeKey('ã…Š')">ã…Š</button>
                    <button class="key" onclick="typeKey('ã…')">ã…</button>
                    <button class="key" onclick="typeKey('ã… ')">ã… </button>
                    <button class="key" onclick="typeKey('ã…œ')">ã…œ</button>
                    <button class="key" onclick="typeKey('ã…¡')">ã…¡</button>
                    <button class="key key-wide" onclick="backspace()">âŒ«</button>
                </div>
                <div class="keyboard-row">
                    <button class="key key-wide" onclick="typeKey('ã…ƒ')">ã…ƒ</button>
                    <button class="key key-wide" onclick="typeKey('ã…‰')">ã…‰</button>
                    <button class="key key-wide" onclick="typeKey('ã„¸')">ã„¸</button>
                    <button class="key key-wide" onclick="typeKey('ã„²')">ã„²</button>
                    <button class="key key-wide" onclick="typeKey('ã…†')">ã…†</button>
                </div>
                <div class="keyboard-row">
                    <button class="key key-space" onclick="typeKey(' ')">ìŠ¤í˜ì´ìŠ¤</button>
                    <button class="key key-wide" onclick="searchMembers()" style="background:rgba(76,175,80,0.5)">ğŸ”ê²€ìƒ‰</button>
                </div>
            </div>
            <div id="keyboardEnglish" style="display:none;">
                <div class="keyboard-row">
                    <button class="key" onclick="typeKey('Q')">Q</button>
                    <button class="key" onclick="typeKey('W')">W</button>
                    <button class="key" onclick="typeKey('E')">E</button>
                    <button class="key" onclick="typeKey('R')">R</button>
                    <button class="key" onclick="typeKey('T')">T</button>
                    <button class="key" onclick="typeKey('Y')">Y</button>
                    <button class="key" onclick="typeKey('U')">U</button>
                    <button class="key" onclick="typeKey('I')">I</button>
                    <button class="key" onclick="typeKey('O')">O</button>
                    <button class="key" onclick="typeKey('P')">P</button>
                </div>
                <div class="keyboard-row">
                    <button class="key" onclick="typeKey('A')">A</button>
                    <button class="key" onclick="typeKey('S')">S</button>
                    <button class="key" onclick="typeKey('D')">D</button>
                    <button class="key" onclick="typeKey('F')">F</button>
                    <button class="key" onclick="typeKey('G')">G</button>
                    <button class="key" onclick="typeKey('H')">H</button>
                    <button class="key" onclick="typeKey('J')">J</button>
                    <button class="key" onclick="typeKey('K')">K</button>
                    <button class="key" onclick="typeKey('L')">L</button>
                </div>
                <div class="keyboard-row">
                    <button class="key" onclick="typeKey('Z')">Z</button>
                    <button class="key" onclick="typeKey('X')">X</button>
                    <button class="key" onclick="typeKey('C')">C</button>
                    <button class="key" onclick="typeKey('V')">V</button>
                    <button class="key" onclick="typeKey('B')">B</button>
                    <button class="key" onclick="typeKey('N')">N</button>
                    <button class="key" onclick="typeKey('M')">M</button>
                    <button class="key key-wide" onclick="backspace()">âŒ«</button>
                </div>
                <div class="keyboard-row">
                    <button class="key key-space" onclick="typeKey(' ')">Space</button>
                    <button class="key key-wide" onclick="searchMembers()" style="background:rgba(76,175,80,0.5)">ğŸ”Search</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2ë‹¨ê³„: ê²€ìƒ‰ ê²°ê³¼ -->
    <div class="results-section" id="resultsSection" style="display:none;">
        <h2>ê²€ìƒ‰ ê²°ê³¼</h2>
        <div id="membersList" class="members-list">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
        </div>
    </div>

    <!-- 3ë‹¨ê³„: ì¹´ë©”ë¼ ì´¬ì˜ -->
    <div class="camera-section" id="cameraSection" style="display:none;">
        <h2>2ë‹¨ê³„: ì–¼êµ´ ì´¬ì˜</h2>

        <div class="selected-member-info" id="selectedMemberInfo">
            <!-- ë™ì ìœ¼ë¡œ í‘œì‹œ -->
        </div>

        <div class="camera-preview">
            <img id="cameraFeed" src="" alt="ì¹´ë©”ë¼" style="display:none;">
            <div class="face-guide-overlay" id="faceGuide"></div>
            <div class="face-status-overlay" id="faceStatusOverlay">
                <div class="face-detection-status" id="faceDetectionStatus">
                    <span class="status-icon">ğŸ‘¤</span>
                    <span class="status-text" id="faceStatusText">ì–¼êµ´ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</span>
                </div>
                <div class="face-quality-bar" id="faceQualityBar" style="display:none;">
                    <div class="quality-fill" id="faceQualityFill"></div>
                </div>
            </div>
            <div class="camera-loading" id="cameraLoading">
                <div class="loading-spinner"></div>
                <p>ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</p>
            </div>
        </div>

        <div class="camera-controls">
            <button class="btn-register" onclick="registerFace()" id="registerBtn">
                ğŸ“· ì´¬ì˜ ë° ë“±ë¡
            </button>
            <button class="btn-cancel" onclick="cancelRegistration()">
                â† ë‹¤ì‹œ ì„ íƒ
            </button>
        </div>

        <div class="registration-status" id="statusMessage"></div>
    </div>
</div>

<style>
.face-register-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    max-width: 600px;
    margin: 0 auto;
}

/* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
.back-button-container {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
}

.back-button {
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 18px;
    color: white;
    transition: all 0.3s ease;
}

.back-button:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.05);
}

.back-button:active {
    transform: scale(0.95);
}

/* í˜ì´ì§€ í—¤ë” */
.page-header {
    margin-top: 60px;
    margin-bottom: 30px;
    text-align: center;
}

.page-header h1 {
    color: white;
    font-size: 28px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin: 0;
}

/* ê²€ìƒ‰ ì„¹ì…˜ */
.search-section {
    margin-bottom: 30px;
}

.search-section h2 {
    color: white;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 10px;
    text-align: center;
}

.search-info {
    text-align: center;
    margin-bottom: 15px;
}

.search-info p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
    margin: 0;
    background: rgba(76, 175, 80, 0.1);
    border: 1px solid rgba(76, 175, 80, 0.3);
    border-radius: 8px;
    padding: 8px 12px;
    display: inline-block;
}

.search-box {
    display: flex;
    gap: 10px;
    align-items: center;
}

.search-box input {
    flex: 1;
    padding: 15px 20px;
    font-size: 18px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    outline: none;
    transition: all 0.3s ease;
    font-family: 'Noto Sans KR', 'Noto Sans CJK KR', 'NanumGothic', 'Malgun Gothic', sans-serif !important;
}

.search-box input:focus {
    border-color: rgba(76, 175, 80, 0.6);
    background: rgba(255, 255, 255, 0.15);
}

.search-box input::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

/* Simple Keyboard ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
.simple-keyboard {
    margin-top: 20px;
    max-width: 100%;
}

.simple-keyboard .hg-button {
    height: 50px;
    font-size: 18px;
}

.search-box button {
    padding: 15px 20px;
    font-size: 18px;
    background: rgba(76, 175, 80, 0.4);
    border: 2px solid #4caf50;
    border-radius: 12px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.search-box button:hover {
    background: rgba(76, 175, 80, 0.6);
    transform: scale(1.05);
}

.search-box button:active {
    transform: scale(0.95);
}

/* ê²€ìƒ‰ ê²°ê³¼ ì„¹ì…˜ */
.results-section {
    margin-bottom: 30px;
}

.results-section h2 {
    color: white;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 15px;
    text-align: center;
}

.members-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.member-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    margin: 8px 0;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.member-item:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateX(5px);
    border-color: rgba(76, 175, 80, 0.4);
}

.member-item:active {
    transform: translateX(0);
}

.member-info {
    flex: 1;
}

.member-name {
    font-size: 18px;
    font-weight: bold;
    color: white;
    margin-bottom: 4px;
}

.member-id {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 2px;
}

.member-category {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
}

.face-status {
    margin-left: 15px;
}

.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
}

.badge-success {
    background: rgba(76, 175, 80, 0.3);
    color: #4caf50;
    border: 1px solid rgba(76, 175, 80, 0.5);
}

.badge-danger {
    background: rgba(244, 67, 54, 0.3);
    color: #f44336;
    border: 1px solid rgba(244, 67, 54, 0.5);
}

.no-results {
    text-align: center;
    color: rgba(255, 255, 255, 0.6);
    font-style: italic;
    padding: 40px 20px;
}

/* ì¹´ë©”ë¼ ì„¹ì…˜ */
.camera-section {
    text-align: center;
}

.camera-section h2 {
    color: white;
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 20px;
}

.selected-member-info {
    background: rgba(76, 175, 80, 0.2);
    border: 2px solid rgba(76, 175, 80, 0.4);
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 20px;
    color: white;
    font-weight: bold;
}

.camera-preview {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: 0 auto 20px;
    border: 3px solid rgba(76, 175, 80, 0.5);
    border-radius: 20px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.3);
    aspect-ratio: 4/3;
}

.camera-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transform: scaleX(-1); /* ì¢Œìš° ë°˜ì „ (ê±°ìš¸ ëª¨ë“œ) */
}

.face-guide-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 180px;
    height: 240px;
    border: 3px dashed rgba(255, 255, 255, 0.5);
    border-radius: 50% 50% 45% 45%;
    pointer-events: none;
    transition: border-color 0.3s ease;
}

.face-guide-overlay.face-detected {
    border-color: #4caf50;
    border-style: solid;
    box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
}

.face-guide-overlay.face-good-quality {
    border-color: #4caf50;
    box-shadow: 0 0 30px rgba(76, 175, 80, 0.5);
}

/* ì–¼êµ´ ìƒíƒœ ì˜¤ë²„ë ˆì´ */
.face-status-overlay {
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    z-index: 10;
    pointer-events: none;
}

.face-detection-status {
    background: rgba(0, 0, 0, 0.7);
    border-radius: 8px;
    padding: 8px 12px;
    color: white;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    transition: all 0.3s ease;
}

.face-detection-status.detected {
    background: rgba(76, 175, 80, 0.8);
}

.face-detection-status.good-quality {
    background: rgba(76, 175, 80, 0.9);
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.4);
}

.status-icon {
    font-size: 16px;
}

.status-text {
    flex: 1;
    text-align: center;
}

/* ì–¼êµ´ í’ˆì§ˆ ë°” */
.face-quality-bar {
    background: rgba(0, 0, 0, 0.5);
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
    margin-top: 4px;
}

.quality-fill {
    height: 100%;
    background: linear-gradient(90deg, #f44336 0%, #ff9800 30%, #4caf50 70%, #4caf50 100%);
    border-radius: 10px;
    transition: width 0.3s ease;
    width: 0%;
}

.camera-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: white;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #4caf50;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.camera-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

.btn-register {
    padding: 18px 30px;
    font-size: 18px;
    font-weight: bold;
    background: rgba(76, 175, 80, 0.4);
    border: 2px solid #4caf50;
    border-radius: 12px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-register:hover {
    background: rgba(76, 175, 80, 0.6);
    transform: scale(1.02);
}

.btn-register:active {
    transform: scale(0.98);
}

.btn-register:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
    background: rgba(100, 100, 100, 0.3);
    border-color: rgba(100, 100, 100, 0.5);
}

.btn-register.ready {
    background: rgba(76, 175, 80, 0.6);
    border-color: #4caf50;
    box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
    animation: pulse-ready 2s infinite;
}

@keyframes pulse-ready {
    0%, 100% {
        box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
    }
    50% {
        box-shadow: 0 0 25px rgba(76, 175, 80, 0.6);
    }
}

.btn-cancel {
    padding: 12px 20px;
    font-size: 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-cancel:hover {
    background: rgba(255, 255, 255, 0.2);
}

.btn-cancel:active {
    transform: scale(0.95);
}

.registration-status {
    min-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.status-processing {
    color: #4caf50;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
}

.status-success {
    color: #4caf50;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    background: rgba(76, 175, 80, 0.1);
    border: 2px solid rgba(76, 175, 80, 0.3);
    border-radius: 12px;
    padding: 15px 20px;
}

.status-error {
    color: #f44336;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
}

.status-help {
    color: rgba(255, 255, 255, 0.6);
    font-size: 14px;
    margin-top: 8px;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 480px) {
    .face-register-container {
        padding: 15px;
    }

    .search-box {
        flex-direction: column;
        gap: 12px;
    }

    .search-box input {
        font-size: 16px; /* iOS í™•ëŒ€ ë°©ì§€ */
        padding: 12px 16px;
    }

    .search-box button {
        width: 100%;
        padding: 12px;
    }

    .member-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }

    .face-status {
        margin-left: 0;
        align-self: flex-end;
    }

    .camera-preview {
        max-width: 100%;
    }

    .btn-register {
        padding: 15px 25px;
        font-size: 16px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<!-- Hangul.js for Korean character composition (ë¡œì»¬) -->
<script src="/static/js/hangul.min.js"></script>

<script>
let selectedMemberId = null;
let selectedMemberName = null;
let currentLang = 'ko';
let jamoBuffer = []; // í•œê¸€ ìëª¨ ë²„í¼
let barcodePollingInterval = null; // ë°”ì½”ë“œ í´ë§ ì¸í„°ë²Œ
let faceDetectionInterval = null; // ì–¼êµ´ ê²€ì¶œ í´ë§ ì¸í„°ë²Œ
let isRegisteringFace = false; // ë“±ë¡ ì§„í–‰ ì¤‘ í”Œë˜ê·¸

// í˜ì´ì§€ ë¡œë“œ ì‹œ í„°ì¹˜ ì´ë²¤íŠ¸ ë°”ì¸ë”©
document.addEventListener('DOMContentLoaded', function() {
    // ëª¨ë“  í‚¤ ë²„íŠ¼ì— í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('.key').forEach(function(btn) {
        btn.addEventListener('touchend', function(e) {
            e.preventDefault();
            
            // onclick ì†ì„±ì—ì„œ í•¨ìˆ˜ í˜¸ì¶œ ì •ë³´ ì¶”ì¶œí•˜ì—¬ ì§ì ‘ ì‹¤í–‰
            const onclickAttr = this.getAttribute('onclick');
            if (onclickAttr) {
                try {
                    // "typeKey('ã…‚')" í˜•íƒœì—ì„œ ë¬¸ì ì¶”ì¶œ
                    const match = onclickAttr.match(/typeKey\('(.+)'\)/);
                    if (match) {
                        const char = match[1];
                        console.log('ğŸ”¤ í„°ì¹˜ ì…ë ¥:', char);
                        typeKey(char);
                    } else if (onclickAttr.includes('backspace')) {
                        console.log('âŒ« í„°ì¹˜ ë°±ìŠ¤í˜ì´ìŠ¤');
                        backspace();
                    }
                } catch (error) {
                    console.error('í„°ì¹˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ click() í˜¸ì¶œ
                    this.click();
                }
            }
        }, {passive: false});
    });
    
    // ì–¸ì–´ ì „í™˜ ë²„íŠ¼
    document.querySelectorAll('.lang-btn').forEach(function(btn) {
        btn.addEventListener('touchend', function(e) {
            e.preventDefault();
            this.click();
        }, {passive: false});
    });
    
    // ğŸš€ ë¬¼ë¦¬ í‚¤ë³´ë“œ ì…ë ¥ ì§€ì› ì¶”ê°€
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        // ê²€ìƒ‰ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ ìœ ì§€
        searchInput.focus();
        
        // ë¬¼ë¦¬ í‚¤ë³´ë“œ ì…ë ¥ í—ˆìš©
        searchInput.addEventListener('input', function(e) {
            console.log('ğŸ’» ë¬¼ë¦¬ í‚¤ë³´ë“œ ì…ë ¥:', e.target.value);
        });
        
        // í¬ì»¤ìŠ¤ ìƒì—ˆì„ ë•Œ ë‹¤ì‹œ í¬ì»¤ìŠ¤ ì„¤ì • (í„°ì¹˜ìŠ¤í¬ë¦° í™˜ê²½)
        searchInput.addEventListener('blur', function() {
            setTimeout(() => {
                if (document.activeElement !== searchInput) {
                    searchInput.focus();
                }
            }, 100);
        });
    }
    
    // ë°”ì½”ë“œ í´ë§ ì‹œì‘
    console.log('ğŸ“± ë°”ì½”ë“œ í´ë§ ì‹œì‘ ì¤€ë¹„...');
    startBarcodePolling();
    
    console.log('í‚¤ë³´ë“œ í„°ì¹˜ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì™„ë£Œ');
    console.log('ğŸ’» ë¬¼ë¦¬ í‚¤ë³´ë“œ ì…ë ¥ ì§€ì› í™œì„±í™”');
    console.log('ğŸ“± ë°”ì½”ë“œ í´ë§ í™œì„±í™”ë¨');
});

// ë°”ì½”ë“œ í´ë§ ì‹œì‘
function startBarcodePolling() {
    if (barcodePollingInterval) {
        console.log('ğŸ“± ë°”ì½”ë“œ í´ë§ì´ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤');
        return;
    }
    
    console.log('ğŸ“± ë°”ì½”ë“œ í´ë§ ì‹œì‘ - 300ms ê°„ê²©');
    barcodePollingInterval = setInterval(() => {
        fetch('/api/barcode/poll', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                // í•­ìƒ ì‘ë‹µì„ ë¡œê·¸ (ì²« 5ì´ˆë§Œ)
                if (Date.now() - startTime < 5000) {
                    console.log('ğŸ“± ë°”ì½”ë“œ í´ë§ ì‘ë‹µ:', data);
                }
                
                if (data.has_barcode && data.barcode) {
                    console.log('ğŸ¯ ë°”ì½”ë“œ ê°ì§€:', data.barcode, data);
                    handleBarcodeDetected(data.barcode);
                }
            })
            .catch(error => {
                console.log('âŒ ë°”ì½”ë“œ í´ë§ ì—ëŸ¬:', error);
            });
    }, 300); // 300ms ê°„ê²©ìœ¼ë¡œ í´ë§
}

// ì‹œì‘ ì‹œê°„ ê¸°ë¡
let startTime = Date.now();

// ë°”ì½”ë“œ í´ë§ ì¤‘ì§€
function stopBarcodePolling() {
    if (barcodePollingInterval) {
        clearInterval(barcodePollingInterval);
        barcodePollingInterval = null;
        console.log('ë°”ì½”ë“œ í´ë§ ì¤‘ì§€');
    }
}

// ë°”ì½”ë“œ ê°ì§€ ì²˜ë¦¬
function handleBarcodeDetected(barcodeCode) {
    if (!barcodeCode || barcodeCode.trim().length === 0) return;
    
    const code = barcodeCode.trim();
    console.log('ğŸ” ë°”ì½”ë“œ ì²˜ë¦¬:', code);
    
    // ê²€ìƒ‰ ì…ë ¥ì°½ì— ë°”ì½”ë“œ ê°’ ì„¤ì •
    const searchInput = document.getElementById('searchInput');
    searchInput.value = code;
    
    // ì‹œê°ì  í”¼ë“œë°±
    searchInput.style.backgroundColor = 'rgba(76, 175, 80, 0.3)';
    searchInput.style.borderColor = '#4caf50';
    
    // ìë™ìœ¼ë¡œ ê²€ìƒ‰ ì‹¤í–‰
    setTimeout(() => {
        searchMembers();
        
        // í”¼ë“œë°± ì œê±°
        setTimeout(() => {
            searchInput.style.backgroundColor = '';
            searchInput.style.borderColor = '';
        }, 1000);
    }, 200);
}

// ì–¸ì–´ ì „í™˜
function setLang(lang) {
    currentLang = lang;
    document.getElementById('btnKorean').classList.toggle('active', lang === 'ko');
    document.getElementById('btnEnglish').classList.toggle('active', lang === 'en');
    document.getElementById('keyboardKorean').style.display = lang === 'ko' ? 'block' : 'none';
    document.getElementById('keyboardEnglish').style.display = lang === 'en' ? 'block' : 'none';
}

// í‚¤ ì…ë ¥
function typeKey(char) {
    const input = document.getElementById('searchInput');
    
    console.log(`ğŸ”¤ typeKey í˜¸ì¶œ: "${char}", currentLang: ${currentLang}, isJamo: ${isJamo(char)}`);
    console.log(`ğŸ”¤ í˜„ì¬ jamoBuffer:`, jamoBuffer);
    console.log(`ğŸ”¤ ì…ë ¥ ì „ ê°’: "${input.value}"`);
    
    if (currentLang === 'ko' && isJamo(char)) {
        // í•œê¸€ ìëª¨ ì¡°í•©
        jamoBuffer.push(char);
        const assembled = Hangul.assemble(jamoBuffer);
        input.value = assembled;
        console.log(`ğŸ”¤ í•œê¸€ ì¡°í•© ê²°ê³¼: "${assembled}", jamoBuffer:`, jamoBuffer);
    } else {
        // ì˜ì–´ ë˜ëŠ” ìŠ¤í˜ì´ìŠ¤
        if (jamoBuffer.length > 0) {
            jamoBuffer = [];
        }
        input.value += char;
        jamoBuffer = Hangul.disassemble(input.value);
        console.log(`ğŸ”¤ ì˜ì–´/ìŠ¤í˜ì´ìŠ¤ ì…ë ¥ ê²°ê³¼: "${input.value}"`);
    }
}

// ìëª¨ì¸ì§€ í™•ì¸
function isJamo(char) {
    const jamoList = 'ã„±ã„²ã„´ã„·ã„¸ã„¹ã…ã…‚ã…ƒã……ã…†ã…‡ã…ˆã…‰ã…Šã…‹ã…Œã…ã…ã…ã…ã…‘ã…’ã…“ã…”ã…•ã…–ã…—ã…˜ã…™ã…šã…›ã…œã…ã…ã…Ÿã… ã…¡ã…¢ã…£';
    return jamoList.includes(char);
}

// ë°±ìŠ¤í˜ì´ìŠ¤
function backspace() {
    const input = document.getElementById('searchInput');
    if (jamoBuffer.length > 0) {
        jamoBuffer.pop();
        input.value = Hangul.assemble(jamoBuffer);
    } else if (input.value.length > 0) {
        input.value = input.value.slice(0, -1);
        jamoBuffer = Hangul.disassemble(input.value);
    }
}

// íšŒì› ê²€ìƒ‰
function searchMembers() {
    const query = document.getElementById('searchInput').value.trim();

    if (query.length === 0) {
        alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
        return;
    }

    // ê²€ìƒ‰ ë²„íŠ¼ ë¹„í™œì„±í™”
    const searchBtn = document.getElementById('searchBtn');
    const originalText = searchBtn.textContent;
    searchBtn.disabled = true;
    searchBtn.textContent = 'ğŸ” ê²€ìƒ‰ ì¤‘...';

    fetch(`/api/members/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.members);
            } else {
                alert('ê²€ìƒ‰ ì‹¤íŒ¨: ' + data.error);
                document.getElementById('resultsSection').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            document.getElementById('resultsSection').style.display = 'none';
        })
        .finally(() => {
            // ë²„íŠ¼ ë³µêµ¬
            searchBtn.disabled = false;
            searchBtn.textContent = originalText;
        });
}

// ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
function displaySearchResults(members) {
    const resultsSection = document.getElementById('resultsSection');
    const membersList = document.getElementById('membersList');

    if (members.length === 0) {
        membersList.innerHTML = '<p class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    } else {
        membersList.innerHTML = members.map(m => `
            <div class="member-item" onclick="selectMember('${m.member_id}', '${m.member_name}', '${m.member_category}')">
                <div class="member-info">
                    <div class="member-name">${m.member_name}</div>
                    <div class="member-id">${m.member_id}</div>
                    <div class="member-category">${getCategoryLabel(m.member_category)}</div>
                </div>
                <div class="face-status">
                    ${m.face_registered
                        ? '<span class="badge badge-success">âœ… ë“±ë¡ë¨</span>'
                        : '<span class="badge badge-danger">âŒ ë¯¸ë“±ë¡</span>'}
                </div>
            </div>
        `).join('');
    }

    resultsSection.style.display = 'block';
    document.getElementById('cameraSection').style.display = 'none';
}

// ì¹´í…Œê³ ë¦¬ ë¼ë²¨ ë³€í™˜
function getCategoryLabel(category) {
    const labels = {
        'staff': 'êµì§ì›',
        'male': 'ë‚¨ì„±',
        'female': 'ì—¬ì„±'
    };
    return labels[category] || category;
}

// íšŒì› ì„ íƒ
function selectMember(memberId, memberName, memberCategory) {
    selectedMemberId = memberId;
    selectedMemberName = memberName;

    // ì„ íƒëœ íšŒì› ì •ë³´ í‘œì‹œ
    const infoEl = document.getElementById('selectedMemberInfo');
    const categoryLabel = getCategoryLabel(memberCategory);
    infoEl.innerHTML = `<strong>ì„ íƒëœ íšŒì›:</strong> ${memberName} (${memberId}) - ${categoryLabel}`;

    // ì¹´ë©”ë¼ ì„¹ì…˜ í‘œì‹œ
    document.getElementById('cameraSection').style.display = 'block';

    // ë“±ë¡ ë²„íŠ¼ ë¹„í™œì„±í™” (ì–¼êµ´ ê²€ì¶œ ì „ê¹Œì§€)
    const registerBtn = document.getElementById('registerBtn');
    registerBtn.disabled = true;
    registerBtn.textContent = 'ğŸ‘¤ ì–¼êµ´ì„ ì¸ì‹í•˜ëŠ” ì¤‘...';
    registerBtn.classList.remove('ready');

    // ì¹´ë©”ë¼ í”¼ë“œ ì‹œì‘
    const cameraFeed = document.getElementById('cameraFeed');
    const cameraLoading = document.getElementById('cameraLoading');

    cameraLoading.style.display = 'block';
    cameraFeed.style.display = 'none';

    // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì‹œì‘
    cameraFeed.src = '/api/video_feed?' + Date.now();

    cameraFeed.onload = function() {
        cameraLoading.style.display = 'none';
        cameraFeed.style.display = 'block';
        
        // ì¹´ë©”ë¼ ë¡œë“œ ì™„ë£Œ í›„ ì–¼êµ´ ê²€ì¶œ ì‹œì‘
        startFaceDetection();
    };

    // ìŠ¤í¬ë¡¤
    document.getElementById('cameraSection').scrollIntoView({ behavior: 'smooth' });
}

// ì‹¤ì‹œê°„ ì–¼êµ´ ê²€ì¶œ ì‹œì‘
function startFaceDetection() {
    if (faceDetectionInterval) {
        clearInterval(faceDetectionInterval);
    }
    
    console.log('ğŸ‘¤ ì‹¤ì‹œê°„ ì–¼êµ´ ê²€ì¶œ ì‹œì‘');
    
    faceDetectionInterval = setInterval(() => {
        if (isRegisteringFace) {
            return; // ë“±ë¡ ì¤‘ì—ëŠ” ê²€ì¶œ ì¤‘ì§€
        }
        
        fetch('/api/face/detect-quality', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                updateFaceDetectionUI(data);
            })
            .catch(error => {
                console.error('ì–¼êµ´ ê²€ì¶œ ì˜¤ë¥˜:', error);
                updateFaceDetectionUI({
                    success: false,
                    face_detected: false,
                    face_count: 0,
                    message: 'ì–¼êµ´ ê²€ì¶œ ì—°ê²° ì˜¤ë¥˜',
                    quality_score: 0.0
                });
                
                // API ì˜¤ë¥˜ ì‹œ ë“±ë¡ ë²„íŠ¼ ê°•ì œ ë¹„í™œì„±í™”
                const registerBtn = document.getElementById('registerBtn');
                if (registerBtn) {
                    registerBtn.disabled = true;
                    registerBtn.textContent = 'âŒ ì¹´ë©”ë¼ ì—°ê²° ì˜¤ë¥˜';
                    registerBtn.classList.remove('ready');
                }
            });
    }, 500); // 500ms ê°„ê²©ìœ¼ë¡œ í´ë§
}

// ì–¼êµ´ ê²€ì¶œ ì¤‘ì§€
function stopFaceDetection() {
    if (faceDetectionInterval) {
        clearInterval(faceDetectionInterval);
        faceDetectionInterval = null;
        console.log('ğŸ‘¤ ì–¼êµ´ ê²€ì¶œ ì¤‘ì§€');
    }
}

// UI ì—…ë°ì´íŠ¸
function updateFaceDetectionUI(data) {
    const faceGuide = document.getElementById('faceGuide');
    const faceStatusText = document.getElementById('faceStatusText');
    const faceDetectionStatus = document.getElementById('faceDetectionStatus');
    const faceQualityBar = document.getElementById('faceQualityBar');
    const faceQualityFill = document.getElementById('faceQualityFill');
    const registerBtn = document.getElementById('registerBtn');
    
    // ê¸°ë³¸ ìƒíƒœ ì´ˆê¸°í™”
    faceGuide.classList.remove('face-detected', 'face-good-quality');
    faceDetectionStatus.classList.remove('detected', 'good-quality');
    registerBtn.classList.remove('ready');
    
    if (!data.success) {
        faceStatusText.textContent = data.message || 'ì–¼êµ´ ê²€ì¶œ ì˜¤ë¥˜';
        faceQualityBar.style.display = 'none';
        registerBtn.disabled = true;
        registerBtn.textContent = 'âŒ ì¹´ë©”ë¼ ì˜¤ë¥˜';
        return;
    }
    
    // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    faceStatusText.textContent = data.message;
    
    // í’ˆì§ˆ ë°” í‘œì‹œ/ì—…ë°ì´íŠ¸
    if (data.face_detected && data.quality_score > 0) {
        faceQualityBar.style.display = 'block';
        faceQualityFill.style.width = (data.quality_score * 100) + '%';
    } else {
        faceQualityBar.style.display = 'none';
    }
    
    // ì–¼êµ´ ê²€ì¶œ ìƒíƒœì— ë”°ë¥¸ UI ë³€ê²½
    if (data.face_detected) {
        faceGuide.classList.add('face-detected');
        faceDetectionStatus.classList.add('detected');
        
        if (data.quality_score >= 0.8) {
            // ê³ í’ˆì§ˆ ì–¼êµ´ ê²€ì¶œ
            faceGuide.classList.add('face-good-quality');
            faceDetectionStatus.classList.add('good-quality');
            registerBtn.disabled = false;
            registerBtn.textContent = 'ğŸ“· ì´¬ì˜ ë° ë“±ë¡';
            registerBtn.classList.add('ready');
        } else if (data.quality_score >= 0.6) {
            // ì¤‘ê°„ í’ˆì§ˆ
            registerBtn.disabled = false;
            registerBtn.textContent = 'ğŸ“· ì´¬ì˜ ë° ë“±ë¡';
        } else {
            // ë‚®ì€ í’ˆì§ˆ
            registerBtn.disabled = true;
            registerBtn.textContent = 'ğŸ‘¤ ìœ„ì¹˜ë¥¼ ì¡°ì •í•´ì£¼ì„¸ìš”';
        }
    } else {
        // ì–¼êµ´ ë¯¸ê²€ì¶œ
        registerBtn.disabled = true;
        registerBtn.textContent = 'ğŸ‘¤ ì–¼êµ´ì„ ì¸ì‹í•˜ëŠ” ì¤‘...';
    }
}

// ì–¼êµ´ ë“±ë¡
function registerFace() {
    if (!selectedMemberId) {
        alert('íšŒì›ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
    }

    const registerBtn = document.getElementById('registerBtn');
    const statusMessage = document.getElementById('statusMessage');

    // ğŸš¨ ì¤‘ìš”: ë²„íŠ¼ì´ disabled ìƒíƒœì¸ì§€ í•œ ë²ˆ ë” ì²´í¬
    if (registerBtn.disabled) {
        console.warn('âš ï¸ ë“±ë¡ ë²„íŠ¼ì´ ë¹„í™œì„±í™” ìƒíƒœì…ë‹ˆë‹¤. ë“±ë¡ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.');
        return;
    }

    // ë“±ë¡ ì§„í–‰ ìƒíƒœ ì„¤ì •
    isRegisteringFace = true;
    
    // ì‹¤ì‹œê°„ ì–¼êµ´ ê²€ì¶œ ì¼ì‹œ ì¤‘ì§€
    stopFaceDetection();

    // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ìƒíƒœ ë³€ê²½
    registerBtn.disabled = true;
    registerBtn.textContent = 'â³ ë“±ë¡ ì¤‘...';
    registerBtn.classList.remove('ready');

    statusMessage.innerHTML = '<p class="status-processing">ğŸ“· ì–¼êµ´ì„ ë“±ë¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>';

    console.log(`ğŸ“· ì–¼êµ´ ë“±ë¡ ì‹œì‘: ${selectedMemberId} (${selectedMemberName})`);

    fetch(`/api/face/register/${selectedMemberId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('ğŸ“Š ì„œë²„ ì‘ë‹µ:', response.status, response.statusText);
        
        // ì‘ë‹µì´ JSONì¸ì§€ í™•ì¸
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error(`ì„œë²„ì—ì„œ ì˜ëª»ëœ ì‘ë‹µ í˜•ì‹ì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤ (${response.status})`);
        }
        
        return response.json().then(data => ({
            status: response.status,
            data: data
        }));
    })
    .then(({status, data}) => {
        console.log('ğŸ“Š ë“±ë¡ ì‘ë‹µ:', status, data);
        
        if (data.success) {
            statusMessage.innerHTML = `
                <p class="status-success">
                    âœ… ${selectedMemberName}ë‹˜ì˜ ì–¼êµ´ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!
                </p>
            `;

            // ë“±ë¡ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateFaceDetectionUI({
                success: true,
                face_detected: true,
                face_count: 1,
                message: 'ë“±ë¡ ì™„ë£Œ! âœ…',
                quality_score: 1.0
            });

            // ì¹´ë©”ë¼ í”¼ë“œ ì¤‘ì§€
            document.getElementById('cameraFeed').src = '';

            // 3ì´ˆ í›„ ì´ˆê¸°í™”
            setTimeout(() => {
                resetForm();
            }, 3000);
        } else {
            // ì„œë²„ì—ì„œ ë°˜í™˜í•œ êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            const errorMsg = data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
            const errorType = data.error_type || 'unknown_error';
            
            console.error('âŒ ë“±ë¡ ì‹¤íŒ¨:', errorType, errorMsg);
            
            let helpMessage = '';
            switch (errorType) {
                case 'face_not_found':
                    helpMessage = 'ì¹´ë©”ë¼ë¥¼ ì •ë©´ìœ¼ë¡œ ë³´ê³  ì¶©ë¶„í•œ ì¡°ëª…ì„ í™•ë³´í•´ì£¼ì„¸ìš”.';
                    break;
                case 'camera_error':
                case 'camera_not_running':
                case 'camera_init_error':
                    helpMessage = 'ì¹´ë©”ë¼ ì—°ê²°ì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    break;
                case 'face_detector_not_initialized':
                case 'face_embedding_not_initialized':
                    helpMessage = 'ì–¼êµ´ì¸ì‹ ëª¨ë¸ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    break;
                case 'member_not_found':
                    helpMessage = 'íšŒì› ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    break;
                default:
                    helpMessage = 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            }
            
            statusMessage.innerHTML = `
                <p class="status-error">
                    âŒ ë“±ë¡ ì‹¤íŒ¨: ${errorMsg}
                </p>
                <p class="status-help">${helpMessage}</p>
            `;
            
            // ë“±ë¡ ì§„í–‰ ìƒíƒœ í•´ì œ ë° ì–¼êµ´ ê²€ì¶œ ì¬ì‹œì‘
            isRegisteringFace = false;
            startFaceDetection();
        }
    })
    .catch(error => {
        console.error('âŒ ë“±ë¡ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
        statusMessage.innerHTML = `
            <p class="status-error">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}</p>
            <p class="status-help">ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
        `;
        
        // ë“±ë¡ ì§„í–‰ ìƒíƒœ í•´ì œ ë° ì–¼êµ´ ê²€ì¶œ ì¬ì‹œì‘
        isRegisteringFace = false;
        startFaceDetection();
    })
    .finally(() => {
        // ë“±ë¡ ì™„ë£Œ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ìƒíƒœ ì´ˆê¸°í™”
        if (!isRegisteringFace) {
            // 3ì´ˆ í›„ì— ì‹¤í–‰ë˜ëŠ” resetFormì— ì˜í•´ ì²˜ë¦¬ë˜ì§€ ì•ŠëŠ” ê²½ìš°ë§Œ
            setTimeout(() => {
                if (isRegisteringFace === false && faceDetectionInterval === null) {
                    startFaceDetection();
                }
            }, 100);
        }
    });
}

// ë“±ë¡ ì·¨ì†Œ
function cancelRegistration() {
    // ì–¼êµ´ ê²€ì¶œ ì¤‘ì§€
    stopFaceDetection();
    
    // ë“±ë¡ ì§„í–‰ ìƒíƒœ í•´ì œ
    isRegisteringFace = false;
    
    // ì¹´ë©”ë¼ í”¼ë“œ ì¤‘ì§€
    document.getElementById('cameraFeed').src = '';

    document.getElementById('cameraSection').style.display = 'none';
    selectedMemberId = null;
    selectedMemberName = null;
    
    console.log('ë“±ë¡ ì·¨ì†Œë¨');
}

// í¼ ì´ˆê¸°í™”
function resetForm() {
    // ëª¨ë“  ê²€ì¶œ ë° í´ë§ ì¤‘ì§€
    stopFaceDetection();
    stopBarcodePolling();
    
    // ìƒíƒœ ì´ˆê¸°í™”
    isRegisteringFace = false;
    
    // UI ì´ˆê¸°í™”
    document.getElementById('searchInput').value = '';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('cameraSection').style.display = 'none';
    document.getElementById('statusMessage').innerHTML = '';
    
    // ë³€ìˆ˜ ì´ˆê¸°í™”
    selectedMemberId = null;
    selectedMemberName = null;
    
    // ë°”ì½”ë“œ í´ë§ ì¬ì‹œì‘ (ê²€ìƒ‰ìš©)
    startBarcodePolling();
    
    console.log('í¼ ì´ˆê¸°í™” ì™„ë£Œ');
}

// í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ëª¨ë“  í´ë§ ì¤‘ì§€
window.addEventListener('beforeunload', function() {
    stopBarcodePolling();
    stopFaceDetection();
});

// ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í´ë¦­ì‹œì—ë„ í´ë§ ì¤‘ì§€
document.addEventListener('DOMContentLoaded', function() {
    const backButton = document.querySelector('.back-button');
    if (backButton) {
        backButton.addEventListener('click', function() {
            stopBarcodePolling();
            stopFaceDetection();
        });
    }
});
</script>
{% endblock %}

