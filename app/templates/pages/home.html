{% extends "layouts/base.html" %}

{% block title %}ë½ì¹´í‚¤ ëŒ€ì—¬ê¸°{% endblock %}

{% block body_class %}home-page{% endblock %}

{% block content %}
<div class="home-container">
    <!-- ìƒë‹¨: ë‚ ì§œ/ì‹œê°„ -->
    <div class="datetime-section">
        <div class="current-date" id="currentDate"></div>
        <div class="current-time" id="currentTime"></div>
    </div>

    <!-- ì¤‘ì•™: ë°”ì½”ë“œ/QR ì¼ëŸ¬ìŠ¤íŠ¸ -->
    <div class="scan-visual">
        <div class="barcode-illustration"></div>
        <div class="qr-illustration"></div>
    </div>

    <!-- í•˜ë‹¨: ì•ˆë‚´ ë©˜íŠ¸ -->
    <div class="scan-message">
        ë°”ì½”ë“œ, QRì½”ë“œ ë˜ëŠ” NFC íƒœê·¸ë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”
    </div>

    <!-- ì‹œìŠ¤í…œ ìƒíƒœ (ì‘ê²Œ) -->
    <div class="system-status">
        <span class="status-indicator" id="systemStatus">â—</span>
    </div>

    <!-- ìˆ¨ê²¨ì§„ ê´€ë¦¬ì ë²„íŠ¼ -->
    <div class="admin-trigger" id="adminTrigger"></div>
    
    <!-- NFC ë½ì»¤ ì•Œë¦¼ -->
    <div class="nfc-locker-notification" id="nfcLockerNotification" style="display: none;">
        <div class="notification-content">
            <div class="locker-number-display" id="lockerNumberDisplay"></div>
        </div>
    </div>
</div>

<style>
.nfc-locker-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    padding: 60px 80px;
    border-radius: 30px;
    z-index: 9999;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.locker-number-display {
    font-size: 6rem;
    font-weight: bold;
    color: #4caf50;
    text-align: center;
    text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
}
</style>

<!-- ë°”ì½”ë“œ ì…ë ¥ ìˆ¨ê¹€ í•„ë“œ (í•˜ë“œì›¨ì–´ ìŠ¤ìºë„ˆìš©) -->
<input type="text" id="barcodeInput" class="barcode-hidden-input" autocomplete="off" />
{% endblock %}

{% block scripts %}
<script>
let socket = null;
let barcodeBuffer = '';
let barcodeTimeout = null;
let pollingInterval = null;
let isProcessingBarcode = false;

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('ë½ì¹´í‚¤ ëŒ€ì—¬ê¸° ì‹œì‘');
    
    // ë‚ ì§œ/ì‹œê°„ ì—…ë°ì´íŠ¸
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // WebSocket ì—°ê²°
    connectWebSocket();
    
    // í•˜ë“œì›¨ì–´ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ë¦¬ìŠ¤ë‹
    setupBarcodeScanner();
    
    // ìˆ¨ê²¨ì§„ ê´€ë¦¬ì ëª¨ë“œ (ì¢Œì¸¡ í•˜ë‹¨ 3ì´ˆ ëˆ„ë¥´ê¸°)
    setupAdminTrigger();
    
    // ë°”ì½”ë“œ í´ë§ (200msë§ˆë‹¤ ì²´í¬)
    pollingInterval = setInterval(function() {
        // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ í´ë§ ê±´ë„ˆë›°ê¸°
        if (isProcessingBarcode) {
            return;
        }
        
        const t_poll_start = performance.now();
        fetch('/api/barcode/poll')
            .then(response => response.json())
            .then(data => {
                if (data.has_barcode && !isProcessingBarcode) {
                    const t_poll_end = performance.now();
                    console.log(`â±ï¸ [PERF-POLL] ë°”ì½”ë“œ í´ë§ ì„±ê³µ: ${(t_poll_end - t_poll_start).toFixed(2)}ms | ë°”ì½”ë“œ: ${data.barcode}`);
                    handleBarcodeScanned(data.barcode);
                }
            })
            .catch(error => {
                // ì¡°ìš©íˆ ë¬´ì‹œ
            });
    }, 200);
    
    // í‚¤ì˜¤ìŠ¤í¬ ìµœì í™”
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen?.();
    }
});

// ë‚ ì§œ/ì‹œê°„ ì—…ë°ì´íŠ¸
function updateDateTime() {
    const now = new Date();
    
    // ë‚ ì§œ
    const dateString = now.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
    });
    document.getElementById('currentDate').textContent = dateString;
    
    // ì‹œê°„
    const timeString = now.toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    document.getElementById('currentTime').textContent = timeString;
}

// WebSocket ì—°ê²°
function connectWebSocket() {
    try {
        socket = io();
        
        socket.on('connect', function() {
            console.log('WebSocket ì—°ê²°ë¨');
            const statusEl = document.getElementById('systemStatus');
            statusEl.textContent = 'â—';
            statusEl.style.color = '#4caf50';
            socket.emit('join', { room: 'kiosk' });
        });
        
        socket.on('disconnect', function() {
            console.log('WebSocket ì—°ê²° ëŠê¹€');
            const statusEl = document.getElementById('systemStatus');
            statusEl.textContent = 'â—';
            statusEl.style.color = '#ff6b6b';
        });
        
        // ë°”ì½”ë“œ ê°ì§€ ì´ë²¤íŠ¸ (ESP32ì—ì„œ)
        socket.on('barcode_detected', function(data) {
            console.log('ë°”ì½”ë“œ ê°ì§€:', data.barcode);
            handleBarcodeScanned(data.barcode);
        });
        
        // ESP32 ì´ë²¤íŠ¸ ìˆ˜ì‹  (í˜¸í™˜ì„±)
        socket.on('esp32_event', function(data) {
            if (data.event_type === 'barcode_scanned') {
                console.log('ESP32 ë°”ì½”ë“œ:', data.data.barcode);
                handleBarcodeScanned(data.data.barcode);
            }
        });
        
        // í™”ë©´ ì „í™˜ ëª…ë ¹ ìˆ˜ì‹ 
        socket.on('navigate_to', function(data) {
            console.log('í™”ë©´ ì „í™˜:', data.page);
            navigateTo(data.page, data.params);
        });
        
    } catch (error) {
        console.error('WebSocket ì—°ê²° ì˜¤ë¥˜:', error);
    }
}

// í•˜ë“œì›¨ì–´ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ë¦¬ìŠ¤ë‹
function setupBarcodeScanner() {
    const barcodeInput = document.getElementById('barcodeInput');
    barcodeInput.focus();
    
    document.addEventListener('click', function() {
        barcodeInput.focus();
    });
    
    barcodeInput.addEventListener('input', function(e) {
        const value = e.target.value;
        if (value.length > 0) {
            barcodeBuffer = value;
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            const inputValue = barcodeInput.value;
            const finalBarcode = inputValue || barcodeBuffer;
            
            if (finalBarcode.length > 0) {
                console.log('ë°”ì½”ë“œ ì™„ë£Œ:', finalBarcode);
                handleBarcodeScanned(finalBarcode);
                barcodeBuffer = '';
                barcodeInput.value = '';
            }
            e.preventDefault();
            return false;
        }
        
        if (e.key && e.key.length === 1) {
            barcodeBuffer += e.key;
            
            clearTimeout(barcodeTimeout);
            barcodeTimeout = setTimeout(function() {
                if (barcodeBuffer.length > 0) {
                    barcodeBuffer = '';
                }
            }, 300);
        }
    });
}

// ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬
function handleBarcodeScanned(barcode) {
    if (!barcode || barcode.trim().length === 0) {
        console.log('âš ï¸ ë¹ˆ ë°”ì½”ë“œ ë¬´ì‹œ');
        return;
    }
    
    barcode = barcode.trim();
    
    // NFC íƒœê·¸ ì²´í¬
    if (barcode.startsWith('NFC:')) {
        console.log('ğŸ”– NFC íƒœê·¸ ê°ì§€:', barcode);
        const nfcUid = barcode.substring(4);
        handleNFCScanned(nfcUid);
        return;
    }
    
    // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ë¬´ì‹œ
    if (isProcessingBarcode) {
        console.log('âš ï¸ ì´ë¯¸ ë°”ì½”ë“œ ì²˜ë¦¬ ì¤‘ - ë¬´ì‹œ:', barcode);
        return;
    }
    
    // ì²˜ë¦¬ ì‹œì‘ í”Œë˜ê·¸ ì„¤ì • (ì¤‘ë³µ ë°©ì§€)
    isProcessingBarcode = true;
    console.log('ğŸ”’ ë°”ì½”ë“œ ì²˜ë¦¬ ì‹œì‘ - ì¶”ê°€ í´ë§ ì°¨ë‹¨');
    
    // íì— ë‚¨ì€ ë°”ì½”ë“œë“¤ ëª¨ë‘ ë¹„ìš°ê¸°
    clearBarcodeQueue();
    const t_start = performance.now();
    console.log('â±ï¸ [PERF-UI] ë°”ì½”ë“œ ì²˜ë¦¬ ì‹œì‘:', barcode);
    
    const t_api_start = performance.now();
    fetch('/api/barcode/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ barcode: barcode })
    })
    .then(response => {
        const t_api_response = performance.now();
        console.log(`â±ï¸ [PERF-UI] API ì‘ë‹µ ìˆ˜ì‹ : ${(t_api_response - t_api_start).toFixed(2)}ms`);
        return response.json();
    })
    .then(data => {
        const t_api_parsed = performance.now();
        console.log(`â±ï¸ [PERF-UI] ì‘ë‹µ íŒŒì‹±: ${(t_api_parsed - t_api_start).toFixed(2)}ms | ì „ì²´: ${(t_api_parsed - t_start).toFixed(2)}ms`);
        console.log('âœ… ë°”ì½”ë“œ ì²˜ë¦¬ ê²°ê³¼:', data);
        
        if (data.success) {
            const t_navigate_start = performance.now();
            if (data.action === 'rental') {
                navigateTo('member-check', { member_id: data.member_id, action: 'rental' });
            } else if (data.action === 'return') {
                navigateTo('member-check', { member_id: data.member_id, action: 'return' });
            }
            console.log(`â±ï¸ [PERF-UI] í™”ë©´ ì „í™˜ ì‹œì‘: ${(performance.now() - t_navigate_start).toFixed(2)}ms`);
            console.log(`â±ï¸ [PERF-UI] === ì „ì²´ í”„ë¡œì„¸ìŠ¤: ${(performance.now() - t_start).toFixed(2)}ms ===`);
        } else {
            navigateTo('error', { 
                type: data.error_type || 'unknown',
                message: data.error || 'ë°”ì½”ë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
            });
        }
    })
    .catch(error => {
        console.error('âŒ ë°”ì½”ë“œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        isProcessingBarcode = false; // ì˜¤ë¥˜ ì‹œ í”Œë˜ê·¸ í•´ì œ
        navigateTo('error', { 
            type: 'system_error',
            message: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'
        });
    });
}

// ë°”ì½”ë“œ í ë¹„ìš°ê¸° (ì¤‘ë³µ ë°”ì½”ë“œ ì œê±°)
function clearBarcodeQueue() {
    console.log('ğŸ§¹ ë°”ì½”ë“œ í ë¹„ìš°ëŠ” ì¤‘...');
    
    // íì— ë‚¨ì€ ëª¨ë“  ë°”ì½”ë“œ ì œê±° (ìµœëŒ€ 10íšŒ ì‹œë„)
    let cleared = 0;
    for (let i = 0; i < 10; i++) {
        fetch('/api/barcode/poll')
            .then(response => response.json())
            .then(data => {
                if (data.has_barcode) {
                    cleared++;
                    console.log(`ğŸ—‘ï¸ íì—ì„œ ì œê±°: ${data.barcode} (${cleared}ë²ˆì§¸)`);
                }
            })
            .catch(() => {});
    }
}

// í™”ë©´ ì „í™˜
function navigateTo(page, params) {
    const queryString = new URLSearchParams(params).toString();
    const url = `/${page}${queryString ? '?' + queryString : ''}`;
    console.log('ğŸ”„ ì´ë™:', url);
    window.location.href = url;
}

// ìˆ¨ê²¨ì§„ ê´€ë¦¬ì ëª¨ë“œ íŠ¸ë¦¬ê±°
function setupAdminTrigger() {
    const trigger = document.getElementById('adminTrigger');
    let pressTimer = null;
    
    trigger.addEventListener('mousedown', function() {
        pressTimer = setTimeout(function() {
            openAdminMode();
        }, 3000);
    });
    
    trigger.addEventListener('mouseup', function() {
        clearTimeout(pressTimer);
    });
    
    trigger.addEventListener('touchstart', function() {
        pressTimer = setTimeout(function() {
            openAdminMode();
        }, 3000);
    });
    
    trigger.addEventListener('touchend', function() {
        clearTimeout(pressTimer);
    });
}

function openAdminMode() {
    const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:');
    if (password === '1234') {
        window.location.href = '/admin';
    }
}

// ESC í‚¤ ë°©ì§€
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        e.preventDefault();
    }
});

// í˜ì´ì§€ ë– ë‚  ë•Œ ì •ë¦¬
window.addEventListener('beforeunload', function() {
    // í´ë§ ì¤‘ì§€
    if (pollingInterval) {
        clearInterval(pollingInterval);
        console.log('ğŸ›‘ í´ë§ ì¤‘ì§€');
    }
});

// NFC ìŠ¤ìº” ì²˜ë¦¬
function handleNFCScanned(nfcUid) {
    if (!nfcUid || nfcUid.trim().length === 0) return;
    if (isProcessingBarcode) return;
    
    isProcessingBarcode = true;
    nfcUid = nfcUid.trim();
    console.log('ğŸ”’ NFC ì²˜ë¦¬ ì‹œì‘:', nfcUid);
    
    // íì— ë‚¨ì€ NFC/ë°”ì½”ë“œ ëª¨ë‘ ë¹„ìš°ê¸° (ì¤‘ë³µ ë°©ì§€)
    clearBarcodeQueue();
    
    fetch('/api/nfc/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nfc_uid: nfcUid })
    })
    .then(r => r.json())
    .then(data => {
        console.log('âœ… NFC ê²€ì¦ ê²°ê³¼:', data);
        if (data.success && data.locker_info) {
            // ëŒ€ì—¬ ê¸°ë¡ì´ ì—†ëŠ” ê²½ìš° ë¬¸ë§Œ ì—´ê³  10ì´ˆ í›„ ë‹«ê¸°
            if (!data.locker_info.is_rented) {
                console.log('ğŸšª ëŒ€ì—¬ ê¸°ë¡ ì—†ìŒ - ë¬¸ë§Œ ì—´ê¸°');
                const zone = data.locker_info.zone;
                const lockerNumber = data.locker_info.locker_number;
                const deviceId = zone === 'STAFF' ? 'esp32_staff' : 'esp32_male_female';
                
                // ë½ì»¤ ë²ˆí˜¸ ì•Œë¦¼ í‘œì‹œ
                const notification = document.getElementById('nfcLockerNotification');
                const lockerDisplay = document.getElementById('lockerNumberDisplay');
                lockerDisplay.textContent = `${lockerNumber}ë²ˆ ë½ì»¤`;
                notification.style.display = 'block';
                
                // ë¬¸ ì—´ê¸°
                fetch('/api/hardware/motor_move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ revs: 0.917, rpm: 30, device_id: deviceId })
                });
                
                // 10ì´ˆ í›„ ë¬¸ ë‹«ê¸° + ì•Œë¦¼ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    fetch('/api/hardware/motor_move', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ revs: -0.917, rpm: 30, device_id: deviceId })
                    });
                    notification.style.display = 'none';
                }, 10000);
                
                isProcessingBarcode = false;
                return;
            }
            
            // ëŒ€ì—¬ ê¸°ë¡ì´ ìˆìœ¼ë©´ ê¸°ì¡´ ë¡œì§ëŒ€ë¡œ ì§„í–‰
            navigateTo('member-check', {
                action: 'return',
                locker_id: data.locker_info.locker_number,
                zone: data.locker_info.zone,
                method: 'nfc',
                nfc_uid: nfcUid
            });
        } else {
            isProcessingBarcode = false;
            navigateTo('error', { type: 'nfc_error', message: data.error || 'NFC ì˜¤ë¥˜' });
        }
    })
    .catch(e => {
        console.error('âŒ NFC ì˜¤ë¥˜:', e);
        isProcessingBarcode = false;
        navigateTo('error', { type: 'system_error', message: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜' });
    });
}

</script>
{% endblock %}
