{% extends "layouts/base.html" %}

{% block title %}락카키 대여기{% endblock %}

{% block body_class %}home-page{% endblock %}

{% block content %}
<div class="home-container">
    <!-- 상단: 날짜/시간 -->
    <div class="datetime-section">
        <div class="current-date" id="currentDate"></div>
        <div class="current-time" id="currentTime"></div>
    </div>

    <!-- 중앙: 바코드/QR 일러스트 -->
    <div class="scan-visual">
        <div class="barcode-illustration"></div>
        <div class="qr-illustration"></div>
    </div>

    <!-- 하단: 안내 멘트 -->
    <div class="scan-message">
        바코드 또는 QR코드를 스캔해주세요
    </div>

    <!-- 시스템 상태 (작게) -->
    <div class="system-status">
        <span class="status-indicator" id="systemStatus">●</span>
    </div>

    <!-- 숨겨진 관리자 버튼 -->
    <div class="admin-trigger" id="adminTrigger"></div>
</div>

<!-- 바코드 입력 숨김 필드 (하드웨어 스캐너용) -->
<input type="text" id="barcodeInput" class="barcode-hidden-input" autocomplete="off" />
{% endblock %}

{% block scripts %}
<script>
let socket = null;
let barcodeBuffer = '';
let barcodeTimeout = null;

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    console.log('락카키 대여기 시작');
    
    // 날짜/시간 업데이트
    updateDateTime();
    setInterval(updateDateTime, 1000);
    
    // WebSocket 연결
    connectWebSocket();
    
    // 하드웨어 바코드 스캐너 리스닝
    setupBarcodeScanner();
    
    // 숨겨진 관리자 모드 (좌측 하단 3초 누르기)
    setupAdminTrigger();
    
    // 바코드 폴링 (200ms마다 체크)
    setInterval(function() {
        const t_poll_start = performance.now();
        fetch('/api/barcode/poll')
            .then(response => response.json())
            .then(data => {
                if (data.has_barcode) {
                    const t_poll_end = performance.now();
                    console.log(`⏱️ [PERF-POLL] 바코드 폴링 성공: ${(t_poll_end - t_poll_start).toFixed(2)}ms | 바코드: ${data.barcode}`);
                    handleBarcodeScanned(data.barcode);
                }
            })
            .catch(error => {
                // 조용히 무시
            });
    }, 200);
    
    // 키오스크 최적화
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen?.();
    }
});

// 날짜/시간 업데이트
function updateDateTime() {
    const now = new Date();
    
    // 날짜
    const dateString = now.toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
    });
    document.getElementById('currentDate').textContent = dateString;
    
    // 시간
    const timeString = now.toLocaleTimeString('ko-KR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    document.getElementById('currentTime').textContent = timeString;
}

// WebSocket 연결
function connectWebSocket() {
    try {
        socket = io();
        
        socket.on('connect', function() {
            console.log('WebSocket 연결됨');
            const statusEl = document.getElementById('systemStatus');
            statusEl.textContent = '●';
            statusEl.style.color = '#4caf50';
            socket.emit('join', { room: 'kiosk' });
        });
        
        socket.on('disconnect', function() {
            console.log('WebSocket 연결 끊김');
            const statusEl = document.getElementById('systemStatus');
            statusEl.textContent = '●';
            statusEl.style.color = '#ff6b6b';
        });
        
        // 바코드 감지 이벤트 (ESP32에서)
        socket.on('barcode_detected', function(data) {
            console.log('바코드 감지:', data.barcode);
            handleBarcodeScanned(data.barcode);
        });
        
        // ESP32 이벤트 수신 (호환성)
        socket.on('esp32_event', function(data) {
            if (data.event_type === 'barcode_scanned') {
                console.log('ESP32 바코드:', data.data.barcode);
                handleBarcodeScanned(data.data.barcode);
            }
        });
        
        // 화면 전환 명령 수신
        socket.on('navigate_to', function(data) {
            console.log('화면 전환:', data.page);
            navigateTo(data.page, data.params);
        });
        
    } catch (error) {
        console.error('WebSocket 연결 오류:', error);
    }
}

// 하드웨어 바코드 스캐너 리스닝
function setupBarcodeScanner() {
    const barcodeInput = document.getElementById('barcodeInput');
    barcodeInput.focus();
    
    document.addEventListener('click', function() {
        barcodeInput.focus();
    });
    
    barcodeInput.addEventListener('input', function(e) {
        const value = e.target.value;
        if (value.length > 0) {
            barcodeBuffer = value;
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.keyCode === 13) {
            const inputValue = barcodeInput.value;
            const finalBarcode = inputValue || barcodeBuffer;
            
            if (finalBarcode.length > 0) {
                console.log('바코드 완료:', finalBarcode);
                handleBarcodeScanned(finalBarcode);
                barcodeBuffer = '';
                barcodeInput.value = '';
            }
            e.preventDefault();
            return false;
        }
        
        if (e.key && e.key.length === 1) {
            barcodeBuffer += e.key;
            
            clearTimeout(barcodeTimeout);
            barcodeTimeout = setTimeout(function() {
                if (barcodeBuffer.length > 0) {
                    barcodeBuffer = '';
                }
            }, 300);
        }
    });
}

// 바코드 스캔 처리
function handleBarcodeScanned(barcode) {
    if (!barcode || barcode.trim().length === 0) {
        console.log('⚠️ 빈 바코드 무시');
        return;
    }
    
    barcode = barcode.trim();
    const t_start = performance.now();
    console.log('⏱️ [PERF-UI] 바코드 처리 시작:', barcode);
    
    const t_api_start = performance.now();
    fetch('/api/barcode/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ barcode: barcode })
    })
    .then(response => {
        const t_api_response = performance.now();
        console.log(`⏱️ [PERF-UI] API 응답 수신: ${(t_api_response - t_api_start).toFixed(2)}ms`);
        return response.json();
    })
    .then(data => {
        const t_api_parsed = performance.now();
        console.log(`⏱️ [PERF-UI] 응답 파싱: ${(t_api_parsed - t_api_start).toFixed(2)}ms | 전체: ${(t_api_parsed - t_start).toFixed(2)}ms`);
        console.log('✅ 바코드 처리 결과:', data);
        
        if (data.success) {
            const t_navigate_start = performance.now();
            if (data.action === 'rental') {
                navigateTo('member-check', { member_id: data.member_id, action: 'rental' });
            } else if (data.action === 'return') {
                navigateTo('member-check', { member_id: data.member_id, action: 'return' });
            }
            console.log(`⏱️ [PERF-UI] 화면 전환 시작: ${(performance.now() - t_navigate_start).toFixed(2)}ms`);
            console.log(`⏱️ [PERF-UI] === 전체 프로세스: ${(performance.now() - t_start).toFixed(2)}ms ===`);
        } else {
            navigateTo('error', { 
                type: data.error_type || 'unknown',
                message: data.error || '바코드 처리 중 오류가 발생했습니다.'
            });
        }
    })
    .catch(error => {
        console.error('❌ 바코드 처리 오류:', error);
        navigateTo('error', { 
            type: 'system_error',
            message: '시스템 오류가 발생했습니다. 관리자에게 문의하세요.'
        });
    });
}

// 화면 전환
function navigateTo(page, params) {
    const queryString = new URLSearchParams(params).toString();
    const url = `/${page}${queryString ? '?' + queryString : ''}`;
    console.log('🔄 이동:', url);
    window.location.href = url;
}

// 숨겨진 관리자 모드 트리거
function setupAdminTrigger() {
    const trigger = document.getElementById('adminTrigger');
    let pressTimer = null;
    
    trigger.addEventListener('mousedown', function() {
        pressTimer = setTimeout(function() {
            openAdminMode();
        }, 3000);
    });
    
    trigger.addEventListener('mouseup', function() {
        clearTimeout(pressTimer);
    });
    
    trigger.addEventListener('touchstart', function() {
        pressTimer = setTimeout(function() {
            openAdminMode();
        }, 3000);
    });
    
    trigger.addEventListener('touchend', function() {
        clearTimeout(pressTimer);
    });
}

function openAdminMode() {
    const password = prompt('관리자 비밀번호:');
    if (password === '1234') {
        window.location.href = '/admin';
    }
}

// ESC 키 방지
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        e.preventDefault();
    }
});
</script>
{% endblock %}
