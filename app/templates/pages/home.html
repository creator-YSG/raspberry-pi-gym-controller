{% extends "layouts/base.html" %}

{% block title %}ë½ì¹´í‚¤ ëŒ€ì—¬ê¸°{% endblock %}

{% block body_class %}home-page{% endblock %}

{% block content %}
<div class="home-container">
    <!-- ë©”ì¸ ì•ˆë‚´ -->
    <div class="scan-prompt">
        <div class="gym-logo">ğŸ‹ï¸</div>
        <h1 class="main-title">í—¬ìŠ¤ì¥ ë½ì¹´í‚¤ ëŒ€ì—¬ê¸°</h1>
        <div class="scan-instruction">
            <div class="arrow-animation">
                <div class="arrow">â†“</div>
                <div class="arrow">â†“</div>
                <div class="arrow">â†“</div>
            </div>
            <p class="scan-text">ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”</p>
        </div>
        <div class="barcode-icon">ğŸ“±</div>
        
        <!-- ë””ë²„ê·¸ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ -->
        <button id="testButton" style="padding: 20px 40px; font-size: 24px; background: #ff5722; color: white; border: none; border-radius: 12px; cursor: pointer; margin-top: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
            ğŸ§ª í…ŒìŠ¤íŠ¸ (ë“±ë¡ì•ˆëœíšŒì›)
        </button>
    </div>

    <!-- í•˜ë‹¨ ìƒíƒœ ì •ë³´ -->
    <div class="status-footer">
        <div class="status-item">
            <span class="status-label">ì‹œìŠ¤í…œ ìƒíƒœ</span>
            <span class="status-value status-ok" id="systemStatus">â— ì •ìƒ</span>
        </div>
        <div class="status-item">
            <span class="status-label">í˜„ì¬ ì‹œê°</span>
            <span class="status-value" id="currentTime"></span>
        </div>
    </div>
    
    <!-- ë””ë²„ê·¸ ë¡œê·¸ í‘œì‹œ -->
    <div id="debugLog" style="position: absolute; bottom: 80px; left: 10px; right: 10px; background: rgba(0,0,0,0.9); color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 18px; max-height: 300px; overflow-y: auto; border: 2px solid #0f0;"></div>

    <!-- ìˆ¨ê²¨ì§„ ê´€ë¦¬ì ë²„íŠ¼ (ì¢Œì¸¡ í•˜ë‹¨ ëª¨ì„œë¦¬ ê¸¸ê²Œ ëˆ„ë¥´ë©´ í‘œì‹œ) -->
    <div class="admin-trigger" id="adminTrigger"></div>
</div>

<!-- ë°”ì½”ë“œ ì…ë ¥ ìˆ¨ê¹€ í•„ë“œ (í•˜ë“œì›¨ì–´ ìŠ¤ìºë„ˆìš©) -->
<input type="text" id="barcodeInput" class="barcode-hidden-input" autocomplete="off" />
{% endblock %}

{% block scripts %}
<script>
let socket = null;
let barcodeBuffer = '';
let barcodeTimeout = null;

// í™”ë©´ì— ë¡œê·¸ í‘œì‹œ í•¨ìˆ˜
function showLog(message) {
    const logDiv = document.getElementById('debugLog');
    const time = new Date().toLocaleTimeString();
    logDiv.innerHTML = `[${time}] ${message}<br>` + logDiv.innerHTML;
    console.log(message);
}

// ëª¨ë“  JavaScript ì˜¤ë¥˜ë¥¼ í™”ë©´ì— í‘œì‹œ
window.onerror = function(msg, url, lineNo, columnNo, error) {
    showLog('âŒ JS ì˜¤ë¥˜: ' + msg);
    return false;
};

// Promise ì˜¤ë¥˜ë„ ìºì¹˜
window.addEventListener('unhandledrejection', function(event) {
    showLog('âŒ Promise ì˜¤ë¥˜: ' + event.reason);
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    showLog('ğŸš€ ë½ì¹´í‚¤ ëŒ€ì—¬ê¸° ì‹œì‘');
    
    // ì‹œê°„ ì—…ë°ì´íŠ¸
    updateTime();
    setInterval(updateTime, 1000);
    
    // WebSocket ì—°ê²°
    connectWebSocket();
    
    // í•˜ë“œì›¨ì–´ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ë¦¬ìŠ¤ë‹
    setupBarcodeScanner();
    
    // ìˆ¨ê²¨ì§„ ê´€ë¦¬ì ëª¨ë“œ (ì¢Œì¸¡ í•˜ë‹¨ 5ì´ˆ ëˆ„ë¥´ê¸°)
    setupAdminTrigger();
    
    // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('testButton').addEventListener('click', function() {
        showLog('ğŸ§ª í…ŒìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­');
        handleBarcodeScanned('20240757');
    });
    
    // ë°”ì½”ë“œ í´ë§ (1ì´ˆë§ˆë‹¤ ì²´í¬)
    setInterval(function() {
        fetch('/api/barcode/poll')
            .then(response => response.json())
            .then(data => {
                if (data.has_barcode) {
                    showLog('ğŸ“¥ í´ë§ ë°”ì½”ë“œ: ' + data.barcode);
                    handleBarcodeScanned(data.barcode);
                }
            })
            .catch(error => {
                // ì¡°ìš©íˆ ë¬´ì‹œ (ë„ˆë¬´ ë§ì€ ë¡œê·¸ ë°©ì§€)
            });
    }, 1000);
    showLog('â° ë°”ì½”ë“œ í´ë§ ì‹œì‘ (1ì´ˆ ê°„ê²©)');
    
    // í‚¤ì˜¤ìŠ¤í¬ ìµœì í™”
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen?.();
    }
});

// í˜„ì¬ ì‹œê° ì—…ë°ì´íŠ¸
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleString('ko-KR', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    document.getElementById('currentTime').textContent = timeString;
}

// WebSocket ì—°ê²°
function connectWebSocket() {
    try {
        socket = io();
        
        socket.on('connect', function() {
            showLog('âœ… WebSocket ì—°ê²°ë¨');
            document.getElementById('systemStatus').textContent = 'â— ì •ìƒ';
            document.getElementById('systemStatus').className = 'status-value status-ok';
            socket.emit('join', { room: 'kiosk' });
        });
        
        socket.on('disconnect', function() {
            showLog('âŒ WebSocket ì—°ê²° ëŠê¹€');
            document.getElementById('systemStatus').textContent = 'â— ì—°ê²° ëŠê¹€';
            document.getElementById('systemStatus').className = 'status-value status-error';
        });
        
        // ë°”ì½”ë“œ ê°ì§€ ì´ë²¤íŠ¸ (ESP32ì—ì„œ)
        socket.on('barcode_detected', function(data) {
            showLog('ğŸ“± ë°”ì½”ë“œ ê°ì§€: ' + data.barcode);
            handleBarcodeScanned(data.barcode);
        });
        
        // ESP32 ì´ë²¤íŠ¸ ìˆ˜ì‹  (í˜¸í™˜ì„±)
        socket.on('esp32_event', function(data) {
            showLog('ğŸ“¡ ESP32 ì´ë²¤íŠ¸: ' + data.event_type);
            
            if (data.event_type === 'barcode_scanned') {
                showLog('ğŸ“± ë°”ì½”ë“œ: ' + data.data.barcode);
                handleBarcodeScanned(data.data.barcode);
            }
        });
        
        // í™”ë©´ ì „í™˜ ëª…ë ¹ ìˆ˜ì‹ 
        socket.on('navigate_to', function(data) {
            showLog('ğŸ”„ í™”ë©´ ì „í™˜: ' + data.page);
            navigateTo(data.page, data.params);
        });
        
        // ëª¨ë“  ì´ë²¤íŠ¸ ê°ì§€ (ë””ë²„ê¹…ìš©)
        socket.onAny(function(eventName, ...args) {
            showLog('ğŸ“¬ ì´ë²¤íŠ¸: ' + eventName + ' | ë°ì´í„°: ' + JSON.stringify(args).substring(0, 50));
        });
        
        showLog('ğŸ”Œ Socket.IO ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
        
    } catch (error) {
        console.error('WebSocket ì—°ê²° ì˜¤ë¥˜:', error);
    }
}

// í•˜ë“œì›¨ì–´ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ë¦¬ìŠ¤ë‹
function setupBarcodeScanner() {
    showLog('ğŸ”§ ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì„¤ì • ì‹œì‘');
    
    // ìˆ¨ê¹€ ì…ë ¥ í•„ë“œì— í•­ìƒ í¬ì»¤ìŠ¤ ìœ ì§€
    const barcodeInput = document.getElementById('barcodeInput');
    barcodeInput.focus();
    showLog('ğŸ“ barcodeInputì— í¬ì»¤ìŠ¤ ì„¤ì •');
    
    // í´ë¦­ ì‹œ ë‹¤ì‹œ í¬ì»¤ìŠ¤
    document.addEventListener('click', function() {
        barcodeInput.focus();
        showLog('ğŸ‘† í´ë¦­ ê°ì§€');
    });
    
    // input í•„ë“œì—ì„œ ì§ì ‘ ì…ë ¥ ê°ì§€
    barcodeInput.addEventListener('input', function(e) {
        const value = e.target.value;
        showLog('ğŸ“¥ INPUT ì´ë²¤íŠ¸: ' + value);
        
        if (value.length > 0) {
            barcodeBuffer = value;
            showLog('ğŸ“ ë²„í¼ ì—…ë°ì´íŠ¸: ' + barcodeBuffer);
        }
    });
    
    // í‚¤ ë‹¤ìš´ ê°ì§€ (ëª¨ë“  í‚¤)
    document.addEventListener('keydown', function(e) {
        showLog('âŒ¨ï¸ KEYDOWN: ' + e.key + ' code:' + e.keyCode);
        
        // Enterí‚¤ë©´ ë°”ì½”ë“œ ì™„ì„±
        if (e.key === 'Enter' || e.keyCode === 13) {
            // input í•„ë“œ ê°’ ë¨¼ì € í™•ì¸
            const inputValue = barcodeInput.value;
            const finalBarcode = inputValue || barcodeBuffer;
            
            if (finalBarcode.length > 0) {
                showLog('âœ… ë°”ì½”ë“œ ì™„ë£Œ: ' + finalBarcode);
                handleBarcodeScanned(finalBarcode);
                barcodeBuffer = '';
                barcodeInput.value = '';
            } else {
                showLog('âš ï¸ Enter, ë²„í¼ ë¹„ì–´ìˆìŒ');
            }
            e.preventDefault();
            return false;
        }
        
        // ìˆ«ìë‚˜ ë¬¸ì ì…ë ¥ ì‹œ ë²„í¼ì— ì¶”ê°€
        if (e.key && e.key.length === 1) {
            barcodeBuffer += e.key;
            showLog('ğŸ“ ë²„í¼: ' + barcodeBuffer);
            
            // íƒ€ì„ì•„ì›ƒ ë¦¬ì…‹
            clearTimeout(barcodeTimeout);
            barcodeTimeout = setTimeout(function() {
                if (barcodeBuffer.length > 0) {
                    showLog('â±ï¸ íƒ€ì„ì•„ì›ƒ');
                    barcodeBuffer = '';
                }
            }, 300);
        }
    });
    
    showLog('âœ… ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì„¤ì • ì™„ë£Œ');
}

// ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬
function handleBarcodeScanned(barcode) {
    if (!barcode || barcode.trim().length === 0) {
        console.log('âš ï¸ ë¹ˆ ë°”ì½”ë“œ ë¬´ì‹œ');
        return;
    }
    
    barcode = barcode.trim();
    console.log('ğŸ” ë°”ì½”ë“œ ì²˜ë¦¬ ì‹œì‘:', barcode);
    
    // ì„œë²„ë¡œ ë°”ì½”ë“œ ì „ì†¡
    fetch('/api/barcode/process', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ barcode: barcode })
    })
    .then(response => response.json())
    .then(data => {
        console.log('âœ… ë°”ì½”ë“œ ì²˜ë¦¬ ê²°ê³¼:', data);
        
        if (data.success) {
            // ì„±ê³µ ì‹œ í™”ë©´ ì „í™˜
            if (data.action === 'rental') {
                navigateTo('member-check', { member_id: data.member_id, action: 'rental' });
            } else if (data.action === 'return') {
                navigateTo('member-check', { member_id: data.member_id, action: 'return' });
            }
        } else {
            // ì—ëŸ¬ ì‹œ ì—ëŸ¬ í™”ë©´
            navigateTo('error', { 
                type: data.error_type || 'unknown',
                message: data.error || 'ë°”ì½”ë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
            });
        }
    })
    .catch(error => {
        console.error('âŒ ë°”ì½”ë“œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        navigateTo('error', { 
            type: 'system_error',
            message: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'
        });
    });
}

// í™”ë©´ ì „í™˜
function navigateTo(page, params) {
    const queryString = new URLSearchParams(params).toString();
    const url = `/${page}${queryString ? '?' + queryString : ''}`;
    console.log('ğŸ”„ ì´ë™:', url);
    window.location.href = url;
}

// ìˆ¨ê²¨ì§„ ê´€ë¦¬ì ëª¨ë“œ íŠ¸ë¦¬ê±°
function setupAdminTrigger() {
    const trigger = document.getElementById('adminTrigger');
    let pressTimer = null;
    
    trigger.addEventListener('mousedown', function() {
        pressTimer = setTimeout(function() {
            openAdminMode();
        }, 3000); // 3ì´ˆ ëˆ„ë¥´ê¸°
    });
    
    trigger.addEventListener('mouseup', function() {
        clearTimeout(pressTimer);
    });
    
    trigger.addEventListener('touchstart', function() {
        pressTimer = setTimeout(function() {
            openAdminMode();
        }, 3000);
    });
    
    trigger.addEventListener('touchend', function() {
        clearTimeout(pressTimer);
    });
}

function openAdminMode() {
    const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:');
    if (password === '1234') {
        window.location.href = '/admin';
    }
}

// ESC í‚¤ ë°©ì§€
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        e.preventDefault();
    }
});
</script>
{% endblock %}

