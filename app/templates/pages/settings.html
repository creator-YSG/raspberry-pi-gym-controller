{% extends "layouts/base.html" %}

{% block title %}ì„¤ì •{% endblock %}

{% block body_class %}settings-page{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- ì¢Œì¸¡ ìƒë‹¨: ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
    <div class="back-button-container">
        <button class="back-button" onclick="window.location.href='/'">
            â† í™ˆìœ¼ë¡œ
        </button>
    </div>

    <!-- í˜ì´ì§€ ì œëª© -->
    <div class="settings-header">
        <h1>âš™ï¸ ì„¤ì •</h1>
    </div>

    <!-- ë©”ë‰´ ê·¸ë¦¬ë“œ -->
    <div class="settings-menu-grid">
        <!-- 1. ì–¼êµ´ì¸ì‹ ë“±ë¡ -->
        <button class="menu-item" onclick="window.location.href='/settings/face-register'">
            <span class="menu-icon">ğŸ‘¤</span>
            <span class="menu-label">ì–¼êµ´ì¸ì‹ ë“±ë¡</span>
        </button>

        <!-- 2. ì„¼ì„œ ë§¤í•‘ ì ê²€ -->
        <button class="menu-item" onclick="window.location.href='/settings/sensor-mapping'">
            <span class="menu-icon">ğŸ“¡</span>
            <span class="menu-label">ì„¼ì„œ ë§¤í•‘ ì ê²€</span>
        </button>

        <!-- 3. NFC íƒœê·¸ ë“±ë¡ -->
        <button class="menu-item" onclick="window.location.href='/settings/nfc-register'">
            <span class="menu-icon">ğŸ”–</span>
            <span class="menu-label">NFC íƒœê·¸ ë“±ë¡</span>
        </button>

        <!-- 4. êµ¬ê¸€ì‹œíŠ¸ ì¦‰ì‹œ ë™ê¸°í™” -->
        <button class="menu-item" onclick="window.location.href='/settings/sheets-sync'">
            <span class="menu-icon">ğŸ“Š</span>
            <span class="menu-label">êµ¬ê¸€ì‹œíŠ¸ ë™ê¸°í™”</span>
        </button>

        <!-- 5. ì‹œìŠ¤í…œ ìƒíƒœ ëª¨ë‹ˆí„°ë§ -->
        <button class="menu-item" onclick="showSystemStatus()">
            <span class="menu-icon">ğŸ’»</span>
            <span class="menu-label">ì‹œìŠ¤í…œ ìƒíƒœ</span>
        </button>

        <!-- 6. ESP32 ì¬ì—°ê²° -->
        <button class="menu-item" onclick="reconnectESP32()">
            <span class="menu-icon">ğŸ”Œ</span>
            <span class="menu-label">ESP32 ì¬ì—°ê²°</span>
        </button>

        <!-- 7. ë™ê¸°í™” ìƒíƒœ ì¡°íšŒ -->
        <button class="menu-item" onclick="showSyncStatus()">
            <span class="menu-icon">ğŸ”„</span>
            <span class="menu-label">ë™ê¸°í™” ìƒíƒœ</span>
        </button>

        <!-- 8. í”„ë¡œê·¸ë¨ ì¢…ë£Œ -->
        <button class="menu-item menu-item-danger" onclick="confirmShutdown()">
            <span class="menu-icon">ğŸšª</span>
            <span class="menu-label">í”„ë¡œê·¸ë¨ ì¢…ë£Œ</span>
        </button>
    </div>

    <!-- ëª¨ë‹¬ íŒì—… (ìƒíƒœ í‘œì‹œìš©) -->
    <div class="modal-overlay" id="modalOverlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">ìƒíƒœ</div>
            <div class="modal-body" id="modalBody">ë¡œë”© ì¤‘...</div>
            <button class="modal-close-btn" onclick="closeModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<style>
.settings-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
.back-button-container {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
}

.back-button {
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 18px;
    color: white;
    transition: all 0.3s ease;
}

.back-button:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.05);
}

.back-button:active {
    transform: scale(0.95);
}

/* í˜ì´ì§€ í—¤ë” */
.settings-header {
    margin-top: 60px;
    margin-bottom: 40px;
    text-align: center;
}

.settings-header h1 {
    color: white;
    font-size: 36px;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

/* ë©”ë‰´ ê·¸ë¦¬ë“œ */
.settings-menu-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    max-width: 500px;
    width: 100%;
    padding: 0 10px;
}

.menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 30px 20px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.menu-item:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.menu-item:active {
    transform: translateY(0);
}

.menu-item-danger {
    background: rgba(220, 53, 69, 0.3);
    border-color: rgba(220, 53, 69, 0.5);
}

.menu-item-danger:hover {
    background: rgba(220, 53, 69, 0.5);
}

.menu-icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.menu-label {
    color: white;
    font-size: 16px;
    font-weight: 600;
    text-align: center;
}

/* ëª¨ë‹¬ íŒì—… */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}

.modal-content {
    background: #1a1a2e;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 30px;
    max-width: 90%;
    width: 400px;
    max-height: 80%;
    overflow-y: auto;
}

.modal-header {
    color: white;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
}

.modal-body {
    color: rgba(255, 255, 255, 0.9);
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 20px;
    white-space: pre-wrap;
}

.modal-close-btn {
    width: 100%;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 10px;
    padding: 15px;
    color: white;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}
</style>
{% endblock %}

{% block scripts %}
<script>
// ëª¨ë‹¬ í‘œì‹œ
function showModal(title, content) {
    document.getElementById('modalHeader').textContent = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('modalOverlay').style.display = 'flex';
}

// ëª¨ë‹¬ ë‹«ê¸°
function closeModal() {
    document.getElementById('modalOverlay').style.display = 'none';
}

// ì‹œìŠ¤í…œ ìƒíƒœ ì¡°íšŒ
function showSystemStatus() {
    showModal('ğŸ’» ì‹œìŠ¤í…œ ìƒíƒœ', 'ë¡œë”© ì¤‘...');
    
    fetch('/api/system/status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.status) {
                const sys = data.status.system || {};
                const content = `
<b>CPU ì‚¬ìš©ë¥ :</b> ${sys.cpu_percent || 'N/A'}%
<b>ë©”ëª¨ë¦¬ ì‚¬ìš©:</b> ${sys.memory_used_gb || 'N/A'}GB / ${sys.memory_total_gb || 'N/A'}GB (${sys.memory_percent || 'N/A'}%)
<b>ë””ìŠ¤í¬ ì‚¬ìš©:</b> ${sys.disk_used_gb || 'N/A'}GB / ${sys.disk_total_gb || 'N/A'}GB (${sys.disk_percent || 'N/A'}%)
<b>ê°€ë™ ì‹œê°„:</b> ${sys.uptime || 'N/A'}
                `;
                showModal('ğŸ’» ì‹œìŠ¤í…œ ìƒíƒœ', content);
            } else {
                showModal('ğŸ’» ì‹œìŠ¤í…œ ìƒíƒœ', 'ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        })
        .catch(error => {
            showModal('ğŸ’» ì‹œìŠ¤í…œ ìƒíƒœ', 'ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
        });
}

// ESP32 ì¬ì—°ê²°
function reconnectESP32() {
    showModal('ğŸ”Œ ESP32 ì¬ì—°ê²°', 'ì¬ì—°ê²° ì‹œë„ ì¤‘...');
    
    fetch('/api/system/esp32/reconnect', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModal('ğŸ”Œ ESP32 ì¬ì—°ê²°', 'âœ… ' + data.message);
            } else {
                showModal('ğŸ”Œ ESP32 ì¬ì—°ê²°', 'âŒ ì¬ì—°ê²° ì‹¤íŒ¨: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            showModal('ğŸ”Œ ESP32 ì¬ì—°ê²°', 'ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
        });
}

// ë™ê¸°í™” ìƒíƒœ ì¡°íšŒ
function showSyncStatus() {
    showModal('ğŸ”„ ë™ê¸°í™” ìƒíƒœ', 'ë¡œë”© ì¤‘...');
    
    fetch('/api/sync/status')
        .then(response => response.json())
        .then(data => {
            let content = '';
            if (data.success) {
                const stats = data.stats || {};
                content = `
<b>ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ:</b> ${data.running ? 'âœ… ì‹¤í–‰ ì¤‘' : 'âŒ ì¤‘ì§€ë¨'}
<b>ì´ ë™ê¸°í™” íšŸìˆ˜:</b> ${stats.total_syncs || 0}íšŒ
<b>ì„±ê³µ:</b> ${stats.successful_syncs || 0}íšŒ
<b>ì‹¤íŒ¨:</b> ${stats.failed_syncs || 0}íšŒ
<b>ë§ˆì§€ë§‰ ë™ê¸°í™”:</b> ${stats.last_sync_time || 'N/A'}
                `;
            } else {
                content = 'âŒ ìŠ¤ì¼€ì¤„ëŸ¬ ë¯¸ì‹¤í–‰\n' + (data.error || '');
            }
            showModal('ğŸ”„ ë™ê¸°í™” ìƒíƒœ', content);
        })
        .catch(error => {
            showModal('ğŸ”„ ë™ê¸°í™” ìƒíƒœ', 'ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
        });
}

// í”„ë¡œê·¸ë¨ ì¢…ë£Œ í™•ì¸
function confirmShutdown() {
    if (confirm('ì •ë§ë¡œ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nFlask ì•±ê³¼ ë¸Œë¼ìš°ì €ê°€ ëª¨ë‘ ì¢…ë£Œë©ë‹ˆë‹¤.')) {
        showModal('ğŸšª í”„ë¡œê·¸ë¨ ì¢…ë£Œ', 'ì¢…ë£Œ ì¤‘...');
        
        fetch('/api/system/shutdown', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showModal('ğŸšª í”„ë¡œê·¸ë¨ ì¢…ë£Œ', 'âœ… ' + data.message + '\n\nì ì‹œ í›„ ë¸Œë¼ìš°ì €ë¥¼ ë‹«ìŠµë‹ˆë‹¤.');
                    // ë¸Œë¼ìš°ì € ë‹«ê¸° ì‹œë„
                    setTimeout(() => {
                        window.close();
                        // window.close()ê°€ ì•ˆ ë  ê²½ìš° ë¹ˆ í˜ì´ì§€ë¡œ ì´ë™
                        window.location.href = 'about:blank';
                    }, 2000);
                } else {
                    showModal('ğŸšª í”„ë¡œê·¸ë¨ ì¢…ë£Œ', 'âŒ ì¢…ë£Œ ì‹¤íŒ¨: ' + (data.error || data.message));
                }
            })
            .catch(error => {
                showModal('ğŸšª í”„ë¡œê·¸ë¨ ì¢…ë£Œ', 'ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            });
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('modalOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}

