# 다중 헬스장 SaaS 아키텍처

## 개요

여러 헬스장에 락카키 대여기, 운동복 대여기 등의 시스템을 구축하고,
각 헬스장 관리자가 자기 헬스장 데이터만 접근할 수 있도록 하는 아키텍처입니다.

---

## 전체 시스템 구조

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        관리자 웹 대시보드                                  │
│                    (admin.yourservice.com)                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   로그인: 헬스장A 관리자              로그인: 헬스장B 관리자                │
│   ┌─────────────────────────┐      ┌─────────────────────────┐          │
│   │ 📊 회원 관리             │      │ 📊 회원 관리             │          │
│   │ 📈 대여 통계             │      │ 📈 대여 통계             │          │
│   │ 🔧 락카 현황             │      │ 🔧 락카 현황             │          │
│   │ ⚙️ 시스템 설정           │      │ ⚙️ 시스템 설정           │          │
│   └─────────────────────────┘      └─────────────────────────┘          │
│              ↓                              ↓                           │
│       헬스장A 데이터만                  헬스장B 데이터만                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │   Google Sheets API  │
              │   (서비스 계정)       │
              └─────────────────────┘
                    │         │
          ┌─────────┘         └─────────┐
          ▼                             ▼
┌─────────────────────┐     ┌─────────────────────┐
│  📁 헬스장A 폴더     │     │  📁 헬스장B 폴더     │
│  (Google Drive)     │     │  (Google Drive)     │
├─────────────────────┤     ├─────────────────────┤
│ 📊 운동복대여기-DB   │     │ 📊 운동복대여기-DB   │
│ 📊 락카키대여기-DB   │     │ 📊 락카키대여기-DB   │
│ 📊 회원관리-마스터   │     │ 📊 회원관리-마스터   │
└─────────────────────┘     └─────────────────────┘
          │                             │
          ▼                             ▼
┌─────────────────────┐     ┌─────────────────────┐
│ 🍓 라즈베리파이      │     │ 🍓 라즈베리파이      │
│ (현장 키오스크)      │     │ (현장 키오스크)      │
│                     │     │                     │
│ - 락카키 대여기      │     │ - 락카키 대여기      │
│ - 운동복 대여기      │     │ - 운동복 대여기      │
└─────────────────────┘     └─────────────────────┘
```

---

## Google Drive 폴더 구조

### 헬스장별 폴더 분리

```
📁 체육시설관리시스템 (루트 폴더)
│
├── 📁 헬스장A
│   ├── 📊 운동복대여기-DB (스프레드시트)
│   │   ├── 회원명단 (탭)
│   │   ├── 대여기록 (탭)
│   │   ├── 상품정보 (탭)
│   │   ├── 기기현황 (탭)
│   │   └── 시스템설정 (탭)
│   │
│   ├── 📊 락카키대여기-DB (스프레드시트)
│   │   ├── 회원명단 (탭)
│   │   ├── 대여기록 (탭)
│   │   ├── 락카현황 (탭)
│   │   ├── 센서이벤트 (탭)
│   │   └── 시스템설정 (탭)
│   │
│   └── 📊 회원관리-마스터 (스프레드시트) [선택사항]
│       ├── 전체회원명단 (탭)
│       └── 결제내역 (탭)
│
├── 📁 헬스장B
│   ├── 📊 운동복대여기-DB
│   ├── 📊 락카키대여기-DB
│   └── 📊 회원관리-마스터
│
└── 📁 헬스장C
    └── ...
```

### 스프레드시트 구성 이유

| 구분 | 설명 |
|------|------|
| **폴더 = 헬스장** | 권한 관리의 단위 |
| **스프레드시트 = 시스템** | 락카키, 운동복 등 프로젝트별 분리 |
| **탭 = 테이블** | 회원, 대여기록 등 데이터 테이블 |

---

## 권한 관리

### Google Drive 권한 상속

```
📁 헬스장A (폴더)
│
│  권한 설정:
│  ├── 개발자 (소유자)
│  ├── 헬스장A 관리자 (편집자)
│  └── 서비스계정 (편집자)
│
├── 📊 운동복대여기-DB  ✅ 권한 자동 상속
├── 📊 락카키대여기-DB  ✅ 권한 자동 상속
└── 📊 회원관리-마스터  ✅ 권한 자동 상속
```

### 권한 설정 방법

1. **Google Drive에서 폴더 생성**
2. **폴더 우클릭 → 공유**
3. **아래 계정 추가:**

| 계정 | 권한 | 역할 |
|------|------|------|
| `developer@gmail.com` | 소유자 | 개발자 (전체 관리) |
| `manager_a@gmail.com` | 편집자 | 헬스장A 관리자 |
| `서비스계정@...iam.gserviceaccount.com` | 편집자 | API 접근 (라즈베리파이) |

### 결과

| 사용자 | 접근 가능 범위 |
|--------|---------------|
| 개발자 | 모든 헬스장 폴더 |
| 헬스장A 관리자 | 헬스장A 폴더만 |
| 헬스장B 관리자 | 헬스장B 폴더만 |
| 서비스계정 | 권한 부여된 폴더만 |

---

## 관리자 웹 대시보드

### 기능

| 기능 | 설명 |
|------|------|
| **회원 관리** | 회원 조회/추가/수정/삭제 |
| **대여 통계** | 일별/월별 대여 현황, 그래프 |
| **락카 현황** | 실시간 락카 상태 모니터링 |
| **시스템 설정** | 타임아웃, 최대 대여 횟수 등 설정 |
| **알림** | 이상 감지, 유지보수 필요 알림 |

### 기술 스택 (예시)

```
프론트엔드: Next.js / React
백엔드 API: Next.js API Routes / Flask
인증: NextAuth.js / Firebase Auth
데이터: Google Sheets API
```

### 관리자별 데이터 분리

```javascript
// 관리자-헬스장 매핑 설정
const gymConfig = {
  "admin_a@gmail.com": {
    gym_name: "헬스장A",
    spreadsheets: {
      locker: "SPREADSHEET_ID_A1",
      clothes: "SPREADSHEET_ID_A2"
    }
  },
  "admin_b@gmail.com": {
    gym_name: "헬스장B",
    spreadsheets: {
      locker: "SPREADSHEET_ID_B1",
      clothes: "SPREADSHEET_ID_B2"
    }
  }
};

// 로그인 후 해당 관리자의 시트만 접근
function getAdminSheets(userEmail) {
  return gymConfig[userEmail]?.spreadsheets;
}
```

---

## 현장 시스템 (라즈베리파이)

### 설정 파일 구조

각 헬스장 라즈베리파이에 설정:

```json
// config/google_sheets_config.json
{
  "gym_name": "헬스장A",
  "spreadsheet_id": "해당_헬스장_스프레드시트_ID",
  "credentials_file": "google_credentials.json",
  "sheet_names": {
    "members": "회원명단",
    "rentals": "대여기록",
    "lockers": "락카현황",
    "sensor_events": "센서이벤트",
    "settings": "시스템설정"
  }
}
```

### 동기화 흐름

```
┌─────────────────────┐
│  라즈베리파이        │
│  (로컬 SQLite DB)   │
└─────────┬───────────┘
          │
          │ 5분마다 동기화
          │
          ▼
┌─────────────────────┐
│  Google Sheets      │
│  (해당 헬스장 시트)  │
└─────────┬───────────┘
          │
          │ 실시간 반영
          │
          ▼
┌─────────────────────┐
│  관리자 대시보드     │
│  (웹 UI)            │
└─────────────────────┘
```

---

## 서비스 계정 관리

### 옵션 1: 헬스장별 서비스 계정 (권장)

```
헬스장A → gymA-service@project.iam.gserviceaccount.com
헬스장B → gymB-service@project.iam.gserviceaccount.com
```

**장점:** 완전한 분리, 보안 강화
**단점:** 관리할 계정 수 증가

### 옵션 2: 통합 서비스 계정

```
모든 헬스장 → unified-service@project.iam.gserviceaccount.com
```

**장점:** 관리 단순
**단점:** 한 계정이 모든 데이터 접근 가능

### 권장 사항

- **소규모 (1~3개):** 통합 서비스 계정
- **대규모 (4개 이상):** 헬스장별 서비스 계정

---

## 새 헬스장 추가 체크리스트

### 1. Google Drive 설정

- [ ] 헬스장 폴더 생성
- [ ] 스프레드시트 생성 (운동복, 락카키 등)
- [ ] 각 시트에 탭(테이블) 생성
- [ ] 관리자 계정에 폴더 편집 권한 부여
- [ ] 서비스 계정에 폴더 편집 권한 부여

### 2. 라즈베리파이 설정

- [ ] 소스코드 배포
- [ ] `google_sheets_config.json` 설정
- [ ] 서비스 계정 인증 파일 배포
- [ ] 네트워크 설정
- [ ] 자동 시작 설정

### 3. 관리자 대시보드 설정

- [ ] 관리자 계정 생성
- [ ] 헬스장-스프레드시트 매핑 추가
- [ ] 접근 권한 테스트

### 4. 테스트

- [ ] 회원 등록/조회 테스트
- [ ] 대여/반납 테스트
- [ ] 동기화 확인
- [ ] 대시보드 데이터 확인

---

## API 호출 제한 고려사항

### Google Sheets API 제한

| 구분 | 제한 |
|------|------|
| 무료 | 분당 60회 읽기/쓰기 (시트당) |
| 유료 | 분당 500회 |

### 분산 효과

```
헬스장A 스프레드시트: 분당 60회
헬스장B 스프레드시트: 분당 60회
헬스장C 스프레드시트: 분당 60회
───────────────────────────────
총 가용량: 분당 180회
```

**스프레드시트를 분리하면 API 제한도 분산됩니다!**

---

## 향후 확장

### Phase 1: 현재
- 각 헬스장 독립 운영
- Google Sheets 기반 데이터 관리

### Phase 2: 대시보드
- 관리자용 웹 대시보드 개발
- 통계/리포트 기능

### Phase 3: 확장
- 모바일 앱 (회원용)
- 결제 연동
- 통합 관리 시스템

---

## 참고 문서

- [Google Sheets 스키마](./GOOGLE_SHEETS_SCHEMA.md)
- [라즈베리파이 설정 가이드](./RASPBERRY_PI_SETUP.md)
- [API 명세](./API_SPECIFICATION.md)

