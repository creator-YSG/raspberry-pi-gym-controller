# 🏋️ 헬스장 락커 시스템 완전 가이드

> **현재 상태**: 실제 운영 100% 준비 완료 (345명 회원 데이터 통합)  
> **최종 업데이트**: 2025-10-13

## 📋 시스템 개요

라즈베리파이 기반 헬스장 락커 자동 대여/반납 시스템으로, **구역별 접근 제어**와 **트랜잭션 기반 안전성**을 제공합니다.

### 🎯 핵심 특징
- **🔐 구역별 접근 제어**: 교직원/일반회원, 성별에 따른 락커 접근 권한
- **🛡️ 트랜잭션 기반 안전성**: 동시성 제어 및 데이터 무결성 보장
- **⚡ 실시간 센서 연동**: 3개 ESP32를 통한 물리적 상태 동기화
- **👥 실제 회원 데이터**: 345명 실제 헬스장 회원 데이터 통합 운영
- **🔄 스마트 반납 시스템**: 회원 바코드 스캔으로 대여/반납 모드 자동 판별

## 🏛️ 시스템 구성

### 🔧 하드웨어
- **중앙 제어**: 라즈베리파이 4B + SQLite 데이터베이스
- **하드웨어**: 3개 ESP32 컨트롤러 (zone별 독립 제어)
  - ESP32 #1: 남성 락커 70개 (M01~M70)
  - ESP32 #2: 여성 락커 50개 (F01~F50)
  - ESP32 #3: 교직원 락커 20개 (S01~S20)
- **인터페이스**: Flask 웹 기반 터치스크린 키오스크 (1024x600)

### 🔐 락커 접근 권한 시스템

#### **교직원 (대학교수, 대학직원)**
- **남자 교직원**: 남자구역 + 교직원구역 접근 가능
- **여자 교직원**: 여자구역 + 교직원구역 접근 가능

#### **일반회원 (학부, 석사, 박사, 기타)**
- **남자 일반회원**: 남자구역만 접근 가능
- **여자 일반회원**: 여자구역만 접근 가능

## 🚀 시스템 운영

### 📱 키오스크 시스템
```bash
# 키오스크 시작
./scripts/deployment/start_kiosk.sh

# 키오스크 종료
./scripts/deployment/stop_kiosk.sh

# 키오스크 재시작
./scripts/deployment/restart_kiosk.sh
```

### 💾 데이터 관리
```bash
# 회원 데이터 가져오기
python3 scripts/data/import_members_csv.py

# 회원 권한 업데이트
python3 scripts/data/update_member_permissions.py

# 데이터 정합성 수정
python3 scripts/data/fix_data_inconsistency.py
```

### 🧪 시스템 테스트
```bash
# 서비스 플로우 테스트
python3 scripts/testing/test_service_flow.py

# 락커 권한 테스트
python3 scripts/testing/test_locker_permissions.py

# 구역 접근 테스트
python3 scripts/testing/test_zone_access.py
```

## 🔄 서비스 플로우

### 📱 바코드 스캔 → 락커 열기 전체 과정

1. **바코드 스캔**: 회원번호 입력
2. **회원 검증**: 데이터베이스에서 등록된 회원인지 확인
3. **유효성 검사**: 만료일자 체크
4. **대여/반납 판단**: 현재 대여 상태 확인
5. **회원 구분별 접근 구역 확인**: 성별 + 직급에 따른 권한
6. **선택 락커 구역 권한 체크**: 해당 구역 접근 가능한지 확인
7. **락커 열기 또는 접근 거부**

### 🎯 권한 제어 예시

```python
# 김현 교수 (남자 교직원) - 바코드: 20156111
✅ M01~M70 (남자구역) 접근 가능
❌ F01~F50 (여자구역) 접근 차단
✅ S01~S20 (교직원구역) 접근 가능

# 손준표 학생 (남자 일반회원) - 바코드: 20240838  
✅ M01~M70 (남자구역) 접근 가능
❌ F01~F50 (여자구역) 접근 차단
❌ S01~S20 (교직원구역) 접근 차단
```

## 🗄️ 데이터베이스 구조

### 📊 주요 테이블
- **members**: 회원 정보 (345명, 성별/구분/만료일 포함)
- **locker_status**: 140개 락커 상태 관리
- **rental_history**: 대여 기록 추적
- **active_transactions**: 실시간 트랜잭션 관리
- **sensor_events**: 센서 이벤트 로그

### 🔄 Google Sheets 동기화
- 기존 관리 시스템과의 호환성 유지
- 오프라인 운영 지원 (로컬 SQLite 우선)
- 주기적 양방향 동기화

## 🛠️ 개발 및 유지보수

### ⚙️ 시스템 설정
```bash
# 데이터베이스 초기화
python3 scripts/setup/init_database.py

# Google Sheets 설정
python3 scripts/setup/setup_google_sheets.py

# 락커 설정
python3 scripts/setup/setup_lockers.py
```

### 🔧 유지보수
```bash
# 라즈베리파이 연결
./scripts/maintenance/connect_pi.sh

# 코드 동기화
./scripts/maintenance/sync_code.sh

# 데이터베이스 통합
python3 scripts/maintenance/unify_database.py
```

## 📚 추가 문서

- **아키텍처**: `docs/architecture/` - 시스템 설계 문서
- **개발 가이드**: `docs/development/` - 개발 시작 가이드
- **배포 가이드**: `docs/deployment/` - ESP32 통합 가이드
- **기능 문서**: `docs/features/` - 락커 권한 시스템 상세
- **유지보수**: `docs/maintenance/` - 문제 해결 가이드

## 🎉 운영 현황

### ✅ 완료된 기능 (100% 운영 준비)
- **345명 실제 회원 데이터**: CSV 기반 일괄 등록 및 검증 완료
- **스마트 반납 메커니즘**: 회원 바코드 스캔으로 대여/반납 모드 자동 판별
- **구역별 접근 제어**: 교직원/일반회원, 성별에 따른 락커 권한 완벽 구현
- **데이터 정합성 보장**: 회원-대여 테이블 완벽 동기화
- **바코드 서비스 완성**: 회원/락커 바코드 구분 및 자동 처리
- **실전 테스트 완료**: 모든 시나리오 100% 통과

### 🏆 시스템 성과
- **140개 락커**: 남성 70개, 여성 50개, 교직원 20개
- **3개 ESP32**: zone별 독립 제어
- **트랜잭션 기반**: 동시성 제어 및 안전성 보장
- **실시간 센서**: 물리적 상태와 DB 동기화
- **터치 최적화**: 600x1024 세로 모드 키오스크

**🎯 실제 헬스장 운영을 위한 모든 준비가 완료된 완벽한 시스템입니다!**
